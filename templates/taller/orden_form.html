{% extends 'base.html' %}

{% block title %}{% if object %}Editar Orden{% else %}Nueva Orden{% endif %} - VPMOTOS{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary: #2196f3;
        --primary-dark: #1565c0;
        --success: #4caf50;
        --danger: #f44336;
        --warning: #ff9800;
        --surface: #ffffff;
        --background: #f5f7fa;
        --text: #2c3e50;
        --text-light: #7f8c8d;
        --border: #e0e0e0;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background: var(--background);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: var(--text);
        line-height: 1.6;
    }

    .wizard-container {
        max-width: 1400px;
        margin: 20px auto;
        padding: 0 20px;
    }

    /* HEADER */
    .wizard-header {
        background: var(--surface);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }

    .wizard-header h1 {
        font-size: 28px;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 8px;
    }

    .wizard-header p {
        color: var(--text-light);
        font-size: 16px;
    }

    /* PROGRESS BAR */
    .wizard-progress {
        background: var(--surface);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }

    .progress-steps {
        display: flex;
        justify-content: space-between;
        position: relative;
    }

    .progress-steps::before {
        content: '';
        position: absolute;
        top: 25px;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--border);
        z-index: 1;
    }

    .progress-line {
        position: absolute;
        top: 25px;
        left: 0;
        height: 3px;
        background: var(--primary);
        transition: width 0.3s ease;
        z-index: 2;
    }

    .step {
        flex: 1;
        text-align: center;
        position: relative;
        z-index: 3;
    }

    .step-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: var(--surface);
        border: 3px solid var(--border);
        margin: 0 auto 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 18px;
        color: var(--text-light);
        transition: all 0.3s ease;
    }

    .step.active .step-circle {
        border-color: var(--primary);
        background: var(--primary);
        color: white;
        transform: scale(1.1);
    }

    .step.completed .step-circle {
        border-color: var(--success);
        background: var(--success);
        color: white;
    }

    .step-label {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-light);
    }

    .step.active .step-label {
        color: var(--primary);
        font-weight: 600;
    }

    .step.completed .step-label {
        color: var(--success);
    }

    /* WIZARD CONTENT */
    .wizard-content {
        background: var(--surface);
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .wizard-body {
        padding: 40px;
        min-height: 500px;
    }

    .wizard-step {
        display: none;
    }

    .wizard-step.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .step-title {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text);
    }

    .step-subtitle {
        color: var(--text-light);
        margin-bottom: 30px;
        font-size: 16px;
    }

    /* FORMS */
    .form-row {
        display: grid;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-row.cols-2 { grid-template-columns: repeat(2, 1fr); }
    .form-row.cols-3 { grid-template-columns: repeat(3, 1fr); }
    .form-row.cols-4 { grid-template-columns: repeat(4, 1fr); }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-weight: 500;
        margin-bottom: 8px;
        color: var(--text);
        font-size: 14px;
    }

    .form-control, .form-select {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--border);
        border-radius: 8px;
        font-size: 15px;
        transition: all 0.3s ease;
        background: white;
    }

    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }

    textarea.form-control {
        min-height: 100px;
        resize: vertical;
    }

    /* SEARCH */
    .search-box {
        position: relative;
        margin-bottom: 20px;
    }

    .search-input {
        width: 100%;
        padding: 14px 16px 14px 48px;
        border: 2px solid var(--border);
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s ease;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    }

    .search-icon {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-light);
        font-size: 18px;
    }

    .search-loading {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        width: 20px;
        height: 20px;
        border: 3px solid var(--border);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        display: none;
    }

    .search-box.loading .search-loading {
        display: block;
    }

    @keyframes spin {
        to { transform: translateY(-50%) rotate(360deg); }
    }

    /* SEARCH RESULTS */
    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid var(--border);
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: none;
    }

    .search-results.show {
        display: block;
    }

    .search-result-item {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid var(--border);
        transition: background 0.2s;
    }

    .search-result-item:hover {
        background: #f8f9fa;
    }

    .search-result-item:last-child {
        border-bottom: none;
    }

    .result-title {
        font-weight: 600;
        color: var(--text);
        margin-bottom: 4px;
        font-size: 14px;
    }

    .result-details {
        font-size: 12px;
        color: var(--text-light);
    }

    /* INFO CARD */
    .info-card {
        background: #f8f9fa;
        border: 2px solid var(--border);
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        display: none;
    }

    .info-card.show {
        display: block;
        animation: fadeIn 0.3s ease;
    }

    .info-card h6 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 12px;
    }

    .info-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        font-size: 14px;
    }

    .info-item i {
        width: 24px;
        color: var(--primary);
        margin-right: 8px;
    }

    /* PRIORITY CHIPS */
    .priority-chips {
        display: flex;
        gap: 12px;
        margin-top: 8px;
    }

    .priority-chip {
        flex: 1;
        padding: 12px;
        border: 2px solid var(--border);
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        background: white;
    }

    .priority-chip:hover {
        border-color: var(--primary);
        background: rgba(33, 150, 243, 0.05);
    }

    .priority-chip.selected {
        border-color: var(--primary);
        background: var(--primary);
        color: white;
    }

    /* ITEMS DISPLAY */
    .items-display {
        border: 2px solid var(--border);
        border-radius: 8px;
        margin-bottom: 20px;
        overflow: hidden;
    }

    .items-header {
        background: #f8f9fa;
        padding: 1rem 1.5rem;
        font-weight: 500;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .badge {
        background: var(--primary);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .items-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .item-row {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--border);
        display: grid;
        grid-template-columns: 1fr auto auto auto;
        gap: 0.75rem;
        align-items: center;
    }

    .item-row:last-child {
        border-bottom: none;
    }

    .item-row:hover {
        background: #f8f9fa;
    }

    .item-row.deleted {
        opacity: 0.5;
        background: #ffebee;
    }

    .item-info .item-name {
        font-weight: 500;
        margin-bottom: 0.25rem;
        font-size: 0.875rem;
    }

    .item-info .item-code {
        font-size: 0.75rem;
        color: var(--text-light);
        font-family: 'Courier New', monospace;
    }

    .item-info .item-price {
        font-size: 0.8rem;
        color: var(--success);
        margin-top: 0.25rem;
    }

    .item-info .item-technician {
        font-size: 0.75rem;
        color: var(--primary);
        background: #e3f2fd;
        padding: 0.125rem 0.375rem;
        border-radius: 10px;
        margin-top: 0.25rem;
        display: inline-block;
    }

    .quantity-controls {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: #f8f9fa;
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 0.25rem;
    }

    .qty-btn {
        width: 24px;
        height: 24px;
        border: none;
        border-radius: 4px;
        background: var(--primary);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        transition: background 0.3s ease;
    }

    .qty-btn:hover {
        background: var(--primary-dark);
    }

    .qty-display {
        min-width: 24px;
        text-align: center;
        font-weight: 500;
        font-size: 0.875rem;
        color: var(--text);
    }

    .item-total {
        font-weight: 600;
        color: var(--success);
        font-size: 0.875rem;
        text-align: right;
    }

    .remove-btn {
        width: 24px;
        height: 24px;
        border: none;
        border-radius: 50%;
        background: var(--danger);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        transition: background 0.3s ease;
    }

    .remove-btn:hover {
        background: #c82333;
    }

    .empty-state {
        text-align: center;
        padding: 2rem 1rem;
        color: var(--text-light);
    }

    .empty-state i {
        font-size: 2.5rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .btn-add-item {
        width: 100%;
        padding: 16px;
        border: 2px dashed var(--border);
        border-radius: 8px;
        background: white;
        color: var(--primary);
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .btn-add-item:hover {
        border-color: var(--primary);
        background: rgba(33, 150, 243, 0.05);
    }

    /* SUMMARY CARD */
    .summary-card {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 20px;
    }

    .summary-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid rgba(255,255,255,0.2);
        font-size: 16px;
    }

    .summary-row:last-child {
        border-bottom: none;
        margin-top: 12px;
        padding-top: 20px;
        border-top: 2px solid rgba(255,255,255,0.3);
        font-size: 22px;
        font-weight: 600;
    }

    .saldo-box {
        margin-top: 20px;
        padding: 16px;
        background: rgba(0,0,0,0.2);
        border-radius: 8px;
    }

    .saldo-label {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 4px;
    }

    .saldo-value {
        font-size: 26px;
        font-weight: 600;
    }

    /* WIZARD FOOTER */
    .wizard-footer {
        padding: 24px 40px;
        background: #f8f9fa;
        border-top: 2px solid var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    /* BUTTONS */
    .btn {
        padding: 12px 28px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
        box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        transform: translateY(-2px);
    }

    .btn-secondary {
        background: white;
        color: var(--text);
        border: 2px solid var(--border);
    }

    .btn-secondary:hover {
        border-color: var(--text-light);
        background: #f8f9fa;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
    }

    /* ALERTS */
    .alert {
        padding: 16px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .alert-danger {
        background: #ffebee;
        color: #c62828;
        border: 2px solid #ef5350;
    }

    /* MODALES */
    .modal-content {
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .modal-header {
        background: var(--primary);
        color: white;
        border-bottom: none;
        border-radius: 8px 8px 0 0;
    }

    .modal-title {
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .modal-search {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border);
        border-radius: 6px;
        margin-bottom: 1rem;
        font-size: 0.875rem;
    }

    .modal-item {
        background: white;
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .modal-item:hover {
        border-color: var(--primary);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .item-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
    }

    .item-title {
        font-weight: 500;
        margin: 0;
        font-size: 0.875rem;
    }

    .item-price {
        font-weight: 600;
        color: var(--success);
        font-size: 0.875rem;
    }

    .item-meta {
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: var(--text-light);
    }

    .d-none {
        display: none !important;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
        .form-row.cols-2,
        .form-row.cols-3,
        .form-row.cols-4 {
            grid-template-columns: 1fr;
        }

        .wizard-body {
            padding: 24px;
        }

        .wizard-footer {
            padding: 20px 24px;
            flex-direction: column;
            gap: 12px;
        }

        .btn {
            width: 100%;
            justify-content: center;
        }

        .progress-steps {
            flex-wrap: wrap;
        }

        .step {
            flex: 0 0 50%;
            margin-bottom: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="wizard-container">
    <!-- Header -->
    <div class="wizard-header">
        <h1>
            <i class="fas fa-wrench"></i>
            {% if object %}Editar Orden #{{ object.numero_orden }}{% else %}Nueva Orden de Trabajo{% endif %}
        </h1>
        <p>Complete cada paso para crear la orden</p>
    </div>

    <!-- Progress Bar -->
    <div class="wizard-progress">
        <div class="progress-steps">
            <div class="progress-line" id="progressLine" style="width: 0%"></div>
            
            <div class="step active" data-step="1">
                <div class="step-circle">1</div>
                <div class="step-label">Cliente</div>
            </div>
            
            <div class="step" data-step="2">
                <div class="step-circle">2</div>
                <div class="step-label">Motocicleta</div>
            </div>
            
            <div class="step" data-step="3">
                <div class="step-circle">3</div>
                <div class="step-label">Servicio</div>
            </div>
            
            <div class="step" data-step="4">
                <div class="step-circle">4</div>
                <div class="step-label">Repuestos</div>
            </div>
            
            <div class="step" data-step="5">
                <div class="step-circle">5</div>
                <div class="step-label">Resumen</div>
            </div>
        </div>
    </div>

    <!-- Form -->
    <form method="post" id="wizardForm">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i>
            <div>
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div class="wizard-content">
            <div class="wizard-body">
                
                <!-- STEP 1: CLIENTE -->
                <div class="wizard-step active" data-step="1">
                    <h2 class="step-title">Informaci√≥n del Cliente</h2>
                    <p class="step-subtitle">Busque y seleccione el cliente para esta orden</p>
                    
                    <div class="search-box" id="clienteSearchBox">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" 
                               class="search-input" 
                               id="clienteSearchInput"
                               placeholder="Buscar por c√©dula o nombre del cliente..."
                               autocomplete="off">
                        <div class="search-loading"></div>
                        <div class="search-results" id="clienteSearchResults"></div>
                    </div>

                    <input type="hidden" name="cliente" id="clienteId">
                    
                    <div class="form-group">
                        <label class="form-label">C√©dula del Cliente *</label>
                        {{ form.cliente_identificacion }}
                    </div>

                    <div class="info-card" id="clienteInfo">
                        <h6 id="clienteNombre"></h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="info-item">
                                    <i class="fas fa-phone"></i>
                                    <span id="clienteTelefono"></span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-envelope"></i>
                                    <span id="clienteEmail"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span id="clienteDireccion"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STEP 2: MOTOCICLETA -->
                <div class="wizard-step" data-step="2">
                    <h2 class="step-title">Datos de la Motocicleta</h2>
                    <p class="step-subtitle">Ingrese la informaci√≥n del veh√≠culo</p>
                    
                    <div class="form-row cols-4">
                        <div class="form-group">
                            <label class="form-label">Placa *</label>
                            {{ form.moto_placa }}
                        </div>
                        <div class="form-group">
                            <label class="form-label">Marca *</label>
                            {{ form.moto_marca }}
                        </div>
                        <div class="form-group">
                            <label class="form-label">Modelo *</label>
                            {{ form.moto_modelo }}
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cilindraje</label>
                            {{ form.moto_cilindraje }}
                        </div>
                    </div>

                    <div class="form-row cols-3">
                        <div class="form-group">
                            <label class="form-label">Color</label>
                            {{ form.moto_color }}
                        </div>
                        <div class="form-group">
                            <label class="form-label">Kilometraje</label>
                            {{ form.kilometraje_entrada }}
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nivel Combustible</label>
                            {{ form.nivel_combustible }}
                        </div>
                    </div>
                </div>

                <!-- STEP 3: SERVICIOS -->
                <div class="wizard-step" data-step="3">
                    <h2 class="step-title">Servicios a Realizar</h2>
                    <p class="step-subtitle">Configure el servicio y los trabajos a realizar</p>
                    
                    <div class="form-row cols-2">
                        <div class="form-group">
                            <label class="form-label">T√©cnico Principal *</label>
                            {{ form.tecnico_principal }}
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha de Entrega</label>
                            {{ form.fecha_prometida }}
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Prioridad</label>
                        <div class="priority-chips">
                            {% for value, label in form.prioridad.field.choices %}
                            <div class="priority-chip" data-value="{{ value }}">
                                <div>{{ label }}</div>
                            </div>
                            {% endfor %}
                        </div>
                        <input type="hidden" name="prioridad" id="prioridadInput">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Motivo de Ingreso *</label>
                        {{ form.motivo_ingreso }}
                    </div>

                    <div class="form-row cols-2">
                        <div class="form-group">
                            <label class="form-label">Diagn√≥stico Inicial</label>
                            {{ form.diagnostico_inicial }}
                        </div>
                        <div class="form-group">
                            <label class="form-label">Observaciones del Cliente</label>
                            {{ form.observaciones_cliente }}
                        </div>
                    </div>

                    <hr style="margin: 30px 0; border: none; border-top: 2px solid var(--border);">

                    <h3 style="font-size: 20px; margin-bottom: 20px;">
                        <i class="fas fa-tools"></i> Lista de Servicios
                    </h3>

                    {{ servicios_formset.management_form }}
                    
                    <div class="items-display">
                        <div class="items-header">
                            <i class="fas fa-tools" style="color: var(--primary);"></i>
                            Servicios en la Orden
                            <span class="badge" id="serviciosCountBadge">0 servicios</span>
                        </div>
                        <div class="items-list" id="serviciosList">
                            <div class="empty-state">
                                <i class="fas fa-tools"></i>
                                <h5>Sin servicios</h5>
                                <p>Haz clic en el bot√≥n de abajo para agregar servicios</p>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn-add-item" onclick="showServicesModal()">
                        <i class="fas fa-plus"></i>
                        Agregar Servicio
                    </button>
                </div>

                <!-- STEP 4: REPUESTOS -->
                <div class="wizard-step" data-step="4">
                    <h2 class="step-title">Repuestos Necesarios</h2>
                    <p class="step-subtitle">Busque y agregue los repuestos necesarios</p>

                    {{ repuestos_formset.management_form }}
                    
                    <div class="items-display">
                        <div class="items-header">
                            <i class="fas fa-boxes" style="color: var(--primary);"></i>
                            Repuestos en la Orden
                            <span class="badge" id="repuestosCountBadge">0 repuestos</span>
                        </div>
                        <div class="items-list" id="repuestosList">
                            <div class="empty-state">
                                <i class="fas fa-boxes"></i>
                                <h5>Sin repuestos</h5>
                                <p>Haz clic en el bot√≥n de abajo para agregar repuestos</p>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn-add-item" onclick="showProductsModal()">
                        <i class="fas fa-plus"></i>
                        Agregar Repuesto
                    </button>
                </div>

                <!-- STEP 5: RESUMEN -->
                <div class="wizard-step" data-step="5">
                    <h2 class="step-title">Resumen de la Orden</h2>
                    <p class="step-subtitle">Revise los datos antes de guardar</p>

                    <div class="row">
                        <div class="col-md-8">
                            <div style="background: #f8f9fa; padding: 24px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="margin-bottom: 16px;"><i class="fas fa-user"></i> Cliente</h4>
                                <p id="resumenCliente" style="margin: 0; font-size: 16px;">-</p>
                            </div>

                            <div style="background: #f8f9fa; padding: 24px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="margin-bottom: 16px;"><i class="fas fa-motorcycle"></i> Motocicleta</h4>
                                <p id="resumenMoto" style="margin: 0; font-size: 16px;">-</p>
                            </div>

                            <div style="background: #f8f9fa; padding: 24px; border-radius: 8px; margin-bottom: 20px;">
                                <h4 style="margin-bottom: 16px;"><i class="fas fa-tools"></i> Servicios</h4>
                                <div id="resumenServicios">-</div>
                            </div>

                            <div style="background: #f8f9fa; padding: 24px; border-radius: 8px;">
                                <h4 style="margin-bottom: 16px;"><i class="fas fa-boxes"></i> Repuestos</h4>
                                <div id="resumenRepuestos">-</div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="summary-card">
                                <div class="summary-title">
                                    <i class="fas fa-calculator"></i> Totales
                                </div>

                                <div class="summary-row">
                                    <span>Servicios:</span>
                                    <span id="totalServicios">$0.00</span>
                                </div>

                                <div class="summary-row">
                                    <span>Repuestos:</span>
                                    <span id="totalRepuestos">$0.00</span>
                                </div>

                                <div class="summary-row">
                                    <span>IVA (15%):</span>
                                    <span id="totalIva">$0.00</span>
                                </div>

                                <div class="summary-row">
                                    <span>TOTAL:</span>
                                    <span id="totalGeneral">$0.00</span>
                                </div>

                                <div style="margin-top: 20px;">
                                    <label class="form-label" style="color: white;">Anticipo</label>
                                    {{ form.anticipo }}
                                </div>

                                <div class="saldo-box">
                                    <div class="saldo-label">Saldo Pendiente:</div>
                                    <div class="saldo-value" id="saldoPendiente">$0.00</div>
                                </div>
                            </div>

                            <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid var(--border);">
                                <label class="form-label">Estado</label>
                                {{ form.estado }}
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Footer -->
            <div class="wizard-footer">
                <button type="button" class="btn btn-secondary" id="btnPrev" style="display: none;">
                    <i class="fas fa-arrow-left"></i>
                    Anterior
                </button>

                <div style="display: flex; gap: 12px;">
                    <a href="{% url 'taller:orden_list' %}" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                        Cancelar
                    </a>

                    <button type="button" class="btn btn-primary" id="btnNext">
                        Siguiente
                        <i class="fas fa-arrow-right"></i>
                    </button>

                    <button type="submit" class="btn btn-primary" id="btnSubmit" style="display: none;">
                        <i class="fas fa-save"></i>
                        {% if object %}Actualizar{% else %}Crear{% endif %} Orden
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Modal de Servicios -->
<div class="modal fade" id="servicesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-tools"></i>
                    Seleccionar Servicios
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="serviceSearch" class="modal-search" 
                       placeholder="Buscar servicios..." onkeyup="searchServicesInModal()">
                <div id="serviceResults">
                    <div style="text-align: center; padding: 2rem;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p style="margin-top: 1rem;">Cargando servicios...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de T√©cnicos -->
<div class="modal fade" id="technicianModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-tie"></i>
                    Asignar T√©cnico
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Servicio: <strong id="selectedServiceName"></strong></p>
                <div id="technicianList"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Productos -->
<div class="modal fade" id="productsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-boxes"></i>
                    Seleccionar Productos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="productSearch" class="modal-search" 
                       placeholder="Buscar productos..." onkeyup="searchProductsInModal()">
                <div id="productResults">
                    <div style="text-align: center; padding: 2rem;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p style="margin-top: 1rem;">Cargando productos...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% csrf_token %}
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<script>
console.log('üöÄ Iniciando Wizard VPMOTOS (Mismo sistema que POS)...');

// ===== CONFIGURACI√ìN =====
const CONFIG = {
    currentStep: 1,
    totalSteps: 5,
    urls: {
        buscarCliente: '{% url "taller:buscar_cliente_ajax" %}',
        servicios: '/ventas/api/servicios/',
        tecnicos: '/ventas/api/tecnicos/',
        productos: '/ventas/api/productos/'
    }
};

// ===== VARIABLES GLOBALES (IGUAL QUE POS) =====
let serviciosCart = [];
let repuestosCart = [];
let technicians = [];
let services = [];
let products = [];
let selectedService = null;
const IVA_RATE = 0.15;

// ===== INICIALIZACI√ìN =====
document.addEventListener('DOMContentLoaded', function() {
    console.log('‚úÖ DOM cargado');
    initWizard();
    loadInitialData();
    loadInitialFormData();
});

function initWizard() {
    document.getElementById('btnNext').addEventListener('click', () => nextStep());
    document.getElementById('btnPrev').addEventListener('click', () => prevStep());

    // Priority chips
    document.querySelectorAll('.priority-chip').forEach(chip => {
        chip.addEventListener('click', () => {
            document.querySelectorAll('.priority-chip').forEach(c => c.classList.remove('selected'));
            chip.classList.add('selected');
            document.getElementById('prioridadInput').value = chip.dataset.value;
        });
    });

    // Placa en may√∫sculas
    const placaInput = document.querySelector('[name="moto_placa"]');
    if (placaInput) {
        placaInput.addEventListener('input', e => e.target.value = e.target.value.toUpperCase());
    }

    // Anticipo
    const anticipoInput = document.querySelector('[name="anticipo"]');
    if (anticipoInput) {
        anticipoInput.addEventListener('input', calculateTotals);
    }
}

// ===== CARGAR DATOS (IGUAL QUE POS) =====
function loadInitialData() {
    loadTechnicians();
    loadServices();
    loadProducts();
}

function loadTechnicians() {
    fetch(CONFIG.urls.tecnicos)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                technicians = data.tecnicos || [];
                console.log('‚úÖ T√©cnicos cargados:', technicians.length);
            }
        })
        .catch(error => console.error('‚ùå Error loading technicians:', error));
}

function loadServices() {
    fetch(CONFIG.urls.servicios)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                services = data.servicios || [];
                console.log('‚úÖ Servicios cargados:', services.length);
            }
        })
        .catch(error => console.error('‚ùå Error loading services:', error));
}

function loadProducts() {
    fetch(CONFIG.urls.productos)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                products = data.productos || [];
                console.log('‚úÖ Productos cargados:', products.length);
            }
        })
        .catch(error => console.error('‚ùå Error loading products:', error));
}

// ===== WIZARD NAVIGATION =====
function nextStep() {
    if (!validateStep(CONFIG.currentStep)) return;
    if (CONFIG.currentStep < CONFIG.totalSteps) {
        CONFIG.currentStep++;
        updateWizard();
    }
}

function prevStep() {
    if (CONFIG.currentStep > 1) {
        CONFIG.currentStep--;
        updateWizard();
    }
}

function updateWizard() {
    document.querySelectorAll('.wizard-step').forEach(step => step.classList.remove('active'));
    document.querySelector(`.wizard-step[data-step="${CONFIG.currentStep}"]`).classList.add('active');

    document.querySelectorAll('.step').forEach(step => {
        const stepNum = parseInt(step.dataset.step);
        step.classList.remove('active', 'completed');
        if (stepNum < CONFIG.currentStep) step.classList.add('completed');
        else if (stepNum === CONFIG.currentStep) step.classList.add('active');
    });

    const progress = ((CONFIG.currentStep - 1) / (CONFIG.totalSteps - 1)) * 100;
    document.getElementById('progressLine').style.width = progress + '%';

    document.getElementById('btnPrev').style.display = CONFIG.currentStep > 1 ? 'inline-flex' : 'none';
    
    if (CONFIG.currentStep === CONFIG.totalSteps) {
        document.getElementById('btnNext').style.display = 'none';
        document.getElementById('btnSubmit').style.display = 'inline-flex';
        updateResumen();
    } else {
        document.getElementById('btnNext').style.display = 'inline-flex';
        document.getElementById('btnSubmit').style.display = 'none';
    }

    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function validateStep(step) {
    switch(step) {
        case 1:
            if (!document.getElementById('clienteId').value) {
                alert('‚ö†Ô∏è Seleccione un cliente');
                return false;
            }
            break;
        case 2:
            if (!document.querySelector('[name="moto_placa"]').value || 
                !document.querySelector('[name="moto_marca"]').value || 
                !document.querySelector('[name="moto_modelo"]').value) {
                alert('‚ö†Ô∏è Complete los campos de la motocicleta');
                return false;
            }
            break;
        case 3:
            if (!document.querySelector('[name="tecnico_principal"]').value || 
                !document.querySelector('[name="motivo_ingreso"]').value) {
                alert('‚ö†Ô∏è Complete los campos del servicio');
                return false;
            }
            break;
    }
    return true;
}

// ===== CLIENTES (IGUAL QUE POS) =====
const clienteSearchInput = document.getElementById('clienteSearchInput');
const clienteSearchBox = document.getElementById('clienteSearchBox');
let clienteSearchTimeout;

if (clienteSearchInput) {
    clienteSearchInput.addEventListener('input', function() {
        clearTimeout(clienteSearchTimeout);
        const query = this.value.trim();
        if (query.length >= 3) {
            clienteSearchBox.classList.add('loading');
            clienteSearchTimeout = setTimeout(() => buscarCliente(query), 300);
        } else {
            hideClienteResults();
        }
    });
}

document.addEventListener('click', (e) => {
    if (clienteSearchBox && !clienteSearchBox.contains(e.target)) hideClienteResults();
});

function buscarCliente(query) {
    fetch(`${CONFIG.urls.buscarCliente}?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => showClienteResults(data))
        .catch(error => console.error('‚ùå Error:', error))
        .finally(() => clienteSearchBox.classList.remove('loading'));
}

function showClienteResults(results) {
    const resultsDiv = document.getElementById('clienteSearchResults');
    resultsDiv.innerHTML = '';

    if (!results || results.length === 0) {
        resultsDiv.innerHTML = '<div class="search-result-item">No se encontraron clientes</div>';
        resultsDiv.classList.add('show');
        return;
    }

    results.forEach(cliente => {
        const item = document.createElement('div');
        item.className = 'search-result-item';
        item.innerHTML = `
            <div class="result-title">${cliente.nombres} ${cliente.apellidos}</div>
            <div class="result-details">C√©dula: ${cliente.identificacion}${cliente.telefono ? ` | Tel: ${cliente.telefono}` : ''}</div>
        `;
        item.addEventListener('click', () => selectCliente(cliente));
        resultsDiv.appendChild(item);
    });

    resultsDiv.classList.add('show');
}

function selectCliente(cliente) {
    document.getElementById('clienteId').value = cliente.id;
    document.querySelector('[name="cliente_identificacion"]').value = cliente.identificacion;
    document.getElementById('clienteSearchInput').value = `${cliente.nombres} ${cliente.apellidos}`;
    document.getElementById('clienteNombre').textContent = `${cliente.nombres} ${cliente.apellidos}`;
    document.getElementById('clienteTelefono').textContent = cliente.telefono || 'No registrado';
    document.getElementById('clienteEmail').textContent = cliente.email || 'No registrado';
    document.getElementById('clienteDireccion').textContent = cliente.direccion || 'No registrada';
    document.getElementById('clienteInfo').classList.add('show');
    hideClienteResults();
}

function hideClienteResults() {
    document.getElementById('clienteSearchResults').classList.remove('show');
}

// ===== SERVICIOS (IGUAL QUE POS) =====
function showServicesModal() {
    const modal = new bootstrap.Modal(document.getElementById('servicesModal'));
    modal.show();
    displayServicesInModal(services);
}

function displayServicesInModal(serviceList) {
    const resultsContainer = document.getElementById('serviceResults');
    if (!resultsContainer) return;
    
    if (serviceList.length === 0) {
        resultsContainer.innerHTML = '<p style="text-align: center;">No hay servicios disponibles</p>';
        return;
    }
    
    resultsContainer.innerHTML = serviceList.map(service => `
        <div class="modal-item" onclick="selectServiceFromModal(${service.id})">
            <div class="item-header">
                <h6 class="item-title">${escapeHtml(service.nombre)}</h6>
                <span class="item-price">$${service.precio_total.toFixed(2)}</span>
            </div>
            <div class="item-meta">
                <span>C√≥digo: ${escapeHtml(service.codigo)}</span>
                <span>${service.categoria || 'Servicio'}</span>
            </div>
        </div>
    `).join('');
}

function searchServicesInModal() {
    const searchInput = document.getElementById('serviceSearch');
    if (!searchInput) return;
    
    const search = searchInput.value.trim().toLowerCase();
    const filteredServices = services.filter(service => 
        service.nombre.toLowerCase().includes(search) ||
        service.codigo.toLowerCase().includes(search)
    );
    displayServicesInModal(filteredServices);
}

function selectServiceFromModal(serviceId) {
    const service = services.find(s => s.id === serviceId);
    if (service) {
        const servicesModal = bootstrap.Modal.getInstance(document.getElementById('servicesModal'));
        if (servicesModal) servicesModal.hide();
        
        selectTechnicianForService(service);
    }
}

function selectTechnicianForService(service) {
    selectedService = service;
    document.getElementById('selectedServiceName').textContent = service.nombre;
    
    const technicianList = document.getElementById('technicianList');
    technicianList.innerHTML = `
        <div class="modal-item" onclick="assignTechnician(null)">
            <h6 class="item-title">Sin t√©cnico asignado</h6>
        </div>
        ${technicians.map(tech => `
            <div class="modal-item" onclick="assignTechnician(${tech.id})">
                <div class="item-header">
                    <h6 class="item-title">${escapeHtml(tech.nombre)}</h6>
                </div>
                <div class="item-meta">
                    <span>${tech.especialidad || 'T√©cnico general'}</span>
                </div>
            </div>
        `).join('')}
    `;
    
    const modal = new bootstrap.Modal(document.getElementById('technicianModal'));
    modal.show();
}

function assignTechnician(technicianId) {
    if (!selectedService) return;
    
    const technician = technicians.find(t => t.id == technicianId);
    
    addServiceToCart({
        id: selectedService.id,
        code: selectedService.codigo,
        name: selectedService.nombre,
        type: 'service',
        price: selectedService.precio_total,
        precio_base: selectedService.precio_base || 0,
        precio_mano_obra: selectedService.precio_mano_obra || 0,
        tiempo_estimado: selectedService.tiempo_estimado || 0,
        technician_id: technicianId,
        technician_name: technician ? technician.nombre : null
    });
    
    const technicianModal = bootstrap.Modal.getInstance(document.getElementById('technicianModal'));
    if (technicianModal) technicianModal.hide();
    
    selectedService = null;
    showToast('Servicio agregado', 'success');
}

function addServiceToCart(item) {
    const existingItem = serviciosCart.find(cartItem => cartItem.id === item.id);
    
    if (existingItem) {
        existingItem.quantity++;
    } else {
        serviciosCart.push({
            ...item,
            quantity: 1
        });
    }
    
    updateServiciosDisplay();
    updateServiciosCount();
    calculateTotals();
}

function updateServiciosDisplay() {
    const serviciosList = document.getElementById('serviciosList');
    
    if (serviciosCart.length === 0) {
        serviciosList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-tools"></i>
                <h5>Sin servicios</h5>
                <p>Haz clic en el bot√≥n de abajo para agregar servicios</p>
            </div>
        `;
        return;
    }
    
    serviciosList.innerHTML = serviciosCart.map((item, index) => {
        const subtotal = item.price * item.quantity;
        return `
            <div class="item-row">
                <div class="item-info">
                    <div class="item-name">${escapeHtml(item.name)}</div>
                    <div class="item-code">${escapeHtml(item.code)}</div>
                    <div class="item-price">$${item.price.toFixed(2)} c/u</div>
                    ${item.technician_name ? `<div class="item-technician">T√©cnico: ${escapeHtml(item.technician_name)}</div>` : ''}
                </div>
                <div class="quantity-controls">
                    <button type="button" class="qty-btn" onclick="updateServicioQuantity(${index}, ${item.quantity - 1})">
                        <i class="fas fa-minus"></i>
                    </button>
                    <span class="qty-display">${item.quantity}</span>
                    <button type="button" class="qty-btn" onclick="updateServicioQuantity(${index}, ${item.quantity + 1})">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="item-total">$${subtotal.toFixed(2)}</div>
                <button type="button" class="remove-btn" onclick="removeServicio(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    }).join('');
}

function updateServicioQuantity(index, newQuantity) {
    if (newQuantity <= 0) {
        removeServicio(index);
        return;
    }
    
    serviciosCart[index].quantity = parseInt(newQuantity);
    updateServiciosDisplay();
    calculateTotals();
}

function removeServicio(index) {
    serviciosCart.splice(index, 1);
    updateServiciosDisplay();
    updateServiciosCount();
    calculateTotals();
}

function updateServiciosCount() {
    const count = serviciosCart.reduce((total, item) => total + item.quantity, 0);
    document.getElementById('serviciosCountBadge').textContent = `${count} servicio${count !== 1 ? 's' : ''}`;
}

// ===== PRODUCTOS (IGUAL QUE POS) =====
function showProductsModal() {
    const modal = new bootstrap.Modal(document.getElementById('productsModal'));
    modal.show();
    displayProductsInModal(products);
}

function displayProductsInModal(productList) {
    const resultsContainer = document.getElementById('productResults');
    if (!resultsContainer) return;
    
    if (productList.length === 0) {
        resultsContainer.innerHTML = '<p style="text-align: center;">No hay productos disponibles</p>';
        return;
    }
    
    resultsContainer.innerHTML = productList.map(product => `
        <div class="modal-item" onclick="selectProductFromModal(${product.id})">
            <div class="item-header">
                <h6 class="item-title">${escapeHtml(product.nombre)}</h6>
                <span class="item-price">$${product.precio.toFixed(2)}</span>
            </div>
            <div class="item-meta">
                <span>C√≥digo: ${escapeHtml(product.codigo)}</span>
                <span class="badge ${product.stock > 10 ? 'bg-success' : product.stock > 0 ? 'bg-warning' : 'bg-danger'}">Stock: ${product.stock}</span>
            </div>
        </div>
    `).join('');
}

function searchProductsInModal() {
    const searchInput = document.getElementById('productSearch');
    if (!searchInput) return;
    
    const search = searchInput.value.trim().toLowerCase();
    const filteredProducts = products.filter(product => 
        product.nombre.toLowerCase().includes(search) ||
        product.codigo.toLowerCase().includes(search)
    );
    displayProductsInModal(filteredProducts);
}

function selectProductFromModal(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;
    
    if (product.stock <= 0) {
        showToast('Sin stock disponible', 'warning');
        return;
    }
    
    addProductToCart({
        id: product.id,
        code: product.codigo,
        name: product.nombre,
        type: 'product',
        price: product.precio,
        stock: product.stock
    });
    
    const productsModal = bootstrap.Modal.getInstance(document.getElementById('productsModal'));
    if (productsModal) productsModal.hide();
    
    showToast('Producto agregado', 'success');
}

function addProductToCart(item) {
    const existingItem = repuestosCart.find(cartItem => cartItem.id === item.id);
    
    if (existingItem) {
        if (existingItem.quantity >= item.stock) {
            showToast('Stock insuficiente', 'warning');
            return;
        }
        existingItem.quantity++;
    } else {
        repuestosCart.push({
            ...item,
            quantity: 1
        });
    }
    
    updateRepuestosDisplay();
    updateRepuestosCount();
    calculateTotals();
}

function updateRepuestosDisplay() {
    const repuestosList = document.getElementById('repuestosList');
    
    if (repuestosCart.length === 0) {
        repuestosList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-boxes"></i>
                <h5>Sin repuestos</h5>
                <p>Haz clic en el bot√≥n de abajo para agregar repuestos</p>
            </div>
        `;
        return;
    }
    
    repuestosList.innerHTML = repuestosCart.map((item, index) => {
        const subtotal = item.price * item.quantity;
        return `
            <div class="item-row">
                <div class="item-info">
                    <div class="item-name">${escapeHtml(item.name)}</div>
                    <div class="item-code">${escapeHtml(item.code)}</div>
                    <div class="item-price">$${item.price.toFixed(2)} c/u | Stock: ${item.stock}</div>
                </div>
                <div class="quantity-controls">
                    <button type="button" class="qty-btn" onclick="updateRepuestoQuantity(${index}, ${item.quantity - 1})">
                        <i class="fas fa-minus"></i>
                    </button>
                    <span class="qty-display">${item.quantity}</span>
                    <button type="button" class="qty-btn" onclick="updateRepuestoQuantity(${index}, ${item.quantity + 1})">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div class="item-total">$${subtotal.toFixed(2)}</div>
                <button type="button" class="remove-btn" onclick="removeRepuesto(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    }).join('');
}

function updateRepuestoQuantity(index, newQuantity) {
    if (newQuantity <= 0) {
        removeRepuesto(index);
        return;
    }
    
    const item = repuestosCart[index];
    if (newQuantity > item.stock) {
        showToast('Stock insuficiente', 'warning');
        return;
    }
    
    repuestosCart[index].quantity = parseInt(newQuantity);
    updateRepuestosDisplay();
    calculateTotals();
}

function removeRepuesto(index) {
    repuestosCart.splice(index, 1);
    updateRepuestosDisplay();
    updateRepuestosCount();
    calculateTotals();
}

function updateRepuestosCount() {
    const count = repuestosCart.reduce((total, item) => total + item.quantity, 0);
    document.getElementById('repuestosCountBadge').textContent = `${count} repuesto${count !== 1 ? 's' : ''}`;
}

// ===== C√ÅLCULOS =====
function calculateTotals() {
    let totalServicios = serviciosCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    let totalRepuestos = repuestosCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    
    const iva = totalRepuestos * IVA_RATE;
    const total = totalServicios + totalRepuestos + iva;
    
    document.getElementById('totalServicios').textContent = `$${totalServicios.toFixed(2)}`;
    document.getElementById('totalRepuestos').textContent = `$${totalRepuestos.toFixed(2)}`;
    document.getElementById('totalIva').textContent = `$${iva.toFixed(2)}`;
    document.getElementById('totalGeneral').textContent = `$${total.toFixed(2)}`;
    
    const anticipo = parseFloat(document.querySelector('[name="anticipo"]')?.value) || 0;
    const saldo = total - anticipo;
    document.getElementById('saldoPendiente').textContent = `$${saldo.toFixed(2)}`;
}

// ===== RESUMEN =====
function updateResumen() {
    calculateTotals();
    
    const clienteNombre = document.getElementById('clienteNombre').textContent;
    const clienteTel = document.getElementById('clienteTelefono').textContent;
    document.getElementById('resumenCliente').innerHTML = `<strong>${clienteNombre}</strong><br>Tel: ${clienteTel}`;

    const placa = document.querySelector('[name="moto_placa"]').value;
    const marca = document.querySelector('[name="moto_marca"]').value;
    const modelo = document.querySelector('[name="moto_modelo"]').value;
    document.getElementById('resumenMoto').innerHTML = `<strong>${placa}</strong> - ${marca} ${modelo}`;

    let serviciosHTML = '<ul style="margin: 0; padding-left: 20px;">';
    serviciosCart.forEach(item => {
        serviciosHTML += `<li>${item.name} - Cant: ${item.quantity}</li>`;
    });
    serviciosHTML += '</ul>';
    document.getElementById('resumenServicios').innerHTML = serviciosHTML;

    let repuestosHTML = '<ul style="margin: 0; padding-left: 20px;">';
    repuestosCart.forEach(item => {
        repuestosHTML += `<li>${item.name} - Cant: ${item.quantity}</li>`;
    });
    repuestosHTML += '</ul>';
    document.getElementById('resumenRepuestos').innerHTML = repuestosHTML;
}

// ===== SUBMIT FORM =====
document.getElementById('wizardForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    if (!document.getElementById('clienteId').value) {
        alert('‚ö†Ô∏è Seleccione un cliente');
        CONFIG.currentStep = 1;
        updateWizard();
        return false;
    }
    
    // Sincronizar con formsets
    syncServiciosFormset();
    syncRepuestosFormset();
    
    // Enviar formulario
    this.submit();
});

function syncServiciosFormset() {
    const totalForms = document.querySelector('[name="servicios-TOTAL_FORMS"]');
    totalForms.value = serviciosCart.length;
    
    // Limpiar formset
    document.querySelectorAll('[name^="servicios-"]').forEach(input => {
        if (!input.name.includes('TOTAL_FORMS') && !input.name.includes('INITIAL_FORMS') && !input.name.includes('MAX_NUM_FORMS')) {
            input.remove();
        }
    });
    
    // Agregar items del cart
    serviciosCart.forEach((item, index) => {
        addHiddenInput(`servicios-${index}-tipo_servicio`, item.id);
        addHiddenInput(`servicios-${index}-tecnico_asignado`, item.technician_id || '');
        addHiddenInput(`servicios-${index}-precio_base`, item.precio_base);
        addHiddenInput(`servicios-${index}-precio_mano_obra`, item.precio_mano_obra);
        addHiddenInput(`servicios-${index}-tiempo_estimado`, item.tiempo_estimado);
        addHiddenInput(`servicios-${index}-cantidad`, item.quantity);
    });
}

function syncRepuestosFormset() {
    const totalForms = document.querySelector('[name="repuestos-TOTAL_FORMS"]');
    totalForms.value = repuestosCart.length;
    
    // Limpiar formset
    document.querySelectorAll('[name^="repuestos-"]').forEach(input => {
        if (!input.name.includes('TOTAL_FORMS') && !input.name.includes('INITIAL_FORMS') && !input.name.includes('MAX_NUM_FORMS')) {
            input.remove();
        }
    });
    
    // Agregar items del cart
    repuestosCart.forEach((item, index) => {
        addHiddenInput(`repuestos-${index}-producto`, item.id);
        addHiddenInput(`repuestos-${index}-cantidad`, item.quantity);
        addHiddenInput(`repuestos-${index}-precio_unitario`, item.price);
    });
}

function addHiddenInput(name, value) {
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = name;
    input.value = value;
    document.getElementById('wizardForm').appendChild(input);
}

// ===== CARGAR DATOS INICIALES EN EDICI√ìN =====
function loadInitialFormData() {
    {% if object and object.cliente %}
    selectCliente({
        id: {{ object.cliente.id }},
        nombres: "{{ object.cliente.nombres|escapejs }}",
        apellidos: "{{ object.cliente.apellidos|escapejs }}",
        identificacion: "{{ object.cliente.identificacion|escapejs }}",
        telefono: "{{ object.cliente.telefono|default:''|escapejs }}",
        email: "{{ object.cliente.email|default:''|escapejs }}",
        direccion: "{{ object.cliente.direccion|default:''|escapejs }}"
    });
    {% endif %}

    const prioridadValue = '{{ form.prioridad.value|default:"" }}';
    if (prioridadValue) {
        document.querySelectorAll('.priority-chip').forEach(chip => {
            if (chip.dataset.value === prioridadValue) {
                chip.classList.add('selected');
                document.getElementById('prioridadInput').value = prioridadValue;
            }
        });
    }
}

// ===== UTILIDADES =====
function showToast(message, type = 'info') {
    console.log(`[${type.toUpperCase()}] ${message}`);
    // Aqu√≠ puedes agregar un toast visual si lo deseas
}

function escapeHtml(text) {
    if (typeof text !== 'string') return text;
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

console.log('‚úÖ Wizard listo (Sistema POS integrado)');
</script>
{% endblock %}