{% extends 'base.html' %}

{% block title %}Órdenes de Trabajo - VPMOTOS{% endblock %}

{% block extra_css %}
<style>
    /* Estilos para lista de órdenes */
    .content-wrapper {
        padding: 1rem;
    }
    
    .filters-container {
        background: linear-gradient(135deg, var(--light) 0%, #f8f9fa 100%);
        border-radius: var(--border-radius);
        border: 1px solid var(--gray-200);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .order-row {
        cursor: pointer;
        transition: var(--transition);
        border-bottom: 1px solid var(--gray-200);
    }
    
    .order-row:hover {
        background-color: rgba(67, 97, 238, 0.05);
        transform: translateX(5px);
    }
    
    .order-row:last-child {
        border-bottom: none;
    }
    
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        white-space: nowrap;
    }
    
    .status-pendiente {
        background-color: rgba(255, 193, 7, 0.1);
        color: #856404;
        border: 1px solid rgba(255, 193, 7, 0.3);
    }
    
    .status-en-proceso {
        background-color: rgba(13, 110, 253, 0.1);
        color: #084298;
        border: 1px solid rgba(13, 110, 253, 0.3);
    }
    
    .status-esperando-repuestos {
        background-color: rgba(255, 107, 0, 0.1);
        color: #cc5500;
        border: 1px solid rgba(255, 107, 0, 0.3);
    }
    
    .status-esperando-aprobacion {
        background-color: rgba(102, 16, 242, 0.1);
        color: #5a0e91;
        border: 1px solid rgba(102, 16, 242, 0.3);
    }
    
    .status-completado {
        background-color: rgba(25, 135, 84, 0.1);
        color: #0f5132;
        border: 1px solid rgba(25, 135, 84, 0.3);
    }
    
    .status-entregado {
        background-color: rgba(32, 201, 151, 0.1);
        color: #0a3622;
        border: 1px solid rgba(32, 201, 151, 0.3);
    }
    
    .status-cancelado {
        background-color: rgba(220, 53, 69, 0.1);
        color: #842029;
        border: 1px solid rgba(220, 53, 69, 0.3);
    }
    
    .priority-badge {
        padding: 0.15rem 0.5rem;
        border-radius: 15px;
        font-size: 0.65rem;
        font-weight: 500;
    }
    
    .priority-baja {
        background-color: rgba(108, 117, 125, 0.1);
        color: #495057;
    }
    
    .priority-normal {
        background-color: rgba(13, 110, 253, 0.1);
        color: #084298;
    }
    
    .priority-alta {
        background-color: rgba(255, 193, 7, 0.1);
        color: #856404;
    }
    
    .priority-urgente {
        background-color: rgba(220, 53, 69, 0.1);
        color: #842029;
    }
    
    .stats-summary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        border-radius: var(--border-radius);
        color: white;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .stats-item {
        text-align: center;
        padding: 0.5rem;
    }
    
    .stats-number {
        font-size: 1.5rem;
        font-weight: 700;
        display: block;
    }
    
    .stats-label {
        font-size: 0.85rem;
        opacity: 0.9;
    }
    
    .animate-fade-in {
        animation: fadeIn 0.6s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .section-header {
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--gray-200);
    }
    
    .section-title {
        font-weight: 600;
        color: var(--gray-800);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .table-container {
        background-color: var(--light);
        border-radius: var(--border-radius);
        border: 1px solid var(--gray-200);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .table-header {
        background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
        border-bottom: 2px solid var(--gray-200);
        padding: 1rem;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }
    
    .time-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 500;
    }
    
    .time-recent {
        background-color: rgba(25, 135, 84, 0.1);
        color: #0f5132;
    }
    
    .time-today {
        background-color: rgba(13, 110, 253, 0.1);
        color: #084298;
    }
    
    .time-yesterday {
        background-color: rgba(255, 193, 7, 0.1);
        color: #856404;
    }
    
    .time-old {
        background-color: rgba(108, 117, 125, 0.1);
        color: #495057;
    }
    
    .pagination-container {
        background-color: var(--light);
        border-radius: var(--border-radius);
        padding: 1rem;
        margin-top: 1rem;
        border: 1px solid var(--gray-200);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid content-wrapper">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="section-title animate-fade-in">
                        <i class="fas fa-clipboard-list text-primary"></i>
                        Órdenes de Trabajo
                    </h2>
                    <p class="text-muted mb-0">Gestión de órdenes del taller</p>
                </div>
                <div class="animate-fade-in">
                    <a href="{% url 'taller:orden_create' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Nueva Orden
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Resumen de Estadísticas -->
    <div class="stats-summary animate-fade-in">
        <div class="row g-0">
            <div class="col-md-3">
                <div class="stats-item">
                    <span class="stats-number">{{ total_ordenes }}</span>
                    <span class="stats-label">Total Órdenes</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-item">
                    <span class="stats-number">{{ pendientes }}</span>
                    <span class="stats-label">Pendientes</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-item">
                    <span class="stats-number">{{ en_proceso }}</span>
                    <span class="stats-label">En Proceso</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-item">
                    <span class="stats-number">${{ object_list|length|floatformat:0 }}</span>
                    <span class="stats-label">Mostrando</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filtros de Búsqueda -->
    <div class="filters-container animate-fade-in">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label for="id_busqueda" class="form-label">
                    <i class="fas fa-search me-1"></i>Búsqueda
                </label>
                <div class="input-group">
                    <span class="input-group-text bg-light">
                        <i class="fas fa-search"></i>
                    </span>
                    {{ form_busqueda.busqueda }}
                </div>
            </div>
            <div class="col-md-2">
                <label for="id_estado" class="form-label">
                    <i class="fas fa-flag me-1"></i>Estado
                </label>
                {{ form_busqueda.estado }}
            </div>
            <div class="col-md-2">
                <label for="id_tecnico" class="form-label">
                    <i class="fas fa-user-cog me-1"></i>Técnico
                </label>
                {{ form_busqueda.tecnico }}
            </div>
            <div class="col-md-2">
                <label for="id_fecha_desde" class="form-label">
                    <i class="fas fa-calendar me-1"></i>Desde
                </label>
                {{ form_busqueda.fecha_desde }}
            </div>
            <div class="col-md-2">
                <label for="id_fecha_hasta" class="form-label">
                    <i class="fas fa-calendar-check me-1"></i>Hasta
                </label>
                {{ form_busqueda.fecha_hasta }}
            </div>
            <div class="col-md-1">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Lista de Órdenes -->
    <div class="table-container animate-fade-in">
        <div class="table-header">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Lista de Órdenes
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">
                        <i class="fas fa-print me-1"></i>Imprimir
                    </button>
                    <button class="btn btn-outline-success btn-sm">
                        <i class="fas fa-file-excel me-1"></i>Exportar
                    </button>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th width="120">Número</th>
                        <th>Cliente</th>
                        <th>Motocicleta</th>
                        <th>Técnico</th>
                        <th width="120">Estado</th>
                        <th width="100">Prioridad</th>
                        <th width="120">Fecha Ingreso</th>
                        <th width="100" class="text-end">Total</th>
                        <th width="80">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for orden in ordenes %}
                    <tr class="order-row" data-orden-id="{{ orden.pk }}" style="cursor: pointer;">
                        <td>
                            <strong class="text-primary">{{ orden.numero_orden }}</strong>
                            {% if orden.fecha_ingreso.date == today %}
                                <span class="time-badge time-today">Hoy</span>
                            {% elif orden.fecha_ingreso.date == yesterday %}
                                <span class="time-badge time-yesterday">Ayer</span>
                            {% elif orden.fecha_ingreso.date|timesince:"days" < 7 %}
                                <span class="time-badge time-recent">{{ orden.fecha_ingreso.date|timesince }}</span>
                            {% else %}
                                <span class="time-badge time-old">{{ orden.fecha_ingreso.date|timesince }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="fw-bold">{{ orden.cliente.get_nombre_completo }}</div>
                            <small class="text-muted">
                                <i class="fas fa-id-card me-1"></i>{{ orden.cliente.identificacion }}
                            </small>
                        </td>
                        <td>
                            <div class="fw-bold">{{ orden.moto.placa }}</div>
                            <small class="text-muted">{{ orden.moto.marca }} {{ orden.moto.modelo }}</small>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="me-2">
                                    {% if orden.tecnico_principal.foto %}
                                        <img src="{{ orden.tecnico_principal.foto.url }}" 
                                             class="rounded-circle" width="32" height="32" alt="Técnico">
                                    {% else %}
                                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center text-white" 
                                             style="width: 32px; height: 32px; font-size: 0.8rem;">
                                            {{ orden.tecnico_principal.nombres.0 }}{{ orden.tecnico_principal.apellidos.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div>
                                    <div class="fw-bold">{{ orden.tecnico_principal.get_nombre_completo }}</div>
                                    <small class="text-muted">{{ orden.tecnico_principal.codigo }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="status-badge status-{{ orden.estado|lower|cut:' '|cut:'_' }}">
                                {{ orden.get_estado_display }}
                            </span>
                        </td>
                        <td>
                            <span class="priority-badge priority-{{ orden.prioridad|lower }}">
                                {{ orden.get_prioridad_display }}
                            </span>
                        </td>
                        <td>
                            <div class="fw-bold">{{ orden.fecha_ingreso|date:"d/m/Y" }}</div>
                            <small class="text-muted">{{ orden.fecha_ingreso|date:"H:i" }}</small>
                        </td>
                        <td class="text-end">
                            <div class="fw-bold text-primary">${{ orden.precio_total|floatformat:2 }}</div>
                            {% if orden.anticipo > 0 %}
                                <small class="text-muted">Anticipo: ${{ orden.anticipo|floatformat:2 }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <div class="dropdown" onclick="event.stopPropagation();">
                                <button class="btn btn-outline-primary btn-sm dropdown-toggle" 
                                        type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li>
                                        <a class="dropdown-item" href="{% url 'taller:orden_detail' orden.pk %}">
                                            <i class="fas fa-eye me-2"></i>Ver Detalle
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% url 'taller:orden_update' orden.pk %}">
                                            <i class="fas fa-edit me-2"></i>Editar
                                        </a>
                                    </li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item text-success" href="#" 
                                           data-orden-id="{{ orden.pk }}" data-estado="COMPLETADO"
                                           onclick="cambiarEstadoSeguro(this)">
                                            <i class="fas fa-check me-2"></i>Marcar Completado
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item text-primary" href="#" 
                                           data-orden-id="{{ orden.pk }}" data-estado="ENTREGADO"
                                           onclick="cambiarEstadoSeguro(this)">
                                            <i class="fas fa-handshake me-2"></i>Marcar Entregado
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center py-5">
                            <div class="text-muted">
                                <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                                <h5>No hay órdenes registradas</h5>
                                <p>No se encontraron órdenes que coincidan con los filtros aplicados.</p>
                                <a href="{% url 'taller:orden_create' %}" class="btn btn-primary">
                                    <i class="fas fa-plus me-1"></i>Crear Primera Orden
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Paginación -->
    {% if is_paginated %}
    <div class="pagination-container">
        <nav aria-label="Navegación de páginas">
            <ul class="pagination justify-content-center mb-0">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if request.GET.busqueda %}&busqueda={{ request.GET.busqueda }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.busqueda %}&busqueda={{ request.GET.busqueda }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    </li>
                {% endif %}
                
                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                        <li class="page-item active">
                            <span class="page-link">{{ num }}</span>
                        </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ num }}{% if request.GET.busqueda %}&busqueda={{ request.GET.busqueda }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}">{{ num }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.busqueda %}&busqueda={{ request.GET.busqueda }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}">
                            <i class="fas fa-angle-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.busqueda %}&busqueda={{ request.GET.busqueda }}{% endif %}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
        
        <div class="text-center mt-2">
            <small class="text-muted">
                Mostrando {{ page_obj.start_index }} - {{ page_obj.end_index }} de {{ page_obj.paginator.count }} resultados
            </small>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal para cambiar estado -->
<div class="modal fade" id="cambiarEstadoModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cambiar Estado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="cambiarEstadoForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="ordenId" name="orden_id">
                    <input type="hidden" id="nuevoEstado" name="estado">
                    <div class="mb-3">
                        <label for="observaciones" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="observaciones" name="observaciones" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Confirmar</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Manejar clics en filas de órdenes
    document.querySelectorAll('.order-row').forEach(row => {
        row.addEventListener('click', function(e) {
            // Solo navegar si no se hizo clic en el dropdown
            if (!e.target.closest('.dropdown')) {
                const ordenId = this.dataset.ordenId;
                if (ordenId) {
                    window.location.href = `/taller/ordenes/${ordenId}/`;
                }
            }
        });
    });
    
    // Prevenir propagación del evento click en dropdowns
    document.querySelectorAll('.dropdown').forEach(dropdown => {
        dropdown.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });
});

function cambiarEstadoSeguro(element) {
    const ordenId = element.dataset.ordenId;
    const estado = element.dataset.estado;
    
    if (ordenId && estado) {
        cambiarEstado(ordenId, estado);
    }
}

function cambiarEstado(ordenId, estado) {
    document.getElementById('ordenId').value = ordenId;
    document.getElementById('nuevoEstado').value = estado;
    
    // Cambiar título del modal
    const modal = new bootstrap.Modal(document.getElementById('cambiarEstadoModal'));
    const title = document.querySelector('#cambiarEstadoModal .modal-title');
    title.textContent = `Cambiar Estado a ${estado}`;
    
    // Configurar formulario
    const form = document.getElementById('cambiarEstadoForm');
    form.action = `/taller/ordenes/${ordenId}/cambiar-estado/`;
    
    modal.show();
}

// Manejar envío del formulario de cambio de estado
document.getElementById('cambiarEstadoForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error al cambiar el estado: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al procesar la solicitud');
    });
});
</script>
{% endblock %}