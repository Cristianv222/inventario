{% extends 'base.html' %}

{% block title %}{% if object %}Editar Servicio{% else %}Nuevo Servicio{% endif %} - VPMOTOS{% endblock %}

{% block extra_css %}
<style>
    /* Estilos para formulario de servicio */
    .content-wrapper {
        padding: 1rem;
    }
    
    .form-container {
        background: linear-gradient(135deg, var(--light) 0%, #f8f9fa 100%);
        border-radius: var(--border-radius);
        border: 1px solid var(--gray-200);
        padding: 2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .section-card {
        background-color: var(--light);
        border-radius: var(--border-radius);
        border: 1px solid var(--gray-200);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: var(--transition);
    }
    
    .section-card:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }
    
    .section-header {
        border-bottom: 2px solid var(--gray-200);
        padding-bottom: 0.75rem;
        margin-bottom: 1.5rem;
    }
    
    .section-title {
        font-weight: 600;
        color: var(--gray-800);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0;
    }
    
    .form-floating label {
        color: var(--gray-600);
    }
    
    .form-control:focus,
    .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
    }
    
    .preview-card {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        color: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        position: sticky;
        top: 20px;
    }
    
    .preview-icon {
        width: 60px;
        height: 60px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        margin-bottom: 1rem;
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    .price-calculator {
        background-color: #f8f9fa;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        border: 1px solid var(--gray-200);
    }
    
    .price-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--gray-300);
    }
    
    .price-row:last-child {
        border-bottom: none;
        font-size: 1.2rem;
        font-weight: 700;
        padding-top: 1rem;
        border-top: 2px solid var(--gray-400);
    }
    
    .btn-action {
        padding: 0.75rem 1.5rem;
        border-radius: var(--border-radius);
        font-weight: 600;
        transition: var(--transition);
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .animate-fade-in {
        animation: fadeIn 0.6s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .required-field {
        position: relative;
    }
    
    .required-field::after {
        content: '*';
        color: #dc3545;
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        font-weight: bold;
    }
    
    .help-text {
        font-size: 0.875rem;
        color: var(--gray-600);
        margin-top: 0.25rem;
    }
    
    .validation-feedback {
        display: block;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875rem;
        color: #dc3545;
    }
    
    .difficulty-preview {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        margin-left: 0.5rem;
    }
    
    .difficulty-basico {
        background-color: rgba(25, 135, 84, 0.1);
        color: #0f5132;
        border: 1px solid rgba(25, 135, 84, 0.3);
    }
    
    .difficulty-intermedio {
        background-color: rgba(255, 193, 7, 0.1);
        color: #856404;
        border: 1px solid rgba(255, 193, 7, 0.3);
    }
    
    .difficulty-avanzado {
        background-color: rgba(255, 107, 0, 0.1);
        color: #cc5500;
        border: 1px solid rgba(255, 107, 0, 0.3);
    }
    
    .difficulty-experto {
        background-color: rgba(220, 53, 69, 0.1);
        color: #842029;
        border: 1px solid rgba(220, 53, 69, 0.3);
    }
    
    .code-generator {
        background-color: rgba(67, 97, 238, 0.1);
        border: 1px solid rgba(67, 97, 238, 0.2);
        border-radius: var(--border-radius);
        padding: 1rem;
        margin-top: 0.5rem;
    }
    
    .feature-toggle {
        background-color: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius);
        padding: 1rem;
        margin-bottom: 1rem;
        transition: var(--transition);
    }
    
    .feature-toggle:hover {
        border-color: var(--primary);
        background-color: rgba(67, 97, 238, 0.02);
    }
    
    .feature-toggle.active {
        border-color: var(--primary);
        background-color: rgba(67, 97, 238, 0.05);
    }
    
    .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }
    
    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 24px;
    }
    
    .slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    
    input:checked + .slider {
        background-color: var(--primary);
    }
    
    input:checked + .slider:before {
        transform: translateX(26px);
    }
    
    /* Estilos para el botón de nueva categoría */
    .input-group-category {
        position: relative;
    }
    
    .btn-new-category {
        position: absolute;
        right: 5px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 5;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }
    
    /* Estilos para el modal */
    .modal-header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        color: white;
        border-bottom: none;
    }
    
    .modal-header .btn-close {
        filter: invert(1);
    }
    
    .modal-body {
        padding: 2rem;
    }
    
    .quick-form-field {
        margin-bottom: 1.5rem;
    }
    
    .color-picker-container {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 0.5rem;
    }
    
    .color-option {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 2px solid #dee2e6;
        cursor: pointer;
        transition: transform 0.2s ease;
    }
    
    .color-option:hover {
        transform: scale(1.1);
    }
    
    .color-option.selected {
        border-color: #495057;
        border-width: 3px;
    }
    
    .loading-spinner {
        display: none;
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid content-wrapper">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="section-title animate-fade-in">
                        <i class="fas fa-cog text-primary"></i>
                        {% if object %}Editar Servicio - {{ object.nombre }}{% else %}Nuevo Tipo de Servicio{% endif %}
                    </h2>
                    <p class="text-muted mb-0">Configure los detalles del servicio para taller y ventas</p>
                </div>
                <div class="animate-fade-in">
                    <a href="{% url 'taller:tipo_servicio_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Volver
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <form method="post" id="servicioForm">
        {% csrf_token %}
        
        <div class="row">
            <!-- Columna Principal -->
            <div class="col-lg-8">
                <!-- Información Básica -->
                <div class="section-card animate-fade-in">
                    <div class="section-header">
                        <h4 class="section-title">
                            <i class="fas fa-info-circle text-primary"></i>
                            Información Básica
                        </h4>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-floating required-field">
                                {{ form.nombre }}
                                <label for="{{ form.nombre.id_for_label }}">Nombre del Servicio</label>
                            </div>
                            {% if form.nombre.errors %}
                                <div class="validation-feedback">{{ form.nombre.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-floating required-field">
                                {{ form.codigo }}
                                <label for="{{ form.codigo.id_for_label }}">Código del Servicio</label>
                            </div>
                            <div class="code-generator">
                                <small class="text-muted">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    Sugerencia: Use un código como "MANT001", "REP002", etc.
                                </small>
                                <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="generarCodigo()">
                                    <i class="fas fa-magic me-1"></i>Auto-generar
                                </button>
                            </div>
                            {% if form.codigo.errors %}
                                <div class="validation-feedback">{{ form.codigo.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6">
                            <div class="input-group-category">
                                <div class="form-floating required-field" style="width: 100%;">
                                    {{ form.categoria }}
                                    <label for="{{ form.categoria.id_for_label }}">Categoría</label>
                                </div>
                                <button type="button" class="btn btn-primary btn-sm btn-new-category" 
                                        data-bs-toggle="modal" data-bs-target="#modalNuevaCategoria"
                                        title="Crear nueva categoría">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            {% if form.categoria.errors %}
                                <div class="validation-feedback">{{ form.categoria.errors.0 }}</div>
                            {% endif %}
                            <div class="help-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Si no encuentra la categoría, puede crear una nueva
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-floating">
                                {{ form.nivel_dificultad }}
                                <label for="{{ form.nivel_dificultad.id_for_label }}">Nivel de Dificultad</label>
                            </div>
                            <div class="help-text">
                                <span id="difficultyPreview">Nivel de complejidad técnica</span>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <div class="form-floating">
                                {{ form.descripcion }}
                                <label for="{{ form.descripcion.id_for_label }}">Descripción</label>
                            </div>
                            <div class="help-text">Describe qué incluye este servicio y sus beneficios</div>
                        </div>
                    </div>
                </div>
                
                <!-- Precios y Tiempo -->
                <div class="section-card animate-fade-in">
                    <div class="section-header">
                        <h4 class="section-title">
                            <i class="fas fa-dollar-sign text-primary"></i>
                            Precios y Tiempo
                        </h4>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="form-floating required-field">
                                {{ form.precio_base }}
                                <label for="{{ form.precio_base.id_for_label }}">Precio Base</label>
                            </div>
                            <div class="help-text">Precio base del servicio (sin mano de obra)</div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="form-floating required-field">
                                {{ form.precio_mano_obra }}
                                <label for="{{ form.precio_mano_obra.id_for_label }}">Precio Mano de Obra</label>
                            </div>
                            <div class="help-text">Costo de la mano de obra técnica</div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="form-floating required-field">
                                {{ form.tiempo_estimado_horas }}
                                <label for="{{ form.tiempo_estimado_horas.id_for_label }}">Tiempo Estimado (horas)</label>
                            </div>
                            <div class="help-text">Tiempo promedio de ejecución</div>
                        </div>
                        
                        <div class="col-12">
                            <div class="price-calculator">
                                <h6 class="mb-3">
                                    <i class="fas fa-calculator me-2"></i>Calculadora de Precios
                                </h6>
                                
                                <div class="price-row">
                                    <span>Precio Base:</span>
                                    <span id="calc-precio-base">$0.00</span>
                                </div>
                                
                                <div class="price-row">
                                    <span>Mano de Obra:</span>
                                    <span id="calc-mano-obra">$0.00</span>
                                </div>
                                
                                <div class="price-row">
                                    <span>Subtotal:</span>
                                    <span id="calc-subtotal">$0.00</span>
                                </div>
                                
                                <div class="price-row">
                                    <span>IVA (12%):</span>
                                    <span id="calc-iva">$0.00</span>
                                </div>
                                
                                <div class="price-row">
                                    <span>PRECIO TOTAL:</span>
                                    <span id="calc-total">$0.00</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="feature-toggle" id="ivaToggle">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">¿Incluye IVA?</h6>
                                        <small class="text-muted">El precio ya incluye el IVA</small>
                                    </div>
                                    <label class="switch">
                                        {{ form.incluye_iva }}
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="feature-toggle" id="activoToggle">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Servicio Activo</h6>
                                        <small class="text-muted">Disponible para venta</small>
                                    </div>
                                    <label class="switch">
                                        {{ form.activo }}
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Requisitos Técnicos -->
                <div class="section-card animate-fade-in">
                    <div class="section-header">
                        <h4 class="section-title">
                            <i class="fas fa-tools text-primary"></i>
                            Requisitos Técnicos
                        </h4>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-floating">
                                {{ form.requiere_especialidad }}
                                <label for="{{ form.requiere_especialidad.id_for_label }}">Especialidad Requerida</label>
                            </div>
                            <div class="help-text">Especialización técnica necesaria</div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="feature-toggle" id="repuestosToggle">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">¿Requiere Repuestos?</h6>
                                        <small class="text-muted">El servicio necesita repuestos adicionales</small>
                                    </div>
                                    <label class="switch">
                                        {{ form.requiere_repuestos }}
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Columna Lateral -->
            <div class="col-lg-4">
                <!-- Preview del Servicio -->
                <div class="preview-card animate-fade-in">
                    <h6 class="mb-3">
                        <i class="fas fa-eye me-2"></i>
                        Vista Previa
                    </h6>
                    
                    <div class="preview-icon" id="previewIcon">
                        <i class="fas fa-cog"></i>
                    </div>
                    
                    <h5 id="previewNombre">{{ object.nombre|default:"Nombre del Servicio" }}</h5>
                    <p class="mb-2" id="previewCodigo">{{ object.codigo|default:"CODIGO" }}</p>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Precio Total:</span>
                            <strong id="previewPrecio">${{ object.get_precio_total|default:"0.00" }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <span>Tiempo:</span>
                            <span id="previewTiempo">{{ object.tiempo_estimado_horas|default:"0" }}h</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Dificultad:</span>
                            <span id="previewDificultad">{{ object.get_nivel_dificultad_display|default:"Básico" }}</span>
                        </div>
                    </div>
                    
                    <p class="small opacity-75" id="previewDescripcion">
                        {{ object.descripcion|default:"Descripción del servicio..." }}
                    </p>
                </div>
                
                <!-- Botones de Acción -->
                <div class="d-grid gap-2 mt-3">
                    <button type="submit" class="btn btn-primary btn-action">
                        <i class="fas fa-save me-2"></i>
                        {% if object %}Actualizar Servicio{% else %}Crear Servicio{% endif %}
                    </button>
                    
                    {% if object %}
                    <button type="button" class="btn btn-outline-success" onclick="probarEnPOS()">
                        <i class="fas fa-cash-register me-2"></i>Probar en POS
                    </button>
                    {% endif %}
                    
                    <button type="button" class="btn btn-outline-info" onclick="previsualizarFactura()">
                        <i class="fas fa-eye me-2"></i>Previsualizar
                    </button>
                    
                    <a href="{% url 'taller:tipo_servicio_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Modal para Nueva Categoría -->
<div class="modal fade" id="modalNuevaCategoria" tabindex="-1" aria-labelledby="modalNuevaCategoriaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalNuevaCategoriaLabel">
                    <i class="fas fa-folder-plus me-2"></i>
                    Nueva Categoría de Servicio
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formNuevaCategoria">
                    {% csrf_token %}
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-floating quick-form-field">
                                <input type="text" class="form-control" id="categoriaNombre" name="nombre" required>
                                <label for="categoriaNombre">Nombre de la Categoría *</label>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-floating quick-form-field">
                                <input type="text" class="form-control" id="categoriaCodigo" name="codigo" required>
                                <label for="categoriaCodigo">Código *</label>
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-magic me-1"></i>
                                <span class="link-primary" onclick="generarCodigoCategoria()" style="cursor: pointer;">Auto-generar código</span>
                            </small>
                        </div>
                        
                        <div class="col-12">
                            <div class="form-floating quick-form-field">
                                <textarea class="form-control" id="categoriaDescripcion" name="descripcion" style="height: 80px;"></textarea>
                                <label for="categoriaDescripcion">Descripción</label>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Color de la Categoría</label>
                            <input type="color" class="form-control form-control-color" id="categoriaColor" name="color" value="#007bff">
                            
                            <div class="color-picker-container">
                                <div class="color-option" style="background-color: #007bff;" onclick="seleccionarColor('#007bff')"></div>
                                <div class="color-option" style="background-color: #28a745;" onclick="seleccionarColor('#28a745')"></div>
                                <div class="color-option" style="background-color: #dc3545;" onclick="seleccionarColor('#dc3545')"></div>
                                <div class="color-option" style="background-color: #ffc107;" onclick="seleccionarColor('#ffc107')"></div>
                                <div class="color-option" style="background-color: #6f42c1;" onclick="seleccionarColor('#6f42c1')"></div>
                                <div class="color-option" style="background-color: #fd7e14;" onclick="seleccionarColor('#fd7e14')"></div>
                                <div class="color-option" style="background-color: #20c997;" onclick="seleccionarColor('#20c997')"></div>
                                <div class="color-option" style="background-color: #6c757d;" onclick="seleccionarColor('#6c757d')"></div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="categoriaRequiereDiagnostico" name="requiere_diagnostico">
                                <label class="form-check-label" for="categoriaRequiereDiagnostico">
                                    Requiere Diagnóstico Previo
                                </label>
                            </div>
                            
                            <div class="mt-2">
                                <div class="form-floating">
                                    <input type="number" class="form-control" id="categoriaTiempoEstimado" name="tiempo_estimado_horas" step="0.25" min="0">
                                    <label for="categoriaTiempoEstimado">Tiempo Estimado (horas)</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        La nueva categoría estará disponible inmediatamente después de crearla.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="crearCategoria()">
                    <div class="loading-spinner me-2"></div>
                    <i class="fas fa-save me-2"></i>
                    Crear Categoría
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar calculadora
    updateCalculator();
    updatePreview();
    
    // Event listeners para cálculo automático
    document.getElementById('id_precio_base').addEventListener('input', updateCalculator);
    document.getElementById('id_precio_mano_obra').addEventListener('input', updateCalculator);
    document.getElementById('id_incluye_iva').addEventListener('change', updateCalculator);
    
    // Event listeners para preview
    document.getElementById('id_nombre').addEventListener('input', updatePreview);
    document.getElementById('id_codigo').addEventListener('input', updatePreview);
    document.getElementById('id_descripcion').addEventListener('input', updatePreview);
    document.getElementById('id_tiempo_estimado_horas').addEventListener('input', updatePreview);
    document.getElementById('id_nivel_dificultad').addEventListener('change', updatePreview);
    document.getElementById('id_categoria').addEventListener('change', updatePreview);
    
    // Toggle switches
    document.querySelectorAll('.feature-toggle input[type="checkbox"]').forEach(toggle => {
        toggle.addEventListener('change', function() {
            const parent = this.closest('.feature-toggle');
            if (this.checked) {
                parent.classList.add('active');
            } else {
                parent.classList.remove('active');
            }
        });
        
        // Inicializar estado
        if (toggle.checked) {
            toggle.closest('.feature-toggle').classList.add('active');
        }
    });
    
    // Auto-generar código de categoría cuando se escribe el nombre
    document.getElementById('categoriaNombre').addEventListener('input', function() {
        const codigo = document.getElementById('categoriaCodigo');
        if (!codigo.value) {
            generarCodigoCategoria();
        }
    });
});

function updateCalculator() {
    const precioBase = parseFloat(document.getElementById('id_precio_base').value) || 0;
    const manoObra = parseFloat(document.getElementById('id_precio_mano_obra').value) || 0;
    const incluyeIva = document.getElementById('id_incluye_iva').checked;
    
    const subtotal = precioBase + manoObra;
    const iva = incluyeIva ? 0 : subtotal * 0.12;
    const total = subtotal + iva;
    
    // Actualizar display
    document.getElementById('calc-precio-base').textContent = `${precioBase.toFixed(2)}`;
    document.getElementById('calc-mano-obra').textContent = `${manoObra.toFixed(2)}`;
    document.getElementById('calc-subtotal').textContent = `${subtotal.toFixed(2)}`;
    document.getElementById('calc-iva').textContent = `${iva.toFixed(2)}`;
    document.getElementById('calc-total').textContent = `${total.toFixed(2)}`;
    
    // Actualizar preview
    document.getElementById('previewPrecio').textContent = `${total.toFixed(2)}`;
}

function updatePreview() {
    const nombre = document.getElementById('id_nombre').value || 'Nombre del Servicio';
    const codigo = document.getElementById('id_codigo').value || 'CODIGO';
    const descripcion = document.getElementById('id_descripcion').value || 'Descripción del servicio...';
    const tiempo = document.getElementById('id_tiempo_estimado_horas').value || '0';
    const dificultad = document.getElementById('id_nivel_dificultad').selectedOptions[0]?.text || 'Básico';
    const categoria = document.getElementById('id_categoria').selectedOptions[0]?.text || '';
    
    // Actualizar textos
    document.getElementById('previewNombre').textContent = nombre;
    document.getElementById('previewCodigo').textContent = codigo;
    document.getElementById('previewDescripcion').textContent = descripcion;
    document.getElementById('previewTiempo').textContent = `${tiempo}h`;
    document.getElementById('previewDificultad').textContent = dificultad;
    
    // Actualizar icono basado en categoría
    const iconElement = document.querySelector('#previewIcon i');
    if (categoria.toUpperCase().includes('MANTENIMIENTO')) {
        iconElement.className = 'fas fa-tools';
    } else if (categoria.toUpperCase().includes('REPARACION')) {
        iconElement.className = 'fas fa-wrench';
    } else if (categoria.toUpperCase().includes('DIAGNOSTICO')) {
        iconElement.className = 'fas fa-search';
    } else if (categoria.toUpperCase().includes('ELECTRICO')) {
        iconElement.className = 'fas fa-bolt';
    } else {
        iconElement.className = 'fas fa-cog';
    }
    
    // Actualizar preview de dificultad
    const difficultyValue = document.getElementById('id_nivel_dificultad').value;
    const difficultyPreview = document.getElementById('difficultyPreview');
    difficultyPreview.className = `difficulty-preview difficulty-${difficultyValue.toLowerCase()}`;
    difficultyPreview.textContent = dificultad;
}

function generarCodigo() {
    const nombre = document.getElementById('id_nombre').value;
    const categoria = document.getElementById('id_categoria').selectedOptions[0]?.text || '';
    
    if (!nombre) {
        alert('Primero ingrese el nombre del servicio');
        return;
    }
    
    // Generar código basado en categoría y nombre
    let prefijo = 'SERV';
    
    if (categoria.toUpperCase().includes('MANTENIMIENTO')) {
        prefijo = 'MANT';
    } else if (categoria.toUpperCase().includes('REPARACION')) {
        prefijo = 'REP';
    } else if (categoria.toUpperCase().includes('DIAGNOSTICO')) {
        prefijo = 'DIAG';
    } else if (categoria.toUpperCase().includes('ELECTRICO')) {
        prefijo = 'ELEC';
    }
    
    // Tomar primeras letras del nombre
    const nombreCorto = nombre.substring(0, 3).toUpperCase();
    
    // Generar número aleatorio
    const numero = Math.floor(Math.random() * 900) + 100;
    
    const codigoGenerado = `${prefijo}-${nombreCorto}${numero}`;
    
    document.getElementById('id_codigo').value = codigoGenerado;
    updatePreview();
}

function generarCodigoCategoria() {
    const nombre = document.getElementById('categoriaNombre').value;
    if (!nombre) return;
    
    // Tomar primeras 4 letras del nombre
    let codigo = nombre.substring(0, 4).toUpperCase();
    
    // Agregar número aleatorio si es muy corto
    if (codigo.length < 3) {
        codigo += Math.floor(Math.random() * 90) + 10;
    }
    
    document.getElementById('categoriaCodigo').value = codigo;
}

function seleccionarColor(color) {
    document.getElementById('categoriaColor').value = color;
    
    // Actualizar selección visual
    document.querySelectorAll('.color-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    document.querySelector(`[style*="${color}"]`).classList.add('selected');
}

async function crearCategoria() {
    const form = document.getElementById('formNuevaCategoria');
    const formData = new FormData(form);
    const loadingSpinner = document.querySelector('.loading-spinner');
    const saveButton = document.querySelector('.modal-footer .btn-primary');
    
    // Validar campos requeridos
    const nombre = document.getElementById('categoriaNombre').value.trim();
    const codigo = document.getElementById('categoriaCodigo').value.trim();
    
    if (!nombre || !codigo) {
        alert('Por favor complete los campos obligatorios: Nombre y Código');
        return;
    }
    
    // Mostrar loading
    loadingSpinner.style.display = 'inline-block';
    saveButton.disabled = true;
    
    try {
        const response = await fetch('/taller/categoria/crear-ajax/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Agregar nueva opción al select
            const categoriaSelect = document.getElementById('id_categoria');
            const newOption = document.createElement('option');
            newOption.value = data.categoria.id;
            newOption.textContent = data.categoria.nombre;
            newOption.selected = true;
            
            categoriaSelect.appendChild(newOption);
            
            // Cerrar modal y mostrar mensaje de éxito
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalNuevaCategoria'));
            modal.hide();
            
            // Limpiar formulario
            form.reset();
            document.getElementById('categoriaColor').value = '#007bff';
            
            // Actualizar preview
            updatePreview();
            
            // Mostrar notificación de éxito
            mostrarNotificacion('Categoría creada exitosamente', 'success');
            
        } else {
            throw new Error(data.message || 'Error al crear la categoría');
        }
        
    } catch (error) {
        console.error('Error:', error);
        mostrarNotificacion(error.message || 'Error al crear la categoría', 'error');
    } finally {
        // Ocultar loading
        loadingSpinner.style.display = 'none';
        saveButton.disabled = false;
    }
}

function mostrarNotificacion(mensaje, tipo = 'info') {
    // Crear elemento de notificación
    const notificacion = document.createElement('div');
    notificacion.className = `alert alert-${tipo === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notificacion.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    
    notificacion.innerHTML = `
        <i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notificacion);
    
    // Auto-remover después de 5 segundos
    setTimeout(() => {
        if (notificacion.parentNode) {
            notificacion.remove();
        }
    }, 5000);
}

function probarEnPOS() {
    const servicioId = '{{ object.pk }}';
    if (servicioId && servicioId !== 'None') {
        const posUrl = `/ventas/punto-venta/?servicio=${servicioId}`;
        window.open(posUrl, 'pos', 'width=1400,height=900');
    } else {
        alert('Primero debe guardar el servicio para probarlo en POS');
    }
}

function previsualizarFactura() {
    // Crear preview modal o abrir en nueva ventana
    const previewData = {
        nombre: document.getElementById('id_nombre').value,
        codigo: document.getElementById('id_codigo').value,
        precio: document.getElementById('calc-total').textContent,
        tiempo: document.getElementById('id_tiempo_estimado_horas').value
    };
    
    // Aquí podrías abrir un modal o nueva ventana con preview
    alert(`Preview: ${previewData.nombre} - ${previewData.precio} - ${previewData.tiempo}h`);
}

// Validación antes de enviar
document.getElementById('servicioForm').addEventListener('submit', function(e) {
    const requiredFields = ['id_nombre', 'id_codigo', 'id_precio_base', 'id_precio_mano_obra', 'id_tiempo_estimado_horas'];
    let isValid = true;
    
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (!field.value.trim()) {
            field.classList.add('is-invalid');
            isValid = false;
        } else {
            field.classList.remove('is-invalid');
        }
    });
    
    if (!isValid) {
        e.preventDefault();
        alert('Por favor complete todos los campos requeridos.');
    }
});

// Limpiar modal cuando se cierre
document.getElementById('modalNuevaCategoria').addEventListener('hidden.bs.modal', function() {
    document.getElementById('formNuevaCategoria').reset();
    document.getElementById('categoriaColor').value = '#007bff';
    document.querySelectorAll('.color-option').forEach(option => {
        option.classList.remove('selected');
    });
});