{% extends 'base.html' %}

{% block title %}Dashboard de Reportes - VPMOTOS{% endblock %}

{% block extra_css %}
<style>
    /* ========== VARIABLES CSS ========== */
    :root {
        --primary-gradient: linear-gradient(135deg, var(--primary) 0%, var(--info) 100%);
        --success-gradient: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        --warning-gradient: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        --danger-gradient: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        --card-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        --card-shadow-hover: 0 8px 25px rgba(0, 0, 0, 0.15);
        --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --border-radius-lg: 12px;
    }

    /* ========== LAYOUT GENERAL ========== */
    .content-wrapper {
        padding: 1.5rem;
        background-color: var(--light);
        min-height: 100vh;
    }

    .section-header {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--gray-200);
    }

    .section-title {
        font-weight: 600;
        color: var(--gray-800);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin: 0;
    }

    /* ========== TARJETAS DE ESTADÍSTICAS ========== */
    .stats-card {
        background: linear-gradient(135deg, white 0%, #f8f9fa 100%);
        border-radius: var(--border-radius-lg);
        border: 1px solid var(--gray-200);
        padding: 2rem;
        transition: var(--transition-smooth);
        position: relative;
        overflow: hidden;
        height: 100%;
    }

    .stats-card.revenue {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    }

    .stats-card.expenses {
        background: linear-gradient(135deg, #fff3e0 0%, #ffcc02 20%);
    }

    .stats-card.profit {
        background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
    }

    .stats-card.cash {
        background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
    }

    .stats-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
    }

    .stats-card.revenue::before {
        background: var(--primary-gradient);
    }

    .stats-card.expenses::before {
        background: var(--warning-gradient);
    }

    .stats-card.profit::before {
        background: var(--success-gradient);
    }

    .stats-card.cash::before {
        background: var(--danger-gradient);
    }

    .stats-card:hover {
        transform: translateY(-8px);
        box-shadow: var(--card-shadow-hover);
        border-color: var(--primary);
    }

    .stats-icon {
        width: 70px;
        height: 70px;
        background: var(--primary-gradient);
        color: white;
        border-radius: var(--border-radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
        margin-bottom: 1.5rem;
        animation: float 3s ease-in-out infinite;
    }

    .stats-icon.revenue {
        background: var(--primary-gradient);
    }

    .stats-icon.expenses {
        background: var(--warning-gradient);
    }

    .stats-icon.profit {
        background: var(--success-gradient);
    }

    .stats-icon.cash {
        background: var(--danger-gradient);
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-5px); }
    }

    .stats-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 0.5rem;
    }

    .stats-label {
        color: var(--gray-600);
        font-size: 0.95rem;
        font-weight: 500;
        margin-bottom: 0.75rem;
    }

    .stats-meta {
        font-size: 0.85rem;
        color: var(--gray-500);
    }

    /* ========== TARJETA DE ESTADO DE CAJA ========== */
    .cash-status-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: var(--border-radius-lg);
        padding: 2rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }

    .cash-status-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E") repeat;
        animation: move 20s linear infinite;
        opacity: 0.1;
    }

    @keyframes move {
        0% { transform: translate(-50%, -50%); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }

    .cash-status-content {
        position: relative;
        z-index: 2;
    }

    .btn-close-cash {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        font-weight: 600;
        transition: var(--transition-smooth);
        backdrop-filter: blur(10px);
    }

    .btn-close-cash:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        color: white;
        transform: scale(1.05);
    }

    /* ========== ACCIONES RÁPIDAS ========== */
    .quick-actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .quick-action-btn {
        flex: 1;
        min-width: 160px;
        padding: 1rem 1.5rem;
        border-radius: var(--border-radius-lg);
        border: 2px solid var(--gray-200);
        background: linear-gradient(135deg, white 0%, #f8f9fa 100%);
        color: var(--gray-700);
        text-decoration: none;
        transition: var(--transition-smooth);
        text-align: center;
        font-weight: 500;
    }

    .quick-action-btn:hover {
        transform: translateY(-3px);
        box-shadow: var(--card-shadow);
        color: var(--primary);
        border-color: var(--primary);
        background: white;
    }

    /* ========== MAIN CARDS ========== */
    .main-card {
        background: white;
        border-radius: var(--border-radius-lg);
        border: 1px solid var(--gray-200);
        box-shadow: var(--card-shadow);
        overflow: hidden;
    }

    .main-card .card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, white 100%);
        border-bottom: 1px solid var(--gray-200);
        padding: 1.5rem;
    }

    .main-card .card-body {
        padding: 0;
    }

    /* ========== MOVIMIENTOS RECIENTES ========== */
    .movement-item {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--gray-200);
        transition: var(--transition-smooth);
        cursor: pointer;
    }

    .movement-item:hover {
        background-color: rgba(67, 97, 238, 0.05);
        padding-left: 2rem;
    }

    .movement-item:last-child {
        border-bottom: none;
    }

    .movement-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        margin-right: 1rem;
    }

    .movement-icon.income {
        background: rgba(40, 167, 69, 0.15);
        color: #28a745;
    }

    .movement-icon.expense {
        background: rgba(220, 53, 69, 0.15);
        color: #dc3545;
    }

    /* ========== ANIMACIONES ========== */
    .animate-fade-in {
        animation: fadeInUp 0.8s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
        .quick-actions {
            flex-direction: column;
            gap: 0.75rem;
        }

        .quick-action-btn {
            min-width: auto;
            width: 100%;
        }

        .stats-card {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
        }

        .stats-number {
            font-size: 2rem;
        }

        .content-wrapper {
            padding: 1rem;
        }

        .cash-status-card {
            padding: 1.5rem;
        }
    }

    /* ========== UTILIDADES ========== */
    .no-content {
        text-align: center;
        padding: 3rem 2rem;
        color: var(--gray-500);
    }

    .no-content i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .text-success-custom {
        color: #28a745 !important;
    }

    .text-danger-custom {
        color: #dc3545 !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid content-wrapper">
    <!-- ========== HEADER DEL DASHBOARD ========== -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="section-header animate-fade-in">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <div>
                        <h1 class="section-title">
                            <i class="fas fa-chart-line text-primary"></i>
                            Dashboard de Reportes
                        </h1>
                        <p class="text-muted mb-0 mt-2">
                            <i class="fas fa-calendar-day me-2"></i>
                            Control de ventas y gastos - {{ hoy|date:"d/m/Y" }}
                        </p>
                    </div>
                    <div class="quick-actions">
                        <a href="{% url 'reportes:crear_gasto' %}" class="quick-action-btn">
                            <i class="fas fa-plus-circle me-2"></i>Registrar Gasto
                        </a>
                        <a href="{% url 'reportes:estadisticas_ventas' %}" class="quick-action-btn">
                            <i class="fas fa-chart-bar me-2"></i>Estadísticas
                        </a>
                        <a href="{% url 'reportes:reportes_mensuales' %}" class="quick-action-btn">
                            <i class="fas fa-calendar-alt me-2"></i>Reportes
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== ESTADO DE CAJA ========== -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="cash-status-card animate-fade-in">
                <div class="cash-status-content">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <div>
                            <h3 class="mb-2">
                                <i class="fas fa-cash-register me-2"></i>
                                Estado de Caja - {{ hoy|date:"d/m/Y" }}
                            </h3>
                            <div class="row g-3">
                                <div class="col-auto">
                                    <h5 class="mb-1">Saldo Final</h5>
                                    <h4 class="mb-0">${{ cierre_hoy.saldo_final|floatformat:0|default:"0" }}</h4>
                                </div>
                                <div class="col-auto">
                                    <h6 class="mb-1">Ingresos</h6>
                                    <p class="mb-0">${{ cierre_hoy.total_ingresos|floatformat:0|default:"0" }}</p>
                                </div>
                                <div class="col-auto">
                                    <h6 class="mb-1">Gastos</h6>
                                    <p class="mb-0">${{ total_gastos_hoy|floatformat:0|default:"0" }}</p>
                                </div>
                                {% if cierre_hoy.diferencia_efectivo != 0 %}
                                <div class="col-auto">
                                    <h6 class="mb-1">Diferencia</h6>
                                    <p class="mb-0">
                                        <i class="fas fa-{% if cierre_hoy.diferencia_efectivo > 0 %}arrow-up{% else %}arrow-down{% endif %} me-1"></i>
                                        ${{ cierre_hoy.diferencia_efectivo|floatformat:2 }}
                                    </p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="text-end">
                            {% if cierre_hoy.estado == 'ABIERTO' %}
                                <a href="{% url 'reportes:caja_diaria' %}" class="btn btn-close-cash">
                                    <i class="fas fa-lock me-2"></i>
                                    Cerrar Caja
                                </a>
                            {% else %}
                                <span class="badge bg-light text-dark fs-6 px-3 py-2">
                                    <i class="fas fa-check-circle me-2"></i>
                                    Caja Cerrada
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ========== ESTADÍSTICAS PRINCIPALES ========== -->
    <div class="row g-4 mb-5">
        <div class="col-lg-3 col-md-6">
            <div class="stats-card revenue animate-fade-in">
                <div class="stats-icon revenue">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="d-flex justify-content-between align-items-end">
                    <div class="flex-grow-1">
                        <h3 class="stats-number" data-stat="ventas-hoy">${{ stats_hoy.total_ventas|floatformat:0 }}</h3>
                        <p class="stats-label">Ventas de Hoy</p>
                        <div class="stats-meta">
                            <i class="fas fa-shopping-cart me-1"></i>
                            {{ stats_hoy.cantidad_ventas }} transacciones
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="stats-card expenses animate-fade-in">
                <div class="stats-icon expenses">
                    <i class="fas fa-receipt"></i>
                </div>
                <div class="d-flex justify-content-between align-items-end">
                    <div class="flex-grow-1">
                        <h3 class="stats-number">${{ total_gastos_hoy|floatformat:0 }}</h3>
                        <p class="stats-label">Gastos de Hoy</p>
                        <div class="stats-meta">
                            {% if gastos_pendientes > 0 %}
                                <span class="badge bg-warning text-dark">{{ gastos_pendientes }} pendientes</span>
                            {% else %}
                                <i class="fas fa-check me-1"></i>Todos aprobados
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="stats-card profit animate-fade-in">
                <div class="stats-icon profit">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="d-flex justify-content-between align-items-end">
                    <div class="flex-grow-1">
                        <h3 class="stats-number">${{ stats_semana.total_ventas|floatformat:0 }}</h3>
                        <p class="stats-label">Ventas Semana</p>
                        <div class="stats-meta">
                            <i class="fas fa-calendar-week me-1"></i>
                            {{ stats_semana.cantidad_ventas }} ventas
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6">
            <div class="stats-card cash animate-fade-in">
                <div class="stats-icon cash">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="d-flex justify-content-between align-items-end">
                    <div class="flex-grow-1">
                        <h3 class="stats-number">${{ stats_mes.total_ventas|floatformat:0 }}</h3>
                        <p class="stats-label">Ventas del Mes</p>
                        <div class="stats-meta">
                            <i class="fas fa-trending-up me-1"></i>
                            {{ stats_mes.cantidad_ventas }} ventas
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ========== CONTENIDO PRINCIPAL ========== -->
    <div class="row g-4">
        <!-- MOVIMIENTOS RECIENTES -->
        <div class="col-xl-8 col-lg-7">
            <div class="main-card animate-fade-in">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="section-title mb-0">
                            <i class="fas fa-exchange-alt text-primary"></i>
                            Movimientos Recientes
                        </h5>
                        <a href="{% url 'reportes:lista_movimientos' %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye me-1"></i>Ver Todos
                        </a>
                    </div>
                </div>
                
                <div class="card-body">
                    <div style="max-height: 400px; overflow-y: auto;">
                        {% for movimiento in movimientos_recientes %}
                        <div class="movement-item">
                            <div class="d-flex align-items-center">
                                <div class="movement-icon {% if movimiento.es_ingreso %}income{% else %}expense{% endif %}">
                                    <i class="fas fa-{% if movimiento.es_ingreso %}arrow-up{% else %}arrow-down{% endif %}"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 fw-bold">{{ movimiento.concepto }}</h6>
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>
                                        {{ movimiento.hora|time:"H:i" }} - {{ movimiento.metodo_pago }}
                                    </small>
                                </div>
                                <div class="text-end">
                                    <h6 class="mb-0 {% if movimiento.es_ingreso %}text-success-custom{% else %}text-danger-custom{% endif %}">
                                        {% if movimiento.es_ingreso %}+{% else %}-{% endif %}${{ movimiento.monto|floatformat:0 }}
                                    </h6>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="no-content">
                            <i class="fas fa-exchange-alt"></i>
                            <h5>No hay movimientos registrados hoy</h5>
                            <p class="text-muted mb-0">Los movimientos aparecerán aquí conforme se realicen</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- PANEL LATERAL -->
        <div class="col-xl-4 col-lg-5">
            <!-- Top Días del Mes -->
            <div class="main-card mb-4 animate-fade-in">
                <div class="card-header">
                    <h5 class="section-title mb-0">
                        <i class="fas fa-trophy text-primary"></i>
                        Top Días del Mes
                    </h5>
                    <small class="text-muted">Mejores días de ventas</small>
                </div>
                <div class="card-body">
                    <div style="padding: 1rem;">
                        {% for dia in top_dias %}
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6 class="mb-1 fw-bold">{{ dia.dia|date:"d/m/Y" }}</h6>
                                <small class="text-muted">
                                    <i class="fas fa-shopping-bag me-1"></i>
                                    {{ dia.cantidad }} ventas
                                </small>
                            </div>
                            <div class="text-end">
                                <h6 class="mb-0 text-success-custom">${{ dia.total_dia|floatformat:0 }}</h6>
                            </div>
                        </div>
                        {% empty %}
                        <div class="no-content py-3">
                            <i class="fas fa-chart-bar"></i>
                            <p class="text-muted mb-0">No hay datos del mes</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Acciones Rápidas -->
            <div class="main-card animate-fade-in">
                <div class="card-header">
                    <h5 class="section-title mb-0">
                        <i class="fas fa-bolt text-primary"></i>
                        Acciones Rápidas
                    </h5>
                    <small class="text-muted">Gestión financiera</small>
                </div>
                <div class="card-body" style="padding: 1.5rem;">
                    <div class="d-grid gap-3">
                        <a href="{% url 'reportes:caja_diaria' %}" class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-cash-register me-2"></i>
                            Caja Diaria
                        </a>
                        
                        <a href="{% url 'reportes:crear_gasto' %}" class="btn btn-outline-warning btn-lg">
                            <i class="fas fa-plus me-2"></i>
                            Registrar Gasto
                        </a>
                        
                        <a href="{% url 'reportes:lista_gastos' %}" class="btn btn-outline-danger btn-lg">
                            <i class="fas fa-receipt me-2"></i>
                            Ver Gastos
                            {% if gastos_pendientes > 0 %}
                                <span class="badge bg-warning text-dark ms-2">{{ gastos_pendientes }}</span>
                            {% endif %}
                        </a>
                        
                        <a href="{% url 'reportes:estadisticas_ventas' %}" class="btn btn-outline-info btn-lg">
                            <i class="fas fa-chart-line me-2"></i>
                            Estadísticas
                        </a>
                        
                        <hr class="my-2">
                        
                        <div class="row g-2">
                            <div class="col-6">
                                <a href="{% url 'reportes:reportes_mensuales' %}" class="btn btn-outline-secondary w-100">
                                    <i class="fas fa-calendar-alt me-1"></i>
                                    Mensuales
                                </a>
                            </div>
                            <div class="col-6">
                                <a href="{% url 'reportes:exportar_reporte' %}" class="btn btn-outline-secondary w-100">
                                    <i class="fas fa-download me-1"></i>
                                    Exportar
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% csrf_token %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ========== VARIABLES GLOBALES ==========
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

// ========== FUNCIONES PRINCIPALES ==========

// Actualizar estadísticas en tiempo real
function actualizarEstadisticas() {
    fetch("{% url 'reportes:api_dashboard_data' %}", {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.ventas_7_dias) {
            // Actualizar gráficos si existen
            actualizarGraficos(data);
        }
    })
    .catch(error => console.error('Error al actualizar estadísticas:', error));
}

// Actualizar gráficos
function actualizarGraficos(data) {
    // Implementar actualización de gráficos Chart.js aquí
    console.log('Datos actualizados:', data);
}

// Verificar estado de caja
function verificarEstadoCaja() {
    fetch("{% url 'reportes:api_caja_status' %}", {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Estado de caja:', data);
        // Actualizar UI según estado de caja
    })
    .catch(error => console.error('Error al verificar caja:', error));
}

// Mostrar notificaciones
function mostrarNotificacion(mensaje, tipo = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${tipo === 'success' ? 'success' : 'danger'} position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
        ${mensaje}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

// ========== EVENT LISTENERS ==========
document.addEventListener('DOMContentLoaded', function() {
    // Actualizar estadísticas cada 5 minutos
    setInterval(actualizarEstadisticas, 300000);
    
    // Verificar estado de caja cada minuto
    setInterval(verificarEstadoCaja, 60000);
    
    // Animaciones de entrada
    const elements = document.querySelectorAll('.animate-fade-in');
    elements.forEach((el, index) => {
        el.style.animationDelay = `${index * 0.1}s`;
    });
    
    console.log('Dashboard de reportes cargado correctamente');
});
</script>
{% endblock %}