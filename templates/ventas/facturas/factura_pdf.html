<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Factura #{{ venta.numero_factura }}</title>
    <style>
        /* ========== VARIABLES Y RESET ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 11px;
            line-height: 1.3;
            color: #2c3e50;
            background: #ffffff;
        }

        /* ========== LAYOUT PRINCIPAL ========== */
        .invoice-container {
            max-width: 210mm;
            margin: 0 auto;
            padding: 15mm;
            background: white;
            min-height: 280mm;
            position: relative;
        }

        /* ========== HEADER COMPACTO ========== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #D2ED05;
        }

        .company-logo {
            flex: 1;
        }

        .company-name {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .company-tagline {
            font-size: 12px;
            color: #7f8c8d;
            font-style: italic;
            margin-bottom: 10px;
        }

        .company-details {
            font-size: 10px;
            color: #5d6d7e;
            line-height: 1.4;
        }

        .company-details strong {
            color: #2c3e50;
        }

        .invoice-header {
            flex: 1;
            text-align: right;
        }

        .invoice-title {
            background: linear-gradient(135deg, #D2ED05, #B8D104);
            color: #2c3e50;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            box-shadow: 0 3px 10px rgba(210, 237, 5, 0.3);
        }

        .invoice-meta {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #D2ED05;
        }

        .invoice-meta-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 10px;
        }

        .invoice-meta-item:last-child {
            margin-bottom: 0;
        }

        .invoice-meta-label {
            font-weight: 600;
            color: #5d6d7e;
        }

        .invoice-meta-value {
            font-weight: 700;
            color: #2c3e50;
        }

        /* ========== INFORMACIÓN DEL CLIENTE COMPACTA ========== */
        .client-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .section-title {
            font-size: 12px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: #D2ED05;
            margin-right: 8px;
            border-radius: 2px;
        }

        .client-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .info-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #5d6d7e;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-weight: 500;
            color: #2c3e50;
            text-align: right;
            font-size: 10px;
        }

        .client-name {
            font-size: 14px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        /* ========== TABLA DE PRODUCTOS COMPACTA ========== */
        .items-section {
            margin-bottom: 20px;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .items-table thead {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
        }

        .items-table th {
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .items-table th:last-child,
        .items-table td:last-child {
            text-align: right;
        }

        .items-table tbody tr {
            border-bottom: 1px solid #e9ecef;
        }

        .items-table tbody tr:last-child {
            border-bottom: none;
        }

        .items-table td {
            padding: 8px;
            vertical-align: middle;
            font-size: 10px;
        }

        .item-number {
            background: #D2ED05;
            color: #2c3e50;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 9px;
        }

        .item-description {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 2px;
            font-size: 10px;
        }

        .item-code {
            background: #ecf0f1;
            color: #7f8c8d;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 8px;
            font-family: 'Courier New', monospace;
        }

        .item-type {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 8px;
            font-weight: 600;
            text-transform: uppercase;
            margin-top: 2px;
        }

        .type-product {
            background: rgba(210, 237, 5, 0.2);
            color: #8B9A02;
        }

        .type-service {
            background: rgba(52, 152, 219, 0.2);
            color: #2980b9;
        }

        .quantity-cell {
            text-align: center;
            font-weight: 600;
            color: #2c3e50;
        }

        .price-cell {
            font-weight: 600;
            color: #27ae60;
            text-align: right;
        }

        /* ========== TOTALES COMPACTOS ========== */
        .totals-section {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
        }

        .totals-container {
            width: 280px;
        }

        .totals-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .totals-table tr {
            border-bottom: 1px solid #e9ecef;
        }

        .totals-table tr:last-child {
            border-bottom: none;
        }

        .totals-table th,
        .totals-table td {
            padding: 8px 12px;
            text-align: right;
            font-size: 10px;
        }

        .totals-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #5d6d7e;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .totals-table td {
            font-weight: 600;
            color: #2c3e50;
        }

        .total-row {
            background: linear-gradient(135deg, #D2ED05, #B8D104) !important;
            color: #2c3e50 !important;
        }

        .total-row th,
        .total-row td {
            color: #2c3e50 !important;
            font-size: 12px;
            font-weight: 700;
            padding: 12px;
        }

        .discount-row {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        /* ========== INFORMACIÓN ADICIONAL COMPACTA ========== */
        .additional-info {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            margin: 15px 0;
            border-left: 4px solid #D2ED05;
        }

        .additional-info h4 {
            color: #8B9A02;
            font-size: 11px;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .additional-info p {
            color: #5d6d7e;
            font-size: 9px;
            line-height: 1.4;
            margin-bottom: 4px;
        }

        /* ========== FOOTER COMPACTO ========== */
        .footer {
            position: absolute;
            bottom: 15mm;
            left: 15mm;
            right: 15mm;
            padding-top: 15px;
            border-top: 2px solid #e9ecef;
            text-align: center;
        }

        .footer-message {
            font-size: 12px;
            color: #2c3e50;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .footer-meta {
            font-size: 9px;
            color: #7f8c8d;
            font-style: italic;
        }

        .footer-legal {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e9ecef;
            font-size: 8px;
            color: #95a5a6;
            line-height: 1.4;
        }

        /* ========== LÍNEA DECORATIVA ========== */
        .decorative-line {
            height: 2px;
            background: linear-gradient(90deg, #D2ED05, #B8D104, #D2ED05);
            margin: 15px 0;
            border-radius: 1px;
        }

        /* ========== QR CODE COMPACTO ========== */
        .qr-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .qr-code {
            width: 40px;
            height: 40px;
            background: #2c3e50;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 8px;
            text-align: center;
            font-weight: 600;
        }

        .qr-info {
            font-size: 9px;
            color: #5d6d7e;
            line-height: 1.3;
        }

        /* ========== MARCA DE AGUA ========== */
        .watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 100px;
            color: rgba(210, 237, 5, 0.03);
            font-weight: 900;
            z-index: -1;
            text-transform: uppercase;
            letter-spacing: 15px;
        }

        /* ========== ESTADOS ESPECIALES ========== */
        .invoice-paid {
            position: relative;
        }

        .invoice-paid::after {
            content: 'PAGADO';
            position: absolute;
            top: 25%;
            right: -15px;
            transform: rotate(15deg);
            background: #27ae60;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 12px;
            letter-spacing: 2px;
            box-shadow: 0 3px 10px rgba(39, 174, 96, 0.3);
        }

        .invoice-cancelled::after {
            content: 'ANULADA';
            background: #e74c3c;
            box-shadow: 0 3px 10px rgba(231, 76, 60, 0.3);
        }

        /* ========== RESPONSIVE PARA IMPRESIÓN ========== */
        @media print {
            .invoice-container {
                box-shadow: none;
                margin: 0;
                padding: 10mm;
                min-height: auto;
            }
            
            body {
                background: white;
            }
            
            .watermark {
                display: none;
            }

            .footer {
                position: static;
                margin-top: 20px;
            }
        }

        /* ========== TABLA RESPONSIVE ========== */
        @media (max-width: 768px) {
            .client-info {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .invoice-header {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <!-- Marca de agua -->
    <div class="watermark">VPMOTOS</div>
    
    <div class="invoice-container {% if venta.estado == 'COMPLETADA' %}invoice-paid{% elif venta.estado == 'ANULADA' %}invoice-cancelled{% endif %}">
        
        <!-- Header -->
        <div class="header">
            <div class="company-logo">
                <div class="company-name">VPMOTOS</div>
                <div class="company-tagline">Venta de Repuestos y Servicio Técnico para Motocicletas</div>
                <div class="company-details">
                    <strong>Dirección:</strong> Ecuador Pichincha Cayambe Panamericana E35<br>
                    <strong>Teléfono:</strong> 0996628440<br>
                    <strong>Email:</strong> info@vpmotos.com<br>
                    <strong>RUC:</strong> 1719249326001
                </div>
            </div>
            
            <div class="invoice-header">
                <div class="invoice-title">
                    Factura N° {{ venta.numero_factura }}
                </div>
                <div class="invoice-meta">
                    <div class="invoice-meta-item">
                        <span class="invoice-meta-label">Fecha:</span>
                        <span class="invoice-meta-value">{{ venta.fecha_hora|date:"d/m/Y" }}</span>
                    </div>
                    <div class="invoice-meta-item">
                        <span class="invoice-meta-label">Hora:</span>
                        <span class="invoice-meta-value">{{ venta.fecha_hora|date:"H:i" }}</span>
                    </div>
                    <div class="invoice-meta-item">
                        <span class="invoice-meta-label">Estado:</span>
                        <span class="invoice-meta-value">{{ venta.get_estado_display }}</span>
                    </div>
                    <div class="invoice-meta-item">
                        <span class="invoice-meta-label">Vendedor:</span>
                        <span class="invoice-meta-value">{{ venta.usuario.get_full_name|default:venta.usuario.username }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Línea decorativa -->
        <div class="decorative-line"></div>

        <!-- Información del Cliente -->
        <div class="client-section">
            <div class="section-title">Información del Cliente</div>
            
            <div class="client-name">
                {% if venta.cliente.identificacion == '9999999999' %}
                    CONSUMIDOR FINAL
                {% else %}
                    {{ venta.cliente.nombres }} {{ venta.cliente.apellidos }}
                {% endif %}
            </div>
            
            <div class="client-info">
                <div class="info-group">
                    <div class="info-item">
                        <span class="info-label">Cédula:</span>
                        <span class="info-value">{{ venta.cliente.identificacion|default:"9999999999" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Dirección:</span>
                        <span class="info-value">{{ venta.cliente.direccion|default:"-" }}</span>
                    </div>
                </div>
                
                <div class="info-group">
                    <div class="info-item">
                        <span class="info-label">Teléfono:</span>
                        <span class="info-value">{{ venta.cliente.telefono|default:"-" }}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Método de Pago:</span>
                        <span class="info-value">{{ venta.get_tipo_pago_display }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Información adicional de orden de trabajo -->
        {% if venta.orden_trabajo %}
        <div class="additional-info">
            <h4>Información de Servicio</h4>
            <p><strong>Orden:</strong> #{{ venta.orden_trabajo.numero_orden }} | <strong>Vehículo:</strong> {{ venta.orden_trabajo.moto_marca }} {{ venta.orden_trabajo.moto_modelo }} - {{ venta.orden_trabajo.moto_placa }}</p>
            {% if venta.orden_trabajo.motivo_ingreso %}
            <p><strong>Motivo:</strong> {{ venta.orden_trabajo.motivo_ingreso|truncatewords:15 }}</p>
            {% endif %}
        </div>
        {% endif %}

        <!-- Tabla de Items -->
        <div class="items-section">
            <div class="section-title">Detalle de la Factura</div>
            
            <table class="items-table">
                <thead>
                    <tr>
                        <th width="5%">N°</th>
                        <th width="45%">Descripción</th>
                        <th width="8%">Cant.</th>
                        <th width="12%">P. Unit.</th>
                        <th width="12%">Subtotal</th>
                        <th width="10%">IVA</th>
                        <th width="12%">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% if detalles %}
                        {% for detalle in detalles %}
                        <tr>
                            <td>
                                <div class="item-number">{{ forloop.counter }}</div>
                            </td>
                            <td>
                                <div class="item-description">
                                    {% if detalle.producto %}
                                        {{ detalle.producto.nombre }}
                                        <div class="item-type type-product">Producto</div>
                                        {% if detalle.producto.codigo_unico %}
                                            <div class="item-code">{{ detalle.producto.codigo_unico }}</div>
                                        {% endif %}
                                    {% elif detalle.tipo_servicio %}
                                        {{ detalle.tipo_servicio.nombre }}
                                        <div class="item-type type-service">Servicio</div>
                                        {% if detalle.tecnico %}
                                            <div style="font-size: 8px; color: #7f8c8d; margin-top: 2px;">
                                                Técnico: {{ detalle.tecnico.get_nombre_completo }}
                                            </div>
                                        {% endif %}
                                    {% elif detalle.servicio %}
                                        {{ detalle.servicio.nombre }}
                                        <div class="item-type type-service">Servicio</div>
                                    {% else %}
                                        {{ detalle.get_nombre_item }}
                                        <div class="item-type type-product">Item</div>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="quantity-cell">{{ detalle.cantidad|floatformat:0 }}</td>
                            <td class="price-cell">${{ detalle.precio_unitario|floatformat:2 }}</td>
                            <td class="price-cell">${{ detalle.subtotal|floatformat:2 }}</td>
                            <td class="price-cell">${{ detalle.iva|floatformat:2 }}</td>
                            <td class="price-cell"><strong>${{ detalle.total|floatformat:2 }}</strong></td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        {% for detalle in venta.detalleventa_set.all %}
                        <tr>
                            <td>
                                <div class="item-number">{{ forloop.counter }}</div>
                            </td>
                            <td>
                                <div class="item-description">
                                    {% if detalle.producto %}
                                        {{ detalle.producto.nombre }}
                                        <div class="item-type type-product">Producto</div>
                                        {% if detalle.producto.codigo_unico %}
                                            <div class="item-code">{{ detalle.producto.codigo_unico }}</div>
                                        {% endif %}
                                    {% elif detalle.tipo_servicio %}
                                        {{ detalle.tipo_servicio.nombre }}
                                        <div class="item-type type-service">Servicio</div>
                                        {% if detalle.tecnico %}
                                            <div style="font-size: 8px; color: #7f8c8d; margin-top: 2px;">
                                                Técnico: {{ detalle.tecnico.get_nombre_completo }}
                                            </div>
                                        {% endif %}
                                    {% elif detalle.servicio %}
                                        {{ detalle.servicio.nombre }}
                                        <div class="item-type type-service">Servicio</div>
                                    {% else %}
                                        {{ detalle.get_nombre_item }}
                                        <div class="item-type type-product">Item</div>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="quantity-cell">{{ detalle.cantidad|floatformat:0 }}</td>
                            <td class="price-cell">${{ detalle.precio_unitario|floatformat:2 }}</td>
                            <td class="price-cell">${{ detalle.subtotal|floatformat:2 }}</td>
                            <td class="price-cell">${{ detalle.iva|floatformat:2 }}</td>
                            <td class="price-cell"><strong>${{ detalle.total|floatformat:2 }}</strong></td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 20px; color: #7f8c8d;">
                                No hay items registrados en esta factura
                            </td>
                        </tr>
                        {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>

        <!-- Observaciones -->
        {% if venta.observaciones %}
        <div class="additional-info">
            <h4>Observaciones</h4>
            <p>{{ venta.observaciones }}</p>
        </div>
        {% endif %}

        <!-- Totales -->
        <div class="totals-section">
            <div class="totals-container">
                <table class="totals-table">
                    <tr>
                        <th>Subtotal (Sin IVA):</th>
                        <td>${{ venta.subtotal|floatformat:2 }}</td>
                    </tr>
                    <tr>
                        <th>IVA (15%):</th>
                        <td>${{ venta.iva|floatformat:2 }}</td>
                    </tr>
                    {% if venta.descuento and venta.descuento > 0 %}
                    <tr class="discount-row">
                        <th>Descuento:</th>
                        <td>-${{ venta.descuento|floatformat:2 }}</td>
                    </tr>
                    {% endif %}
                    <tr class="total-row">
                        <th>TOTAL A PAGAR:</th>
                        <td>${{ venta.total|floatformat:2 }}</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <div class="footer-message">
                ¡Gracias por confiar en VPMOTOS!
            </div>
            <div class="footer-meta">
                Documento generado electrónicamente el {{ venta.fecha_hora|date:"d/m/Y" }} a las {{ venta.fecha_hora|date:"H:i:s" }}
            </div>
            <div class="footer-legal">
                Este documento constituye una factura válida según la normativa tributaria vigente. 
                Para cualquier consulta o reclamo, contáctenos a través de nuestros canales oficiales.
                <br><strong>VPMOTOS</strong> - RUC: 1719249326001
            </div>
        </div>
    </div>
</body>
</html>