{% extends 'base.html' %}

{% block breadcrumb_page %}
<li class="breadcrumb-item active">Productos</li>
{% endblock %}

{% block inventory_content %}
<!-- Header con acciones principales -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h1 class="mb-0"><i class="fas fa-boxes text-primary"></i> Inventario de Productos</h1>
            <div class="d-flex gap-2 flex-wrap">
                <a href="{% url 'inventario:crear_producto' %}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i> Nuevo Producto
                </a>
                <a href="{% url 'inventario:transferencias_lista' %}" class="btn btn-secondary">
                    <i class="fas fa-exchange-alt me-1"></i> Transferencias
                </a>
                <a href="{% url 'inventario:importar_productos' %}" class="btn btn-success">
                    <i class="fas fa-file-upload me-1"></i> Importar
                </a>
                <a href="{% url 'inventario:exportar_productos' %}" class="btn btn-info text-white">
                    <i class="fas fa-file-download me-1"></i> Exportar
                </a>
                <a href="{% url 'inventario:imprimir_etiquetas' %}" class="btn btn-warning text-white">
                    <i class="fas fa-print me-1"></i> Etiquetas
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Menú de navegación secundario -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <div class="d-flex gap-2 flex-wrap">
                        <a href="{% url 'inventario:lista_categorias' %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-folder me-1"></i> Categorías
                        </a>
                        <a href="{% url 'inventario:lista_marcas' %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-trademark me-1"></i> Marcas
                        </a>
                        <a href="{% url 'inventario:lista_ajustes' %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-balance-scale me-1"></i> Ajustes
                        </a>
                        <a href="{% url 'inventario:transferencias_lista' %}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-exchange-alt me-1"></i> Transferencias
                        </a>
                    </div>
                    <div class="d-flex gap-2 flex-wrap">
                        <a href="{% url 'inventario:exportar_productos_csv' %}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-file-csv me-1"></i> CSV Completo
                        </a>
                        <a href="{% url 'inventario:csv_ejemplo' %}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-download me-1"></i> Plantilla
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estadísticas -->
<div class="row mb-4">
    <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="text-muted mb-1 small">Total Productos</p>
                        <h3 class="mb-0 fw-bold">{{ estadisticas.total_productos }}</h3>
                    </div>
                    <div class="bg-primary bg-opacity-10 text-primary rounded p-3">
                        <i class="fas fa-box fa-lg"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="text-muted mb-1 small">Stock Bajo</p>
                        <h3 class="mb-0 fw-bold text-warning">{{ estadisticas.productos_stock_bajo }}</h3>
                    </div>
                    <div class="bg-warning bg-opacity-10 text-warning rounded p-3">
                        <i class="fas fa-exclamation-triangle fa-lg"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="text-muted mb-1 small">Sin Stock</p>
                        <h3 class="mb-0 fw-bold text-danger">{{ estadisticas.productos_sin_stock }}</h3>
                    </div>
                    <div class="bg-danger bg-opacity-10 text-danger rounded p-3">
                        <i class="fas fa-times-circle fa-lg"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="text-muted mb-1 small">Categorías</p>
                        <h3 class="mb-0 fw-bold text-success">{{ estadisticas.categorias }}</h3>
                    </div>
                    <div class="bg-success bg-opacity-10 text-success rounded p-3">
                        <i class="fas fa-tags fa-lg"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <p class="text-muted mb-1 small">Marcas</p>
                        <h3 class="mb-0 fw-bold text-info">{{ estadisticas.marcas }}</h3>
                    </div>
                    <div class="bg-info bg-opacity-10 text-info rounded p-3">
                        <i class="fas fa-trademark fa-lg"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-2 col-lg-4 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100 border-primary border-2">
            <div class="card-body">
                <p class="text-muted mb-2 small">Acciones Rápidas</p>
                <div class="d-flex gap-1 flex-wrap">
                    <a href="{% url 'inventario:transferencias_lista' %}" class="btn btn-sm btn-secondary"
                        data-bs-toggle="tooltip" title="Transferencias entre sucursales">
                        <i class="fas fa-exchange-alt"></i>
                    </a>
                    <a href="{% url 'inventario:importar_productos' %}" class="btn btn-sm btn-success"
                        data-bs-toggle="tooltip" title="Importar productos">
                        <i class="fas fa-upload"></i>
                    </a>
                    <a href="{% url 'inventario:exportar_productos' %}" class="btn btn-sm btn-info text-white"
                        data-bs-toggle="tooltip" title="Exportar productos">
                        <i class="fas fa-download"></i>
                    </a>
                    <a href="{% url 'inventario:imprimir_etiquetas' %}" class="btn btn-sm btn-warning text-white"
                        data-bs-toggle="tooltip" title="Imprimir etiquetas">
                        <i class="fas fa-print"></i>
                    </a>
                    <a href="{% url 'inventario:lista_ajustes' %}" class="btn btn-sm btn-dark"
                        data-bs-toggle="tooltip" title="Ver ajustes">
                        <i class="fas fa-sliders-h"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="card shadow-sm mb-4 border-0">
    <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-filter text-primary me-2"></i> Filtros de Búsqueda
            </h5>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                data-bs-target="#filtrosCollapse" aria-expanded="true">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
    </div>
    <div class="collapse show" id="filtrosCollapse">
        <div class="card-body">
            <form method="get" id="searchForm">
                <div class="row g-3">
                    <div class="col-lg-4 col-md-6">
                        <label for="{{ form.busqueda.id_for_label }}" class="form-label fw-semibold">
                            <i class="fas fa-search text-primary me-1"></i> Buscar por nombre o código
                        </label>
                        {{ form.busqueda }}
                    </div>
                    <div class="col-lg-2 col-md-6">
                        <label for="{{ form.categoria.id_for_label }}" class="form-label fw-semibold">
                            <i class="fas fa-folder text-success me-1"></i> Categoría
                        </label>
                        {{ form.categoria }}
                    </div>
                    <div class="col-lg-2 col-md-6">
                        <label for="{{ form.marca.id_for_label }}" class="form-label fw-semibold">
                            <i class="fas fa-trademark text-info me-1"></i> Marca
                        </label>
                        {{ form.marca }}
                    </div>
                    <div class="col-lg-2 col-md-6">
                        <label for="{{ form.activo.id_for_label }}" class="form-label fw-semibold">
                            <i class="fas fa-toggle-on text-secondary me-1"></i> Estado
                        </label>
                        {{ form.activo }}
                    </div>
                    <div class="col-lg-2 col-md-12 d-flex align-items-end">
                        <div class="form-check form-switch">
                            {{ form.stock_bajo }}
                            <label class="form-check-label fw-semibold" for="{{ form.stock_bajo.id_for_label }}">
                                <i class="fas fa-exclamation-circle text-warning me-1"></i>
                                Solo stock bajo
                            </label>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-search me-1"></i> Buscar
                        </button>
                        <a href="{% url 'inventario:lista_productos' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i> Limpiar Filtros
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Tabla de Productos -->
<div class="card shadow-sm border-0">
    <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-list text-primary me-2"></i> Listado de Productos
            </h5>
            <span class="badge bg-primary fs-6">{{ productos.paginator.count }} productos</span>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th width="10%">Código</th>
                        <th width="8%">Imagen</th>
                        <th width="20%">Nombre</th>
                        <th width="12%">Categoría</th>
                        <th width="12%">Marca</th>
                        <th width="10%" class="text-end">P. Venta</th>
                        <th width="8%" class="text-center">Stock</th>
                        <th width="8%" class="text-center">Estado</th>
                        <th width="12%" class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for producto in productos %}
                    {% if producto.stock_actual == 0 %}
                    <tr class="table-danger">
                    {% elif producto.es_stock_bajo %}
                    <tr class="table-warning">
                    {% else %}
                    <tr>
                    {% endif %}
                        <td>
                            <code class="bg-light px-2 py-1 rounded">{{ producto.codigo_unico }}</code>
                        </td>
                        <td>
                            {% if producto.imagen %}
                            <img src="{{ producto.imagen.url }}" alt="{{ producto.nombre }}" class="img-thumbnail"
                                style="width: 50px; height: 50px; object-fit: cover;">
                            {% else %}
                            <span class="text-muted small"><i class="fas fa-image fa-2x opacity-25"></i></span>
                            {% endif %}
                        </td>
                        <td>
                            <div>
                                <div class="fw-semibold text-dark">{{ producto.nombre }}</div>
                                {% if producto.descripcion %}
                                <small class="text-muted d-block">{{ producto.descripcion|truncatewords:10 }}</small>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-success text-white">
                                {{ producto.categoria.nombre }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-info text-white">
                                {{ producto.marca.nombre }}
                            </span>
                        </td>
                        <td class="text-end">
                            <strong class="text-success fw-bold">${{ producto.precio_final|floatformat:2 }}</strong>
                        </td>
                        <td class="text-center">
                            {% if producto.stock_actual == 0 %}
                            <span class="badge bg-danger text-white">
                                <i class="fas fa-times me-1"></i>{{ producto.stock_actual }}
                            </span>
                            {% elif producto.es_stock_bajo %}
                            <span class="badge bg-warning text-white">
                                <i class="fas fa-exclamation-triangle me-1"></i>{{ producto.stock_actual }}
                            </span>
                            {% else %}
                            <span class="badge bg-success text-white">
                                {{ producto.stock_actual }}
                            </span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if producto.activo %}
                            <span class="badge bg-success text-white">
                                <i class="fas fa-check me-1"></i>Activo
                            </span>
                            {% else %}
                            <span class="badge bg-danger text-white">
                                <i class="fas fa-times me-1"></i>Inactivo
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{% url 'inventario:detalle_producto' producto.id %}"
                                    class="btn btn-info text-white" title="Ver detalles" data-bs-toggle="tooltip">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'inventario:editar_producto' producto.id %}" class="btn btn-primary"
                                    title="Editar" data-bs-toggle="tooltip">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <a href="{% url 'inventario:crear_ajuste' %}?producto_id={{ producto.id }}"
                                    class="btn btn-warning text-white" title="Ajustar stock" data-bs-toggle="tooltip">
                                    <i class="fas fa-sliders-h"></i>
                                </a>
                                <button type="button"
                                    class="btn btn-{% if producto.activo %}danger{% else %}success{% endif %} btn-toggle-estado"
                                    data-producto-id="{{ producto.id }}"
                                    data-producto-nombre="{{ producto.nombre }}"
                                    data-estado-actual="{{ producto.activo|yesno:'true,false' }}"
                                    title="{% if producto.activo %}Desactivar{% else %}Activar{% endif %}"
                                    data-bs-toggle="tooltip">
                                    <i class="fas {% if producto.activo %}fa-times{% else %}fa-check{% endif %}"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center py-5">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-box-open fa-4x mb-3 opacity-25"></i>
                                <h5>No se encontraron productos</h5>
                                <p class="mb-3">Intenta ajustar los filtros de búsqueda</p>
                                <a href="{% url 'inventario:crear_producto' %}" class="btn btn-primary">
                                    <i class="fas fa-plus me-1"></i> Crear Primer Producto
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Paginación -->
    {% if productos.has_other_pages %}
    <div class="card-footer bg-light">
        <div class="row align-items-center">
            <div class="col-md-6 text-center text-md-start mb-2 mb-md-0">
                <small class="text-muted">
                    Mostrando <strong>{{ productos.start_index }}</strong> a
                    <strong>{{ productos.end_index }}</strong> de
                    <strong>{{ productos.paginator.count }}</strong> productos
                </small>
            </div>
            <div class="col-md-6">
                <nav aria-label="Paginación">
                    <ul class="pagination justify-content-center justify-content-md-end mb-0">
                        {% if productos.has_previous %}
                        <li class="page-item">
                            <a class="page-link"
                                href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="fas fa-angle-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link"
                                href="?page={{ productos.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="fas fa-angle-left"></i>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link"><i class="fas fa-angle-double-left"></i></span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link"><i class="fas fa-angle-left"></i></span>
                        </li>
                        {% endif %}

                        {% for i in productos.paginator.page_range %}
                        {% if productos.number == i %}
                        <li class="page-item active">
                            <span class="page-link">{{ i }}</span>
                        </li>
                        {% elif i > productos.number|add:"-3" and i < productos.number|add:"3" %}
                        <li class="page-item">
                            <a class="page-link"
                                href="?page={{ i }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                {{ i }}
                            </a>
                        </li>
                        {% endif %}
                        {% endfor %}

                        {% if productos.has_next %}
                        <li class="page-item">
                            <a class="page-link"
                                href="?page={{ productos.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="fas fa-angle-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link"
                                href="?page={{ productos.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                <i class="fas fa-angle-double-right"></i>
                            </a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link"><i class="fas fa-angle-right"></i></span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link"><i class="fas fa-angle-double-right"></i></span>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal de Confirmación -->
<div class="modal fade" id="modalToggleEstado" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    Confirmar Acción
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="modalToggleEstadoTexto" class="mb-0"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancelar
                </button>
                <form method="post" id="formToggleEstado" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary" id="btnConfirmarToggle">
                        <i class="fas fa-check me-1"></i> Confirmar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block inventory_js %}
<script>
    $(document).ready(function () {
        // ==================== TOOLTIPS ====================
        $('[data-bs-toggle="tooltip"]').tooltip();

        // ==================== FILTROS AUTOMÁTICOS ====================
        $('#id_categoria, #id_marca, #id_activo').on('change', function () {
            $('#searchForm').submit();
        });

        // ==================== CONFIRMACIÓN DE ACTIVAR/DESACTIVAR ====================
        $('.btn-toggle-estado').on('click', function (e) {
            e.preventDefault();

            const productoId = $(this).data('producto-id');
            const productoNombre = $(this).data('producto-nombre');
            const estadoActual = $(this).data('estado-actual') === 'true';

            const accion = estadoActual ? 'desactivar' : 'activar';
            const textoModal = `¿Estás seguro que deseas <strong>${accion}</strong> el producto "<strong>${productoNombre}</strong>"?`;

            $('#modalToggleEstadoTexto').html(textoModal);
            $('#formToggleEstado').attr('action', `/inventario/producto/${productoId}/activar/`);

            const $btnConfirmar = $('#btnConfirmarToggle');
            $btnConfirmar.removeClass('btn-danger btn-success')
                .addClass(estadoActual ? 'btn-danger' : 'btn-success')
                .html(`<i class="fas fa-${estadoActual ? 'times' : 'check'} me-1"></i>${accion.charAt(0).toUpperCase() + accion.slice(1)}`);

            new bootstrap.Modal(document.getElementById('modalToggleEstado')).show();
        });

        // ==================== ANIMACIÓN EN CARDS ====================
        $('.card').hover(
            function () { $(this).addClass('shadow-lg').css('transform', 'translateY(-2px)'); },
            function () { $(this).removeClass('shadow-lg').css('transform', 'translateY(0)'); }
        );
    });
</script>

<style>
    .card {
        transition: all 0.3s ease;
    }

    .btn {
        transition: all 0.2s ease;
    }

    .table-responsive {
        border-radius: 0;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }

    .badge {
        font-weight: 500;
        padding: 0.4em 0.8em;
    }

    code {
        font-size: 0.875rem;
        font-weight: 500;
    }

    .pagination .page-link {
        padding: 0.5rem 0.75rem;
        border-radius: 0.25rem;
        margin: 0 2px;
    }

    .pagination .page-item.active .page-link {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    @media (max-width: 768px) {
        .card-body h3 {
            font-size: 1.5rem;
        }

        .btn-group-sm>.btn {
            padding: 0.25rem 0.4rem;
            font-size: 0.75rem;
        }
    }
</style>
{% endblock %}