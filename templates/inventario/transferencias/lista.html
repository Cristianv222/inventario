{% extends 'base.html' %}
{% load static %}

{% block breadcrumb_page %}
<li class="breadcrumb-item active">Transferencias de Inventario</li>
{% endblock %}

{% block inventory_content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1>
            <i class="fas fa-exchange-alt"></i> 
            Transferencias de Inventario
        </h1>
    </div>
    <div class="col-md-4 text-end">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCrearTransferencia">
            <i class="fas fa-plus me-1"></i> Nueva Transferencia
        </button>
    </div>
</div>

<!-- Estadísticas -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card shadow-sm">
            <div class="card-body text-center">
                <h3 class="mb-0">{{ estadisticas.total }}</h3>
                <p class="text-muted mb-0"><small>Total</small></p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card shadow-sm border-warning">
            <div class="card-body text-center">
                <h3 class="mb-0 text-warning">{{ estadisticas.pendientes }}</h3>
                <p class="text-muted mb-0"><small>Pendientes</small></p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card shadow-sm border-info">
            <div class="card-body text-center">
                <h3 class="mb-0 text-info">{{ estadisticas.en_transito }}</h3>
                <p class="text-muted mb-0"><small>En Tránsito</small></p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card shadow-sm border-success">
            <div class="card-body text-center">
                <h3 class="mb-0 text-success">{{ estadisticas.recibidas }}</h3>
                <p class="text-muted mb-0"><small>Recibidas</small></p>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="card shadow-sm mb-4">
    <div class="card-header">
        <i class="fas fa-filter me-2"></i> Filtros
    </div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label"><small>Estado</small></label>
                <select name="estado" class="form-select form-select-sm">
                    <option value="">Todos los estados</option>
                    <option value="PENDIENTE" {% if request.GET.estado == 'PENDIENTE' %}selected{% endif %}>Pendiente</option>
                    <option value="EN_TRANSITO" {% if request.GET.estado == 'EN_TRANSITO' %}selected{% endif %}>En Tránsito</option>
                    <option value="RECIBIDA" {% if request.GET.estado == 'RECIBIDA' %}selected{% endif %}>Recibida</option>
                    <option value="CANCELADA" {% if request.GET.estado == 'CANCELADA' %}selected{% endif %}>Cancelada</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label"><small>Tipo</small></label>
                <select name="tipo" class="form-select form-select-sm">
                    <option value="">Todas</option>
                    <option value="enviadas" {% if request.GET.tipo == 'enviadas' %}selected{% endif %}>Enviadas</option>
                    <option value="recibidas" {% if request.GET.tipo == 'recibidas' %}selected{% endif %}>Recibidas</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label"><small>Buscar</small></label>
                <input type="text" name="busqueda" class="form-control form-control-sm" 
                       placeholder="Número de guía o observaciones..." 
                       value="{{ request.GET.busqueda }}">
            </div>
            <div class="col-md-2">
                <label class="form-label"><small>&nbsp;</small></label>
                <button type="submit" class="btn btn-secondary btn-sm w-100">
                    <i class="fas fa-search me-1"></i> Filtrar
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Lista de transferencias -->
<div class="card shadow-sm">
    <div class="card-header">
        <i class="fas fa-list me-2"></i> Transferencias
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Nº Guía</th>
                        <th>Fecha Envío</th>
                        <th>Origen</th>
                        <th>Destino</th>
                        <th>Estado</th>
                        <th>Items</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trans in transferencias %}
                    <tr>
                        <td><strong>{{ trans.numero_guia }}</strong></td>
                        <td>{{ trans.fecha_envio|date:"d/m/Y H:i" }}</td>
                        <td>{{ trans.sucursal_origen.nombre }}</td>
                        <td>{{ trans.sucursal_destino.nombre }}</td>
                        <td>
                            {% if trans.estado == 'PENDIENTE' %}
                                <span class="badge bg-warning">Pendiente</span>
                            {% elif trans.estado == 'EN_TRANSITO' %}
                                <span class="badge bg-info">En Tránsito</span>
                            {% elif trans.estado == 'RECIBIDA' %}
                                <span class="badge bg-success">Recibida</span>
                            {% else %}
                                <span class="badge bg-danger">Cancelada</span>
                            {% endif %}
                        </td>
                        <td>{{ trans.detalles.count }}</td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <a href="{% url 'inventario:transferencia_detalle' trans.id %}" 
                                   class="btn btn-outline-info" 
                                   title="Ver detalle">
                                    <i class="fas fa-eye"></i>
                                </a>
                                
                                {% if trans.puede_ser_recibida and trans.sucursal_destino == request.user.sucursal or es_admin %}
                                <button class="btn btn-outline-success" 
                                        onclick="abrirModalRecibir({{ trans.id }})"
                                        title="Recibir transferencia">
                                    <i class="fas fa-check"></i>
                                </button>
                                {% endif %}
                                
                                {% if trans.puede_ser_cancelada and trans.sucursal_origen == request.user.sucursal or es_admin %}
                                <button class="btn btn-outline-danger" 
                                        onclick="abrirModalCancelar({{ trans.id }}, '{{ trans.numero_guia }}')"
                                        title="Cancelar transferencia">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-4 text-muted">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p class="mb-0">No hay transferencias registradas</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Paginación -->
        {% if transferencias.has_other_pages %}
        <nav aria-label="Paginación" class="mt-3">
            <ul class="pagination pagination-sm justify-content-center mb-0">
                {% if transferencias.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ transferencias.previous_page_number }}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.busqueda %}&busqueda={{ request.GET.busqueda }}{% endif %}">
                        Anterior
                    </a>
                </li>
                {% endif %}
                
                <li class="page-item disabled">
                    <span class="page-link">
                        Página {{ transferencias.number }} de {{ transferencias.paginator.num_pages }}
                    </span>
                </li>
                
                {% if transferencias.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ transferencias.next_page_number }}{% if request.GET.estado %}&estado={{ request.GET.estado }}{% endif %}{% if request.GET.tipo %}&tipo={{ request.GET.tipo }}{% endif %}{% if request.GET.busqueda %}&busqueda={{ request.GET.busqueda }}{% endif %}">
                        Siguiente
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- ========================================
     MODAL: CREAR TRANSFERENCIA
     ======================================== -->
<div class="modal fade" id="modalCrearTransferencia" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i> Nueva Transferencia de Inventario
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formCrearTransferencia">
                    <!-- Sucursales -->
                    <div class="row mb-3">
                        {% if es_admin %}
                        <div class="col-md-6">
                            <label class="form-label">Sucursal Origen <span class="text-danger">*</span></label>
                            <select id="sucursalOrigen" class="form-select" required>
                                <option value="">Seleccione...</option>
                                {% for suc in sucursales_origen %}
                                <option value="{{ suc.id }}">{{ suc.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% else %}
                        <input type="hidden" id="sucursalOrigen" value="{{ request.user.sucursal.id }}">
                        <div class="col-md-6">
                            <label class="form-label">Sucursal Origen</label>
                            <input type="text" class="form-control" value="{{ request.user.sucursal.nombre }}" readonly>
                        </div>
                        {% endif %}
                        
                        <div class="col-md-6">
                            <label class="form-label">Sucursal Destino <span class="text-danger">*</span></label>
                            <select id="sucursalDestino" class="form-select" required>
                                <option value="">Seleccione...</option>
                                {% for suc in sucursales_destino %}
                                <option value="{{ suc.id }}">{{ suc.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <hr>

                    <!-- Buscador de productos -->
                    <div class="mb-3">
                        <label class="form-label">Buscar Producto</label>
                        <div class="input-group">
                            <input type="text" id="buscarProducto" class="form-control" 
                                   placeholder="Buscar por nombre o código..."
                                   onkeypress="if(event.key === 'Enter') { event.preventDefault(); buscarProductos(); }">
                            <button type="button" class="btn btn-secondary" onclick="buscarProductos()">
                                <i class="fas fa-search"></i> Buscar
                            </button>
                        </div>
                        <div id="resultadosProductos" class="mt-2"></div>
                    </div>

                    <!-- Tabla de productos seleccionados -->
                    <div class="mb-3">
                        <label class="form-label">Productos a Transferir</label>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th width="40%">Producto</th>
                                        <th width="15%" class="text-center">Stock Disponible</th>
                                        <th width="15%">Cantidad</th>
                                        <th width="15%" class="text-end">Precio Unit.</th>
                                        <th width="10%" class="text-center">Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaProductosSeleccionados">
                                    <tr id="rowVacio">
                                        <td colspan="5" class="text-center text-muted py-4">
                                            <i class="fas fa-box-open fa-2x mb-2"></i>
                                            <p class="mb-0">No hay productos agregados</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Observaciones -->
                    <div class="mb-3">
                        <label class="form-label">Observaciones</label>
                        <textarea id="observaciones" class="form-control" rows="2" 
                                  placeholder="Agregar notas o comentarios sobre esta transferencia..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarTransferencia()">
                    <i class="fas fa-save me-1"></i> Crear Transferencia
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ========================================
     MODAL: RECIBIR TRANSFERENCIA
     ======================================== -->
<div class="modal fade" id="modalRecibirTransferencia" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check me-2"></i> Recibir Transferencia
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="contenidoRecibir">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3 text-muted">Cargando información...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="confirmarRecepcion()">
                    <i class="fas fa-check me-1"></i> Confirmar Recepción
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ========================================
     MODAL: CANCELAR TRANSFERENCIA
     ======================================== -->
<div class="modal fade" id="modalCancelarTransferencia" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i> Cancelar Transferencia
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="transferenciaIdCancelar">
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>
                    ¿Está seguro de cancelar la transferencia <strong id="numeroGuiaCancelar"></strong>?
                    Esta acción no se puede deshacer.
                </div>
                <div class="mb-3">
                    <label class="form-label">Motivo de cancelación <span class="text-danger">*</span></label>
                    <textarea id="motivoCancelacion" class="form-control" rows="3" 
                              placeholder="Especifique el motivo de la cancelación..." required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-arrow-left me-1"></i> No, volver
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmarCancelacion()">
                    <i class="fas fa-times me-1"></i> Sí, cancelar transferencia
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let productosSeleccionados = [];

// ==================== BÚSQUEDA DE PRODUCTOS ====================
async function buscarProductos() {
    const sucursalId = document.getElementById('sucursalOrigen').value;
    const termino = document.getElementById('buscarProducto').value.trim();
    
    if (!sucursalId) {
        mostrarAlerta('warning', 'Seleccione primero una sucursal origen');
        return;
    }
    
    if (!termino) {
        document.getElementById('resultadosProductos').innerHTML = '';
        return;
    }
    
    try {
        const response = await fetch(`{% url 'inventario:api_buscar_productos_transferencia' %}?sucursal_id=${sucursalId}&q=${encodeURIComponent(termino)}`);
        const data = await response.json();
        
        if (data.success) {
            mostrarResultados(data.productos);
        } else {
            mostrarAlerta('danger', data.mensaje || 'Error al buscar productos');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarAlerta('danger', 'Error al buscar productos');
    }
}

function mostrarResultados(productos) {
    const div = document.getElementById('resultadosProductos');
    
    if (productos.length === 0) {
        div.innerHTML = '<p class="text-muted mb-0"><small>No se encontraron productos</small></p>';
        return;
    }
    
    let html = '<div class="list-group">';
    productos.forEach(p => {
        const stockClass = p.stock > 10 ? 'success' : p.stock > 0 ? 'warning' : 'danger';
        html += `
            <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" 
                    onclick='agregarProducto(${JSON.stringify(p)})'>
                <div>
                    <strong>${p.codigo}</strong> - ${p.nombre}
                    <br><small class="text-muted">${p.categoria || ''} ${p.marca ? '• ' + p.marca : ''}</small>
                </div>
                <span class="badge bg-${stockClass}">Stock: ${p.stock}</span>
            </button>
        `;
    });
    html += '</div>';
    div.innerHTML = html;
}

function agregarProducto(producto) {
    // Verificar si ya está agregado
    if (productosSeleccionados.find(p => p.id === producto.id)) {
        mostrarAlerta('warning', 'Este producto ya está en la lista');
        return;
    }
    
    productosSeleccionados.push({
        id: producto.id,
        nombre: producto.nombre,
        codigo: producto.codigo,
        stock: producto.stock,
        precio_venta: producto.precio_venta,
        cantidad: 1
    });
    
    actualizarTablaProductos();
    document.getElementById('resultadosProductos').innerHTML = '';
    document.getElementById('buscarProducto').value = '';
}

function actualizarTablaProductos() {
    const tbody = document.getElementById('tablaProductosSeleccionados');
    
    if (productosSeleccionados.length === 0) {
        tbody.innerHTML = `
            <tr id="rowVacio">
                <td colspan="5" class="text-center text-muted py-4">
                    <i class="fas fa-box-open fa-2x mb-2"></i>
                    <p class="mb-0">No hay productos agregados</p>
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    productosSeleccionados.forEach((p, index) => {
        html += `
            <tr>
                <td>
                    <strong>${p.codigo}</strong><br>
                    <small class="text-muted">${p.nombre}</small>
                </td>
                <td class="text-center">
                    <span class="badge bg-${p.stock > 10 ? 'success' : p.stock > 0 ? 'warning' : 'danger'}">
                        ${p.stock}
                    </span>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm" 
                           value="${p.cantidad}" min="1" max="${p.stock}" step="1"
                           onchange="actualizarCantidad(${index}, this.value)">
                </td>
                <td class="text-end">$${parseFloat(p.precio_venta).toFixed(2)}</td>
                <td class="text-center">
                    <button type="button" class="btn btn-sm btn-outline-danger" 
                            onclick="eliminarProducto(${index})"
                            title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    tbody.innerHTML = html;
}

function actualizarCantidad(index, cantidad) {
    const cant = parseFloat(cantidad);
    const max = productosSeleccionados[index].stock;
    
    if (cant > max) {
        mostrarAlerta('warning', `Stock insuficiente. Máximo: ${max}`);
        productosSeleccionados[index].cantidad = max;
        actualizarTablaProductos();
        return;
    }
    
    productosSeleccionados[index].cantidad = cant;
}

function eliminarProducto(index) {
    productosSeleccionados.splice(index, 1);
    actualizarTablaProductos();
}

// ==================== GUARDAR TRANSFERENCIA ====================
async function guardarTransferencia() {
    if (productosSeleccionados.length === 0) {
        mostrarAlerta('warning', 'Debe agregar al menos un producto');
        return;
    }
    
    const sucursalDestinoId = document.getElementById('sucursalDestino').value;
    if (!sucursalDestinoId) {
        mostrarAlerta('warning', 'Debe seleccionar una sucursal destino');
        return;
    }
    
    const data = {
        sucursal_origen: document.getElementById('sucursalOrigen').value,
        sucursal_destino: sucursalDestinoId,
        productos: productosSeleccionados.map(p => ({
            producto_id: p.id,
            cantidad: p.cantidad
        })),
        observaciones: document.getElementById('observaciones').value
    };
    
    try {
        const response = await fetch('{% url "inventario:transferencia_crear" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            mostrarAlerta('success', result.mensaje);
            setTimeout(() => location.reload(), 1500);
        } else {
            mostrarAlerta('danger', result.mensaje);
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarAlerta('danger', 'Error al crear la transferencia');
    }
}

// ==================== RECIBIR TRANSFERENCIA ====================
async function abrirModalRecibir(transferenciaId) {
    const modal = new bootstrap.Modal(document.getElementById('modalRecibirTransferencia'));
    modal.show();
    
    try {
        const response = await fetch(`/inventario/transferencias/${transferenciaId}/detalles/`);
        const data = await response.json();
        
        if (!data.success) {
            mostrarAlerta('danger', 'Error al cargar detalles');
            return;
        }
        
        let html = `
            <input type="hidden" id="transferenciaIdRecibir" value="${transferenciaId}">
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Verifique las cantidades recibidas. Puede ajustarlas si hay diferencias.
            </div>
            <div class="table-responsive">
                <table class="table table-sm table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Producto</th>
                            <th width="15%" class="text-center">Cantidad Enviada</th>
                            <th width="20%">Cantidad Recibida</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        data.detalles.forEach((d, index) => {
            html += `
                <tr>
                    <td>
                        <strong>${d.producto_codigo}</strong><br>
                        <small class="text-muted">${d.producto_nombre}</small>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-info">${d.cantidad_enviada}</span>
                    </td>
                    <td>
                        <input type="number" class="form-control form-control-sm cantidad-recibida" 
                               data-producto-id="${d.producto_id}"
                               value="${d.cantidad_enviada}" 
                               min="0" max="${d.cantidad_enviada}" step="1">
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
            <div class="mb-3">
                <label class="form-label">Observaciones de Recepción</label>
                <textarea id="observacionesRecepcion" class="form-control" rows="2" 
                          placeholder="Notas sobre la recepción..."></textarea>
            </div>
        `;
        
        document.getElementById('contenidoRecibir').innerHTML = html;
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('contenidoRecibir').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error al cargar los detalles de la transferencia
            </div>
        `;
    }
}

async function confirmarRecepcion() {
    const transferenciaId = document.getElementById('transferenciaIdRecibir').value;
    const cantidades = document.querySelectorAll('.cantidad-recibida');
    
    const productos = Array.from(cantidades).map(input => ({
        producto_id: input.dataset.productoId,
        cantidad_recibida: parseFloat(input.value)
    }));
    
    const data = {
        productos: productos,
        observaciones: document.getElementById('observacionesRecepcion').value
    };
    
    try {
        const response = await fetch(`/inventario/transferencias/${transferenciaId}/recibir/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            mostrarAlerta('success', result.mensaje);
            setTimeout(() => location.reload(), 1500);
        } else {
            mostrarAlerta('danger', result.mensaje);
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarAlerta('danger', 'Error al recibir la transferencia');
    }
}

// ==================== CANCELAR TRANSFERENCIA ====================
function abrirModalCancelar(transferenciaId, numeroGuia) {
    document.getElementById('transferenciaIdCancelar').value = transferenciaId;
    document.getElementById('numeroGuiaCancelar').textContent = numeroGuia;
    document.getElementById('motivoCancelacion').value = '';
    const modal = new bootstrap.Modal(document.getElementById('modalCancelarTransferencia'));
    modal.show();
}

async function confirmarCancelacion() {
    const transferenciaId = document.getElementById('transferenciaIdCancelar').value;
    const motivo = document.getElementById('motivoCancelacion').value.trim();
    
    if (!motivo) {
        mostrarAlerta('warning', 'Debe especificar un motivo de cancelación');
        return;
    }
    
    try {
        const response = await fetch(`/inventario/transferencias/${transferenciaId}/cancelar/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ motivo })
        });
        
        const result = await response.json();
        
        if (result.success) {
            mostrarAlerta('success', result.mensaje);
            setTimeout(() => location.reload(), 1500);
        } else {
            mostrarAlerta('danger', result.mensaje);
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarAlerta('danger', 'Error al cancelar la transferencia');
    }
}

// ==================== UTILIDADES ====================
function mostrarAlerta(tipo, mensaje) {
    const alertHtml = `
        <div class="alert alert-${tipo} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" 
             style="z-index: 9999; min-width: 300px;" role="alert">
            <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', alertHtml);
    setTimeout(() => {
        const alert = document.querySelector('.alert');
        if (alert) alert.remove();
    }, 5000);
}

// Limpiar formulario al cerrar modal
document.getElementById('modalCrearTransferencia').addEventListener('hidden.bs.modal', function () {
    productosSeleccionados = [];
    document.getElementById('formCrearTransferencia').reset();
    actualizarTablaProductos();
    document.getElementById('resultadosProductos').innerHTML = '';
});
</script>
{% endblock %}