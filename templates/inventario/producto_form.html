{% extends 'base.html' %}

{% block breadcrumb_page %}
<li class="breadcrumb-item"><a href="{% url 'inventario:lista_productos' %}">Productos</a></li>
<li class="breadcrumb-item active">{% if es_nuevo %}Nuevo Producto{% else %}Editar Producto{% endif %}</li>
{% endblock %}

{% block inventory_content %}
<div class="container-fluid">
    <!-- Header compacto -->
    <div class="row align-items-center mb-3">
        <div class="col">
            <h2 class="mb-0">
                <i class="fas fa-{% if es_nuevo %}plus{% else %}edit{% endif %} me-2"></i>
                {% if es_nuevo %}Nuevo Producto{% else %}Editar Producto{% endif %}
            </h2>
        </div>
        <div class="col-auto">
            <a href="{% url 'inventario:lista_productos' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i> Volver
            </a>
        </div>
    </div>

    <!-- Progress Indicator -->
    <div class="card mb-3">
        <div class="card-body py-2">
            <div class="wizard-progress">
                <div class="wizard-step active" data-step="1">
                    <div class="wizard-step-circle">1</div>
                    <div class="wizard-step-label">Básico</div>
                </div>
                <div class="wizard-step-line"></div>
                <div class="wizard-step" data-step="2">
                    <div class="wizard-step-circle">2</div>
                    <div class="wizard-step-label">Precios</div>
                </div>
                <div class="wizard-step-line"></div>
                <div class="wizard-step" data-step="3">
                    <div class="wizard-step-circle">3</div>
                    <div class="wizard-step-label">Config</div>
                </div>
                <div class="wizard-step-line"></div>
                <div class="wizard-step" data-step="4">
                    <div class="wizard-step-circle">4</div>
                    <div class="wizard-step-label">Revisar</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario -->
    <div class="card">
        <div class="card-body">
            <form method="post" id="producto-form" novalidate>
                {% csrf_token %}
                
                <div class="wizard-content">
                    <!-- Paso 1: Información Básica -->
                    <div class="wizard-pane active" data-step="1">
                        <h5 class="mb-3">
                            <i class="fas fa-info-circle text-primary me-2"></i>
                            Paso 1: Información Básica
                        </h5>
                        <div class="row g-3">
                            <div class="col-12">
                                <label for="{{ form.nombre.id_for_label }}" class="form-label fw-semibold required">Nombre del Producto</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="{{ form.nombre.id_for_label }}" 
                                       name="{{ form.nombre.name }}" 
                                       value="{{ form.nombre.value|default:'' }}"
                                       placeholder="Ej: Filtro de aceite para motor" 
                                       data-required="true"
                                       autocomplete="off">
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.codigo_unico.id_for_label }}" class="form-label fw-semibold required">Código del Producto</label>
                                <div class="input-group">
                                    <input type="text" 
                                           class="form-control" 
                                           id="{{ form.codigo_unico.id_for_label }}" 
                                           name="{{ form.codigo_unico.name }}" 
                                           value="{{ form.codigo_unico.value|default:'' }}"
                                           placeholder="Se generará automáticamente" 
                                           data-required="true"
                                           autocomplete="off">
                                    <button type="button" class="btn btn-outline-success" id="btn-generar-codigo" title="Generar código automáticamente">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback"></div>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Se genera automático o puedes editarlo
                                </small>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.categoria.id_for_label }}" class="form-label fw-semibold required">Categoría</label>
                                <select class="form-select" 
                                        id="{{ form.categoria.id_for_label }}" 
                                        name="{{ form.categoria.name }}" 
                                        data-required="true">
                                    <option value="">-- Seleccionar --</option>
                                    {% for choice in form.categoria.field.queryset %}
                                        <option value="{{ choice.pk }}" 
                                                {% if form.categoria.value == choice.pk|stringformat:"s" %}selected{% endif %}>
                                            {{ choice }} ({{ choice.porcentaje_ganancia }}%)
                                        </option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.marca.id_for_label }}" class="form-label fw-semibold required">Marca</label>
                                <select class="form-select" 
                                        id="{{ form.marca.id_for_label }}" 
                                        name="{{ form.marca.name }}" 
                                        data-required="true">
                                    <option value="">-- Seleccionar --</option>
                                    {% for choice in form.marca.field.queryset %}
                                        <option value="{{ choice.pk }}" 
                                                {% if form.marca.value == choice.pk|stringformat:"s" %}selected{% endif %}>
                                            {{ choice }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-12">
                                <label for="{{ form.descripcion.id_for_label }}" class="form-label fw-semibold">Descripción (Opcional)</label>
                                <textarea class="form-control" 
                                          id="{{ form.descripcion.id_for_label }}" 
                                          name="{{ form.descripcion.name }}" 
                                          rows="3"
                                          placeholder="Descripción detallada del producto...">{{ form.descripcion.value|default:'' }}</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Paso 2: Precios y Stock -->
                    <div class="wizard-pane" data-step="2">
                        <h5 class="mb-3">
                            <i class="fas fa-dollar-sign text-success me-2"></i>
                            Paso 2: Precios y Stock
                        </h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="{{ form.precio_compra.id_for_label }}" class="form-label fw-semibold required">Precio de Compra</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" 
                                           class="form-control" 
                                           id="{{ form.precio_compra.id_for_label }}" 
                                           name="{{ form.precio_compra.name }}" 
                                           value="{{ form.precio_compra.value|default:'' }}"
                                           step="0.01" 
                                           min="0"
                                           placeholder="0.00" 
                                           data-required="true"
                                           autocomplete="off">
                                </div>
                                <div class="invalid-feedback"></div>
                                <small class="text-muted">Se calculará automáticamente el precio de venta</small>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.precio_venta.id_for_label }}" class="form-label fw-semibold required">Precio de Venta</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" 
                                           class="form-control" 
                                           id="{{ form.precio_venta.id_for_label }}" 
                                           name="{{ form.precio_venta.name }}" 
                                           value="{{ form.precio_venta.value|default:'' }}"
                                           step="0.01" 
                                           min="0"
                                           placeholder="0.00" 
                                           data-required="true"
                                           autocomplete="off">
                                    <button type="button" id="btn-calcular-precio" class="btn btn-outline-primary" tabindex="-1">
                                        <i class="fas fa-calculator"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="{{ form.stock_actual.id_for_label }}" class="form-label fw-semibold required">Stock Actual</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="{{ form.stock_actual.id_for_label }}" 
                                       name="{{ form.stock_actual.name }}" 
                                       value="{{ form.stock_actual.value|default:'' }}"
                                       min="0"
                                       placeholder="Cantidad en stock"
                                       data-required="true"
                                       autocomplete="off">
                                <div class="invalid-feedback"></div>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="{{ form.stock_minimo.id_for_label }}" class="form-label fw-semibold required">Stock Mínimo</label>
                                <input type="number" 
                                       class="form-control" 
                                       id="{{ form.stock_minimo.id_for_label }}" 
                                       name="{{ form.stock_minimo.name }}" 
                                       value="{{ form.stock_minimo.value|default:'' }}"
                                       min="0"
                                       placeholder="Cantidad mínima"
                                       data-required="true"
                                       autocomplete="off">
                                <div class="invalid-feedback"></div>
                                <small class="text-muted">Para alertas</small>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="{{ form.ubicacion_almacen.id_for_label }}" class="form-label fw-semibold">Ubicación (Opcional)</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="{{ form.ubicacion_almacen.id_for_label }}" 
                                       name="{{ form.ubicacion_almacen.name }}" 
                                       value="{{ form.ubicacion_almacen.value|default:'' }}"
                                       placeholder="Ej: A-1"
                                       autocomplete="off">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Paso 3: Configuración -->
                    <div class="wizard-pane" data-step="3">
                        <h5 class="mb-3">
                            <i class="fas fa-cog text-info me-2"></i>
                            Paso 3: Configuración
                        </h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Estado del Producto</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" 
                                                   class="form-check-input" 
                                                   id="{{ form.activo.id_for_label }}" 
                                                   name="{{ form.activo.name }}" 
                                                   value="True"
                                                   {% if form.activo.value or es_nuevo %}checked{% endif %}>
                                            <label for="{{ form.activo.id_for_label }}" class="form-check-label">
                                                Producto activo
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Configuración Fiscal</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" 
                                                   class="form-check-input" 
                                                   id="{{ form.incluye_iva.id_for_label }}" 
                                                   name="{{ form.incluye_iva.name }}" 
                                                   value="True"
                                                   {% if form.incluye_iva.value %}checked{% endif %}>
                                            <label for="{{ form.incluye_iva.id_for_label }}" class="form-check-label">
                                                Incluye IVA
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Paso 4: Revisión -->
                    <div class="wizard-pane" data-step="4">
                        <h5 class="mb-3">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Paso 4: Revisar Información
                        </h5>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Revisa que toda la información sea correcta antes de guardar
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <strong>Información Básica</strong>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-sm mb-0">
                                            <tr>
                                                <td width="40%"><strong>Nombre:</strong></td>
                                                <td id="review-nombre">-</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Código:</strong></td>
                                                <td id="review-codigo">-</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Categoría:</strong></td>
                                                <td id="review-categoria">-</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Marca:</strong></td>
                                                <td id="review-marca">-</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <strong>Precios y Stock</strong>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-sm mb-0">
                                            <tr>
                                                <td width="40%"><strong>P. Compra:</strong></td>
                                                <td id="review-precio-compra">-</td>
                                            </tr>
                                            <tr>
                                                <td><strong>P. Venta:</strong></td>
                                                <td id="review-precio-venta">-</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Stock Actual:</strong></td>
                                                <td id="review-stock">-</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Stock Mínimo:</strong></td>
                                                <td id="review-stock-minimo">-</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Ubicación:</strong></td>
                                                <td id="review-ubicacion">-</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Botones de navegación -->
                <div class="row mt-4 pt-3 border-top">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <button type="button" class="btn btn-outline-secondary" id="btn-prev">
                                <i class="fas fa-arrow-left me-1"></i> Anterior
                            </button>
                            
                            <small class="text-muted">Paso <span id="current-step">1</span> de 4</small>
                            
                            <div>
                                <button type="button" class="btn btn-primary" id="btn-next">
                                    Siguiente <i class="fas fa-arrow-right ms-1"></i>
                                </button>
                                <button type="submit" class="btn btn-success d-none" id="btn-submit">
                                    <i class="fas fa-save me-1"></i> Guardar Producto
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block inventory_js %}
<script>
$(document).ready(function() {
    // ==================== PREVENIR ENTER EN TODO EL FORMULARIO ====================
    $('#producto-form').on('keypress', function(e) {
        if (e.which === 13 || e.keyCode === 13) {
            e.preventDefault();
            return false;
        }
    });
    
    // ==================== GENERAR CÓDIGO ÚNICO ====================
    function generarCodigoUnico() {
        const timestamp = Date.now().toString(36).toUpperCase();
        const random = Math.random().toString(36).substring(2, 6).toUpperCase();
        return `PROD-${timestamp}-${random}`;
    }
    
    function inicializarCodigo() {
        const $codigoInput = $('#id_codigo_unico');
        
        if (!$codigoInput.val() || $codigoInput.val().trim() === '') {
            const codigoGenerado = generarCodigoUnico();
            $codigoInput.val(codigoGenerado);
            
            $codigoInput.addClass('campo-generado');
            setTimeout(() => $codigoInput.removeClass('campo-generado'), 2000);
        }
    }
    
    $('#btn-generar-codigo').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const $btn = $(this);
        const $input = $('#id_codigo_unico');
        
        if ($input.val() && $input.val().trim() !== '') {
            if (!confirm('¿Estás seguro de generar un nuevo código? El código actual se perderá.')) {
                return;
            }
        }
        
        $btn.html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);
        
        setTimeout(() => {
            const nuevoCodigo = generarCodigoUnico();
            $input.val(nuevoCodigo);
            
            $input.addClass('campo-generado');
            setTimeout(() => $input.removeClass('campo-generado'), 2000);
            
            $btn.html('<i class="fas fa-sync-alt"></i>').prop('disabled', false);
            
            mostrarNotificacion('Código generado exitosamente', 'success');
            autoGuardar();
        }, 500);
    });
    
    // ==================== WIZARD CONTROL ====================
    let currentStep = 1;
    const totalSteps = 4;
    let formSubmitting = false; // Flag para controlar el envío
    
    const STORAGE_KEY = 'producto_borrador';
    
    // Auto-guardar
    function autoGuardar() {
        const formData = {
            nombre: $('#id_nombre').val(),
            codigo_unico: $('#id_codigo_unico').val(),
            categoria: $('#id_categoria').val(),
            marca: $('#id_marca').val(),
            descripcion: $('#id_descripcion').val(),
            precio_compra: $('#id_precio_compra').val(),
            precio_venta: $('#id_precio_venta').val(),
            stock_actual: $('#id_stock_actual').val(),
            stock_minimo: $('#id_stock_minimo').val(),
            ubicacion_almacen: $('#id_ubicacion_almacen').val(),
            activo: $('#id_activo').is(':checked'),
            incluye_iva: $('#id_incluye_iva').is(':checked'),
            currentStep: currentStep
        };
        
        localStorage.setItem(STORAGE_KEY, JSON.stringify(formData));
        mostrarIndicadorGuardado();
    }
    
    function cargarDatosGuardados() {
        const saved = localStorage.getItem(STORAGE_KEY);
        
        if (saved) {
            const formData = JSON.parse(saved);
            
            // Solo cargar si tiene contenido significativo
            if (formData.nombre || formData.codigo_unico) {
                $('#id_nombre').val(formData.nombre || '');
                $('#id_codigo_unico').val(formData.codigo_unico || '');
                $('#id_categoria').val(formData.categoria || '');
                $('#id_marca').val(formData.marca || '');
                $('#id_descripcion').val(formData.descripcion || '');
                $('#id_precio_compra').val(formData.precio_compra || '');
                $('#id_precio_venta').val(formData.precio_venta || '');
                $('#id_stock_actual').val(formData.stock_actual || '');
                $('#id_stock_minimo').val(formData.stock_minimo || '');
                $('#id_ubicacion_almacen').val(formData.ubicacion_almacen || '');
                $('#id_activo').prop('checked', formData.activo !== false);
                $('#id_incluye_iva').prop('checked', formData.incluye_iva === true);
                
                if (formData.currentStep) {
                    currentStep = formData.currentStep;
                }
                
                mostrarAlertaRecuperacion();
            }
        }
    }
    
    function mostrarAlertaRecuperacion() {
        const alert = $(`
            <div class="alert alert-warning alert-dismissible fade show">
                <i class="fas fa-history me-2"></i>
                <strong>Borrador recuperado</strong> - Continúa donde lo dejaste
                <button type="button" class="btn btn-close" data-bs-dismiss="alert"></button>
                <button type="button" class="btn btn-sm btn-outline-danger ms-2" id="btn-descartar-borrador">
                    <i class="fas fa-trash me-1"></i>Descartar y empezar de nuevo
                </button>
            </div>
        `);
        $('.container-fluid').prepend(alert);
        
        // Botón para descartar borrador
        $('#btn-descartar-borrador').on('click', function() {
            if (confirm('¿Descartar el borrador y empezar de nuevo?')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        });
        
        setTimeout(() => alert.fadeOut(() => alert.remove()), 10000);
    }
    
    function mostrarIndicadorGuardado() {
        $('#indicador-guardado').remove();
        const ind = $('<div id="indicador-guardado" class="position-fixed bottom-0 end-0 m-3" style="z-index: 1050;"><div class="bg-success text-white px-3 py-2 rounded shadow-sm"><i class="fas fa-check me-1"></i> Guardado</div></div>');
        $('body').append(ind);
        setTimeout(() => ind.fadeOut(400, () => ind.remove()), 1500);
    }
    
    // Auto-guardar en cada cambio
    let autoGuardarTimeout;
    $('#producto-form input, #producto-form select, #producto-form textarea').on('input change', function() {
        clearTimeout(autoGuardarTimeout);
        autoGuardarTimeout = setTimeout(autoGuardar, 500);
    });
    
    // Validar paso
    function validarPaso(step) {
        let isValid = true;
        let firstInvalid = null;
        
        $(`.wizard-pane[data-step="${step}"] [data-required="true"]`).each(function() {
            const $field = $(this);
            const value = $field.val();
            
            $field.removeClass('is-invalid');
            $field.siblings('.invalid-feedback').text('');
            
            if (!value || value === '') {
                isValid = false;
                $field.addClass('is-invalid');
                
                const label = $field.closest('.col-12, .col-md-6, .col-md-4').find('label').first().text().replace('*', '').trim();
                $field.siblings('.invalid-feedback').text(`${label} es obligatorio`);
                
                if (!firstInvalid) firstInvalid = $field;
            }
            
            if ($field.attr('type') === 'number' && value) {
                const num = parseFloat(value);
                if (num < 0) {
                    isValid = false;
                    $field.addClass('is-invalid');
                    $field.siblings('.invalid-feedback').text('No puede ser negativo');
                    if (!firstInvalid) firstInvalid = $field;
                }
            }
        });
        
        if (!isValid && firstInvalid) {
            firstInvalid.focus();
        }
        
        return isValid;
    }
    
    // Actualizar wizard UI
    function actualizarWizardUI() {
        $('.wizard-step').removeClass('active completed');
        $(`.wizard-step[data-step="${currentStep}"]`).addClass('active');
        
        for (let i = 1; i < currentStep; i++) {
            $(`.wizard-step[data-step="${i}"]`).addClass('completed');
        }
        
        $('.wizard-pane').removeClass('active');
        $(`.wizard-pane[data-step="${currentStep}"]`).addClass('active');
        
        $('#current-step').text(currentStep);
        $('#btn-prev').prop('disabled', currentStep === 1);
        
        if (currentStep === totalSteps) {
            $('#btn-next').addClass('d-none');
            $('#btn-submit').removeClass('d-none');
            actualizarResumen();
        } else {
            $('#btn-next').removeClass('d-none');
            $('#btn-submit').addClass('d-none');
        }
        
        autoGuardar();
    }
    
    // Actualizar resumen
    function actualizarResumen() {
        $('#review-nombre').text($('#id_nombre').val() || '-');
        $('#review-codigo').text($('#id_codigo_unico').val() || '-');
        $('#review-categoria').text($('#id_categoria option:selected').text() || '-');
        $('#review-marca').text($('#id_marca option:selected').text() || '-');
        
        const pc = parseFloat($('#id_precio_compra').val()) || 0;
        const pv = parseFloat($('#id_precio_venta').val()) || 0;
        
        $('#review-precio-compra').html(`<strong>$${pc.toFixed(2)}</strong>`);
        $('#review-precio-venta').html(`<strong>$${pv.toFixed(2)}</strong>`);
        $('#review-stock').text($('#id_stock_actual').val() || '0');
        $('#review-stock-minimo').text($('#id_stock_minimo').val() || '0');
        $('#review-ubicacion').text($('#id_ubicacion_almacen').val() || 'Sin ubicación');
    }
    
    // Navegación
    $('#btn-next').on('click', function(e) {
        e.preventDefault();
        
        if (validarPaso(currentStep)) {
            currentStep++;
            actualizarWizardUI();
            $('html, body').animate({ scrollTop: 0 }, 300);
        }
    });
    
    $('#btn-prev').on('click', function(e) {
        e.preventDefault();
        
        if (currentStep > 1) {
            currentStep--;
            actualizarWizardUI();
            $('html, body').animate({ scrollTop: 0 }, 300);
        }
    });
    
    // Enviar formulario SOLO en paso 4
    $('#producto-form').on('submit', function(e) {
        // Si ya estamos enviando, no hacer nada
        if (formSubmitting) {
            return true;
        }
        
        e.preventDefault();
        
        // Verificar que estamos en el paso 4
        if (currentStep !== 4) {
            mostrarNotificacion('Debes completar todos los pasos antes de guardar', 'warning');
            return false;
        }
        
        // Validar todos los pasos anteriores
        for (let i = 1; i <= 3; i++) {
            if (!validarPaso(i)) {
                currentStep = i;
                actualizarWizardUI();
                mostrarNotificacion(`Por favor completa el Paso ${i}`, 'warning');
                return false;
            }
        }
        
        // Todo OK, limpiar borrador y preparar envío
        localStorage.removeItem(STORAGE_KEY);
        
        // Deshabilitar botón
        $('#btn-submit').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Guardando...');
        
        // Marcar como enviando
        formSubmitting = true;
        
        // Enviar el formulario de forma normal
        this.submit();
    });
    
    // Calcular precio SOLO con botón
    $('#btn-calcular-precio').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const pc = parseFloat($('#id_precio_compra').val());
        const cat = $('#id_categoria').val();
        
        if (!pc || pc <= 0) {
            mostrarNotificacion('Ingresa precio de compra', 'warning');
            return;
        }
        
        if (!cat) {
            mostrarNotificacion('Selecciona categoría', 'warning');
            return;
        }
        
        $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
        
        $.ajax({
            url: '{% url "inventario:calcular_precio_venta" %}',
            method: 'GET',
            data: { precio_compra: pc, categoria_id: cat },
            success: function(response) {
                if (response.success) {
                    $('#id_precio_venta').val(response.precio_venta.toFixed(2));
                    mostrarNotificacion(`Precio: $${response.precio_venta.toFixed(2)}`, 'success');
                    autoGuardar();
                }
            },
            complete: function() {
                $('#btn-calcular-precio').prop('disabled', false).html('<i class="fas fa-calculator"></i>');
            }
        });
    });
    
    function mostrarNotificacion(mensaje, tipo) {
        $('.toast-notification').remove();
        const icon = tipo === 'success' ? 'check-circle' : tipo === 'warning' ? 'exclamation-triangle' : 'times-circle';
        const toast = $(`<div class="toast-notification position-fixed top-0 end-0 m-3" style="z-index: 9999;"><div class="alert alert-${tipo} alert-dismissible fade show"><i class="fas fa-${icon} me-2"></i>${mensaje}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div></div>`);
        $('body').append(toast);
        if (tipo === 'success') setTimeout(() => toast.fadeOut(500, () => toast.remove()), 3000);
    }
    
    // ==================== INICIALIZACIÓN ====================
    
    // PRIMERO: Verificar si estamos editando un producto existente
    const esEdicion = {% if not es_nuevo %}true{% else %}false{% endif %};
    
    if (esEdicion) {
        // Si estamos editando, NO cargar borrador, limpiar cualquier borrador previo
        localStorage.removeItem(STORAGE_KEY);
    } else {
        // Si es nuevo producto, cargar borrador si existe
        cargarDatosGuardados();
    }
    
    // Generar código solo si está vacío
    if (!$('#id_codigo_unico').val() || $('#id_codigo_unico').val().trim() === '') {
        inicializarCodigo();
    }
    
    actualizarWizardUI();
});
</script>

<style>
.wizard-progress {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 2rem;
}

.wizard-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 0 0 auto;
}

.wizard-step-circle {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    background: #e9ecef;
    border: 3px solid #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #6c757d;
    transition: all 0.3s;
}

.wizard-step.active .wizard-step-circle {
    background: #0d6efd;
    border-color: #0d6efd;
    color: white;
}

.wizard-step.completed .wizard-step-circle {
    background: #28a745;
    border-color: #28a745;
    color: white;
}

.wizard-step-label {
    margin-top: 0.5rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: #6c757d;
}

.wizard-step.active .wizard-step-label {
    color: #0d6efd;
    font-weight: 600;
}

.wizard-step-line {
    flex: 1;
    height: 3px;
    background: #dee2e6;
    margin: 0 1rem;
    position: relative;
    top: -20px;
}

.wizard-step.completed ~ .wizard-step-line {
    background: #28a745;
}

.wizard-pane {
    display: none;
}

.wizard-pane.active {
    display: block;
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.required::after {
    content: " *";
    color: #dc3545;
}

.campo-generado {
    background-color: #d4edda !important;
    border-color: #28a745 !important;
    transition: all 0.5s ease;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

@media (max-width: 768px) {
    .wizard-progress { padding: 0.5rem; }
    .wizard-step-circle { width: 35px; height: 35px; }
    .wizard-step-label { font-size: 0.65rem; }
}
</style>
{% endblock %}