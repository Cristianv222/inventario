{% extends 'base.html' %}

{% block breadcrumb_page %}
<li class="breadcrumb-item"><a href="{% url 'inventario:lista_productos' %}">Productos</a></li>
<li class="breadcrumb-item active">{% if es_nuevo %}Nuevo Producto{% else %}Editar Producto{% endif %}</li>
{% endblock %}

{% block inventory_content %}
<div class="container-fluid">
    <!-- Header compacto -->
    <div class="row align-items-center mb-3">
        <div class="col">
            <h2 class="mb-0">
                <i class="fas fa-{% if es_nuevo %}plus{% else %}edit{% endif %} me-2"></i>
                {% if es_nuevo %}Nuevo Producto{% else %}Editar Producto{% endif %}
            </h2>
        </div>
        <div class="col-auto">
            <a href="{% url 'inventario:lista_productos' %}" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-arrow-left me-1"></i> Volver
            </a>
        </div>
    </div>

    <!-- Progress Indicator -->
    <div class="card mb-3">
        <div class="card-body py-2">
            <div class="wizard-progress">
                <div class="wizard-step active" data-step="1">
                    <div class="wizard-step-circle">1</div>
                    <div class="wizard-step-label">Básico</div>
                </div>
                <div class="wizard-step-line"></div>
                <div class="wizard-step" data-step="2">
                    <div class="wizard-step-circle">2</div>
                    <div class="wizard-step-label">Precios</div>
                </div>
                <div class="wizard-step-line"></div>
                <div class="wizard-step" data-step="3">
                    <div class="wizard-step-circle">3</div>
                    <div class="wizard-step-label">Config</div>
                </div>
                <div class="wizard-step-line"></div>
                <div class="wizard-step" data-step="4">
                    <div class="wizard-step-circle">4</div>
                    <div class="wizard-step-label">Revisar</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario -->
    <div class="card">
        <div class="card-body">
            <form method="post" id="producto-form" enctype="multipart/form-data" novalidate>
                {% csrf_token %}

                <div class="wizard-content">

                    <!-- ===================== PASO 1: INFORMACIÓN BÁSICA ===================== -->
                    <div class="wizard-pane active" data-step="1">
                        <h5 class="mb-3">
                            <i class="fas fa-info-circle text-primary me-2"></i>
                            Paso 1: Información Básica
                        </h5>
                        <div class="row g-3">

                            <!-- IMÁGENES -->
                            <div class="col-12">
                                <label class="form-label fw-semibold">Imágenes del Producto</label>
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="{{ form.imagen.id_for_label }}" class="form-label small">Imagen Principal</label>
                                        {% if form.instance.imagen %}
                                        <div class="mb-2">
                                            <img src="{{ form.instance.imagen.url }}" alt="Imagen Principal"
                                                class="img-thumbnail" style="max-height: 150px; display:block;">
                                            <span class="badge bg-success mt-1 d-inline-block">
                                                <i class="fas fa-check me-1"></i>Imagen actual
                                            </span>
                                            <div class="form-text text-warning">
                                                <i class="fas fa-info-circle me-1"></i>Sube una nueva para reemplazarla
                                            </div>
                                        </div>
                                        {% endif %}
                                        <input type="file" class="form-control mt-1"
                                            id="{{ form.imagen.id_for_label }}"
                                            name="{{ form.imagen.name }}" accept="image/*">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.imagen_2.id_for_label }}" class="form-label small">Imagen 2</label>
                                        {% if form.instance.imagen_2 %}
                                        <div class="mb-2">
                                            <img src="{{ form.instance.imagen_2.url }}" alt="Imagen 2"
                                                class="img-thumbnail" style="max-height: 150px; display:block;">
                                            <span class="badge bg-success mt-1 d-inline-block">
                                                <i class="fas fa-check me-1"></i>Imagen actual
                                            </span>
                                            <div class="form-text text-warning">
                                                <i class="fas fa-info-circle me-1"></i>Sube una nueva para reemplazarla
                                            </div>
                                        </div>
                                        {% endif %}
                                        <input type="file" class="form-control mt-1"
                                            id="{{ form.imagen_2.id_for_label }}"
                                            name="{{ form.imagen_2.name }}" accept="image/*">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="{{ form.imagen_3.id_for_label }}" class="form-label small">Imagen 3</label>
                                        {% if form.instance.imagen_3 %}
                                        <div class="mb-2">
                                            <img src="{{ form.instance.imagen_3.url }}" alt="Imagen 3"
                                                class="img-thumbnail" style="max-height: 150px; display:block;">
                                            <span class="badge bg-success mt-1 d-inline-block">
                                                <i class="fas fa-check me-1"></i>Imagen actual
                                            </span>
                                            <div class="form-text text-warning">
                                                <i class="fas fa-info-circle me-1"></i>Sube una nueva para reemplazarla
                                            </div>
                                        </div>
                                        {% endif %}
                                        <input type="file" class="form-control mt-1"
                                            id="{{ form.imagen_3.id_for_label }}"
                                            name="{{ form.imagen_3.name }}" accept="image/*">
                                    </div>
                                </div>
                                <div class="form-text">Sube hasta 3 imágenes para mostrar en el e-commerce externo.</div>
                            </div>

                            <!-- NOMBRE -->
                            <div class="col-12">
                                <label for="{{ form.nombre.id_for_label }}" class="form-label fw-semibold required">Nombre del Producto</label>
                                <input type="text" class="form-control"
                                    id="{{ form.nombre.id_for_label }}"
                                    name="{{ form.nombre.name }}"
                                    value="{{ form.nombre.value|default:'' }}"
                                    placeholder="Ej: Filtro de aceite para motor"
                                    data-required="true" autocomplete="off">
                                <div class="invalid-feedback"></div>
                            </div>

                            <!-- CÓDIGO -->
                            <div class="col-md-6">
                                <label for="{{ form.codigo_unico.id_for_label }}" class="form-label fw-semibold required">Código del Producto</label>
                                <div class="input-group">
                                    <input type="text" class="form-control"
                                        id="{{ form.codigo_unico.id_for_label }}"
                                        name="{{ form.codigo_unico.name }}"
                                        value="{{ form.codigo_unico.value|default:'' }}"
                                        placeholder="Se generará automáticamente"
                                        data-required="true" autocomplete="off">
                                    <button type="button" class="btn btn-outline-success" id="btn-generar-codigo"
                                        title="Generar código automáticamente">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback"></div>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>Se genera automático o puedes editarlo
                                </small>
                            </div>

                            <!-- CATEGORÍA -->
                            <div class="col-md-6">
                                <label for="{{ form.categoria.id_for_label }}" class="form-label fw-semibold required">Categoría</label>
                                <select class="form-select" id="{{ form.categoria.id_for_label }}"
                                    name="{{ form.categoria.name }}" data-required="true">
                                    <option value="">-- Seleccionar --</option>
                                    {% for choice in form.categoria.field.queryset %}
                                    <option value="{{ choice.pk }}" data-porcentaje="{{ choice.porcentaje_ganancia }}" {% if form.categoria.value|stringformat:"s" == choice.pk|stringformat:"s" %}selected{% endif %}>
                                        {{ choice }} ({{ choice.porcentaje_ganancia }}%)
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>

                            <!-- MARCA -->
                            <div class="col-md-6">
                                <label for="{{ form.marca.id_for_label }}" class="form-label fw-semibold required">Marca</label>
                                <select class="form-select" id="{{ form.marca.id_for_label }}"
                                    name="{{ form.marca.name }}" data-required="true">
                                    <option value="">-- Seleccionar --</option>
                                    {% for choice in form.marca.field.queryset %}
                                    <option value="{{ choice.pk }}" {% if form.marca.value|stringformat:"s" == choice.pk|stringformat:"s" %}selected{% endif %}>
                                        {{ choice }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>

                            <!-- DESCRIPCIÓN -->
                            <div class="col-12">
                                <label for="{{ form.descripcion.id_for_label }}" class="form-label fw-semibold">Descripción (Opcional)</label>
                                <textarea class="form-control" id="{{ form.descripcion.id_for_label }}"
                                    name="{{ form.descripcion.name }}" rows="3"
                                    placeholder="Descripción detallada del producto...">{{ form.descripcion.value|default:'' }}</textarea>
                            </div>

                        </div>
                    </div>

                    <!-- ===================== PASO 2: PRECIOS Y STOCK ===================== -->
                    <div class="wizard-pane" data-step="2">
                        <h5 class="mb-3">
                            <i class="fas fa-dollar-sign text-success me-2"></i>
                            Paso 2: Precios y Stock
                        </h5>
                        <div class="row g-3">

                            <!-- PRECIO COMPRA — FIX: stringformat:".2f" siempre genera punto decimal, nunca coma -->
                            <div class="col-md-6">
                                <label for="{{ form.precio_compra.id_for_label }}" class="form-label fw-semibold required">Precio de Compra</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control"
                                        id="{{ form.precio_compra.id_for_label }}"
                                        name="{{ form.precio_compra.name }}"
                                        value="{% if form.instance.pk %}{{ form.instance.precio_compra|stringformat:'.2f' }}{% else %}{{ form.precio_compra.value|default:'' }}{% endif %}"
                                        step="0.01" min="0" placeholder="0.00"
                                        data-required="true" autocomplete="off">
                                </div>
                                <div class="invalid-feedback"></div>
                                <small class="text-muted">Se calculará automáticamente el precio de venta</small>
                            </div>

                            <!-- PRECIO VENTA — FIX: mismo fix con stringformat -->
                            <div class="col-md-6">
                                <label for="{{ form.precio_venta.id_for_label }}" class="form-label fw-semibold required">Precio de Venta</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control"
                                        id="{{ form.precio_venta.id_for_label }}"
                                        name="{{ form.precio_venta.name }}"
                                        value="{% if form.instance.pk %}{{ form.instance.precio_venta|stringformat:'.2f' }}{% else %}{{ form.precio_venta.value|default:'' }}{% endif %}"
                                        step="0.01" min="0" placeholder="0.00"
                                        data-required="true" autocomplete="off">
                                    <button type="button" id="btn-calcular-precio" class="btn btn-outline-primary" tabindex="-1">
                                        <i class="fas fa-calculator"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>

                            <!-- STOCK ACTUAL (solo lectura, referencia visual) -->
                            <div class="col-12">
                                <div class="alert alert-info py-2 mb-0">
                                    <div class="d-flex align-items-center gap-3 flex-wrap">
                                        <div>
                                            <i class="fas fa-boxes me-1"></i>
                                            <strong>Stock actual en sistema:</strong>
                                            <span class="fs-5 fw-bold text-success ms-2" id="stock_actual_display">
                                                {{ form.instance.stock_actual|default:form.stock_actual.value|default:0 }}
                                            </span>
                                            <span class="text-muted ms-1">unidades</span>
                                        </div>
                                        {% if not es_nuevo %}
                                        <div class="text-muted small">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Usa el campo "Agregar stock" para sumar unidades nuevas
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <!-- CAMPO OCULTO stock_actual (el que se envía al servidor) -->
                            <input type="hidden"
                                id="{{ form.stock_actual.id_for_label }}"
                                name="{{ form.stock_actual.name }}"
                                value="{{ form.instance.stock_actual|default:form.stock_actual.value|default:0 }}"
                                data-required="true">

                            <!-- AGREGAR / STOCK INICIAL -->
                            <div class="col-md-4">
                                <label for="stock_agregar" class="form-label fw-semibold">
                                    {% if es_nuevo %}Stock Inicial{% else %}Agregar al Stock <span class="badge bg-info ms-1">Opcional</span>{% endif %}
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text text-success"><i class="fas fa-plus"></i></span>
                                    <input type="number" class="form-control" id="stock_agregar"
                                        name="stock_agregar"
                                        value="{% if es_nuevo %}{{ form.stock_actual.value|default:'' }}{% endif %}"
                                        min="0"
                                        placeholder="{% if es_nuevo %}Cantidad inicial{% else %}Ej: 5 unidades nuevas{% endif %}"
                                        autocomplete="off">
                                    {% if not es_nuevo %}
                                    <button type="button" class="btn btn-success" id="btn-aplicar-stock" title="Aplicar suma">
                                        <i class="fas fa-check me-1"></i>Sumar
                                    </button>
                                    {% endif %}
                                </div>
                                {% if es_nuevo %}
                                <small class="text-muted">Cantidad con la que inicia el producto</small>
                                {% else %}
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Ingresa cuántas unidades compraste — se sumarán al stock actual
                                </small>
                                {% endif %}
                            </div>

                            <!-- STOCK MÍNIMO -->
                            <div class="col-md-4">
                                <label for="{{ form.stock_minimo.id_for_label }}" class="form-label fw-semibold required">Stock Mínimo</label>
                                <input type="number" class="form-control"
                                    id="{{ form.stock_minimo.id_for_label }}"
                                    name="{{ form.stock_minimo.name }}"
                                    value="{% if form.instance.pk %}{{ form.instance.stock_minimo|stringformat:'d' }}{% else %}{{ form.stock_minimo.value|default:'' }}{% endif %}"
                                    min="0" placeholder="Cantidad mínima"
                                    data-required="true" autocomplete="off">
                                <div class="invalid-feedback"></div>
                                <small class="text-muted">Para alertas de reabastecimiento</small>
                            </div>

                            <!-- UBICACIÓN -->
                            <div class="col-md-4">
                                <label for="{{ form.ubicacion_almacen.id_for_label }}" class="form-label fw-semibold">Ubicación (Opcional)</label>
                                <input type="text" class="form-control"
                                    id="{{ form.ubicacion_almacen.id_for_label }}"
                                    name="{{ form.ubicacion_almacen.name }}"
                                    value="{{ form.ubicacion_almacen.value|default:'' }}"
                                    placeholder="Ej: A-1" autocomplete="off">
                            </div>

                        </div>
                    </div>

                    <!-- ===================== PASO 3: CONFIGURACIÓN ===================== -->
                    <div class="wizard-pane" data-step="3">
                        <h5 class="mb-3">
                            <i class="fas fa-cog text-info me-2"></i>
                            Paso 3: Configuración
                        </h5>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Estado del Producto</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input"
                                                id="{{ form.activo.id_for_label }}"
                                                name="{{ form.activo.name }}"
                                                value="True"
                                                {% if form.activo.value or es_nuevo %}checked{% endif %}>
                                            <label for="{{ form.activo.id_for_label }}" class="form-check-label">
                                                Producto activo
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Configuración Fiscal</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input"
                                                id="{{ form.incluye_iva.id_for_label }}"
                                                name="{{ form.incluye_iva.name }}"
                                                value="True"
                                                {% if form.incluye_iva.value %}checked{% endif %}>
                                            <label for="{{ form.incluye_iva.id_for_label }}" class="form-check-label">
                                                Incluye IVA
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ===================== PASO 4: REVISIÓN ===================== -->
                    <div class="wizard-pane" data-step="4">
                        <h5 class="mb-3">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            Paso 4: Revisar Información
                        </h5>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Revisa que toda la información sea correcta antes de guardar
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <strong>Información Básica</strong>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-sm mb-0">
                                            <tr>
                                                <td width="40%"><strong>Nombre:</strong></td>
                                                <td id="review-nombre">-</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Código:</strong></td>
                                                <td id="review-codigo">-</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Categoría:</strong></td>
                                                <td id="review-categoria">-</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Marca:</strong></td>
                                                <td id="review-marca">-</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <strong>Precios y Stock</strong>
                                    </div>
                                    <div class="card-body">
                                        <table class="table table-sm mb-0">
                                            <tr>
                                                <td width="40%"><strong>P. Compra:</strong></td>
                                                <td id="review-precio-compra">-</td>
                                            </tr>
                                            <tr>
                                                <td><strong>P. Venta:</strong></td>
                                                <td id="review-precio-venta">-</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Stock Final:</strong></td>
                                                <td id="review-stock">-</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Stock Mínimo:</strong></td>
                                                <td id="review-stock-minimo">-</td>
                                            </tr>
                                            <tr>
                                                <td><strong>Ubicación:</strong></td>
                                                <td id="review-ubicacion">-</td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Botones de navegación -->
                <div class="row mt-4 pt-3 border-top">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <button type="button" class="btn btn-outline-secondary" id="btn-prev">
                                <i class="fas fa-arrow-left me-1"></i> Anterior
                            </button>
                            <small class="text-muted">Paso <span id="current-step">1</span> de 4</small>
                            <div>
                                <button type="button" class="btn btn-primary" id="btn-next">
                                    Siguiente <i class="fas fa-arrow-right ms-1"></i>
                                </button>
                                <button type="submit" class="btn btn-success d-none" id="btn-submit">
                                    <i class="fas fa-save me-1"></i> Guardar Producto
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block inventory_js %}
<script>
$(document).ready(function () {

    // ==================== VARIABLES GLOBALES ====================
    const esEdicion = {% if not es_nuevo %}true{% else %}false{% endif %};
    const STORAGE_KEY = 'producto_borrador';
    let currentStep = 1;
    const totalSteps = 4;
    let formSubmitting = false;
    const stockOriginal = parseInt($('#id_stock_actual').val()) || 0;

    // ==================== PREVENIR ENTER ====================
    $('#producto-form').on('keypress', function (e) {
        if (e.which === 13 || e.keyCode === 13) {
            e.preventDefault();
            return false;
        }
    });

    // ==================== GENERAR CÓDIGO ÚNICO ====================
    function generarCodigoUnico() {
        const timestamp = Date.now().toString(36).toUpperCase();
        const random = Math.random().toString(36).substring(2, 6).toUpperCase();
        return `PROD-${timestamp}-${random}`;
    }

    function inicializarCodigo() {
        const $codigoInput = $('#id_codigo_unico');
        if (!$codigoInput.val() || $codigoInput.val().trim() === '') {
            $codigoInput.val(generarCodigoUnico());
            $codigoInput.addClass('campo-generado');
            setTimeout(() => $codigoInput.removeClass('campo-generado'), 2000);
        }
    }

    $('#btn-generar-codigo').on('click', function (e) {
        e.preventDefault();
        e.stopPropagation();
        const $btn = $(this);
        const $input = $('#id_codigo_unico');
        if ($input.val() && $input.val().trim() !== '') {
            if (!confirm('¿Estás seguro de generar un nuevo código? El código actual se perderá.')) return;
        }
        $btn.html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);
        setTimeout(() => {
            $input.val(generarCodigoUnico());
            $input.addClass('campo-generado');
            setTimeout(() => $input.removeClass('campo-generado'), 2000);
            $btn.html('<i class="fas fa-sync-alt"></i>').prop('disabled', false);
            mostrarNotificacion('Código generado exitosamente', 'success');
            if (!esEdicion) autoGuardar();
        }, 500);
    });

    // ==================== GESTIÓN DE STOCK ====================
    if (esEdicion) {
        // Modo edición: stock_agregar suma al stock original
        $('#btn-aplicar-stock').on('click', function (e) {
            e.preventDefault();
            const stockAgregar = parseInt($('#stock_agregar').val()) || 0;
            if (stockAgregar <= 0) {
                mostrarNotificacion('Ingresa una cantidad mayor a 0', 'warning');
                $('#stock_agregar').focus();
                return;
            }
            const nuevoStock = stockOriginal + stockAgregar;
            $('#id_stock_actual').val(nuevoStock);
            $('#stock_actual_display').text(nuevoStock).addClass('text-primary').removeClass('text-success');
            setTimeout(() => $('#stock_actual_display').removeClass('text-primary').addClass('text-success'), 1500);
            mostrarNotificacion(`✅ Stock: ${stockOriginal} + ${stockAgregar} = ${nuevoStock} unidades`, 'success');
        });

        // Preview en tiempo real
        $('#stock_agregar').on('input', function () {
            const stockAgregar = parseInt($(this).val()) || 0;
            if (stockAgregar > 0) {
                $('#stock_actual_display').text(stockOriginal + stockAgregar).addClass('text-primary').removeClass('text-success');
            } else {
                $('#id_stock_actual').val(stockOriginal);
                $('#stock_actual_display').text(stockOriginal).removeClass('text-primary').addClass('text-success');
            }
        });

        $('#stock_agregar').on('blur', function () {
            if (!$(this).val()) {
                $('#id_stock_actual').val(stockOriginal);
                $('#stock_actual_display').text(stockOriginal).removeClass('text-primary').addClass('text-success');
            }
        });

    } else {
        // Modo nuevo: stock_agregar ES el stock inicial
        $('#stock_agregar').on('input', function () {
            const val = parseInt($(this).val()) || 0;
            $('#id_stock_actual').val(val);
            $('#stock_actual_display').text(val);
        });
    }

    // ==================== AUTO-GUARDAR (solo productos nuevos) ====================
    function autoGuardar() {
        if (esEdicion) return;
        const formData = {
            nombre: $('#id_nombre').val(),
            codigo_unico: $('#id_codigo_unico').val(),
            categoria: $('#id_categoria').val(),
            marca: $('#id_marca').val(),
            descripcion: $('#id_descripcion').val(),
            precio_compra: $('#id_precio_compra').val(),
            precio_venta: $('#id_precio_venta').val(),
            stock_actual: $('#stock_agregar').val(),
            stock_minimo: $('#id_stock_minimo').val(),
            ubicacion_almacen: $('#id_ubicacion_almacen').val(),
            activo: $('#id_activo').is(':checked'),
            incluye_iva: $('#id_incluye_iva').is(':checked'),
            currentStep: currentStep
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(formData));
        mostrarIndicadorGuardado();
    }

    function cargarDatosGuardados() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (!saved) return;
        const formData = JSON.parse(saved);
        if (formData.nombre || formData.codigo_unico) {
            $('#id_nombre').val(formData.nombre || '');
            $('#id_codigo_unico').val(formData.codigo_unico || '');
            $('#id_categoria').val(formData.categoria || '');
            $('#id_marca').val(formData.marca || '');
            $('#id_descripcion').val(formData.descripcion || '');
            $('#id_precio_compra').val(formData.precio_compra || '');
            $('#id_precio_venta').val(formData.precio_venta || '');
            $('#stock_agregar').val(formData.stock_actual || '');
            $('#id_stock_actual').val(formData.stock_actual || 0);
            $('#id_stock_minimo').val(formData.stock_minimo || '');
            $('#id_ubicacion_almacen').val(formData.ubicacion_almacen || '');
            $('#id_activo').prop('checked', formData.activo !== false);
            $('#id_incluye_iva').prop('checked', formData.incluye_iva === true);
            if (formData.currentStep) currentStep = formData.currentStep;
            mostrarAlertaRecuperacion();
        }
    }

    function mostrarAlertaRecuperacion() {
        const alertDiv = $(`
            <div class="alert alert-warning alert-dismissible fade show">
                <i class="fas fa-history me-2"></i>
                <strong>Borrador recuperado</strong> - Continúa donde lo dejaste
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                <button type="button" class="btn btn-sm btn-outline-danger ms-2" id="btn-descartar-borrador">
                    <i class="fas fa-trash me-1"></i>Descartar y empezar de nuevo
                </button>
            </div>
        `);
        $('.container-fluid').prepend(alertDiv);
        $('#btn-descartar-borrador').on('click', function () {
            if (confirm('¿Descartar el borrador y empezar de nuevo?')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        });
        setTimeout(() => alertDiv.fadeOut(() => alertDiv.remove()), 10000);
    }

    function mostrarIndicadorGuardado() {
        $('#indicador-guardado').remove();
        const ind = $('<div id="indicador-guardado" class="position-fixed bottom-0 end-0 m-3" style="z-index: 1050;"><div class="bg-success text-white px-3 py-2 rounded shadow-sm"><i class="fas fa-check me-1"></i> Guardado</div></div>');
        $('body').append(ind);
        setTimeout(() => ind.fadeOut(400, () => ind.remove()), 1500);
    }

    let autoGuardarTimeout;
    $('#producto-form input, #producto-form select, #producto-form textarea').on('input change', function () {
        if (!esEdicion) {
            clearTimeout(autoGuardarTimeout);
            autoGuardarTimeout = setTimeout(autoGuardar, 500);
        }
    });

    // ==================== VALIDACIÓN ====================
    function validarPaso(step) {
        let isValid = true;
        let firstInvalid = null;

        if (step === 2 && !esEdicion) {
            const stockVal = parseInt($('#stock_agregar').val());
            if (isNaN(stockVal) || stockVal < 0) {
                $('#stock_agregar').addClass('is-invalid');
                isValid = false;
                if (!firstInvalid) firstInvalid = $('#stock_agregar');
            } else {
                $('#stock_agregar').removeClass('is-invalid');
                $('#id_stock_actual').val(stockVal);
            }
        }

        $(`.wizard-pane[data-step="${step}"] [data-required="true"]`).each(function () {
            const $field = $(this);
            const value = $field.val();
            $field.removeClass('is-invalid');
            $field.siblings('.invalid-feedback').text('');
            if (!value || value === '') {
                isValid = false;
                $field.addClass('is-invalid');
                const label = $field.closest('.col-12, .col-md-6, .col-md-4').find('label').first().text().replace('*', '').trim();
                $field.siblings('.invalid-feedback').text(`${label} es obligatorio`);
                if (!firstInvalid) firstInvalid = $field;
            }
            if ($field.attr('type') === 'number' && value) {
                if (parseFloat(value) < 0) {
                    isValid = false;
                    $field.addClass('is-invalid');
                    $field.siblings('.invalid-feedback').text('No puede ser negativo');
                    if (!firstInvalid) firstInvalid = $field;
                }
            }
        });

        if (!isValid && firstInvalid) firstInvalid.focus();
        return isValid;
    }

    // ==================== WIZARD UI ====================
    function actualizarWizardUI() {
        $('.wizard-step').removeClass('active completed');
        $(`.wizard-step[data-step="${currentStep}"]`).addClass('active');
        for (let i = 1; i < currentStep; i++) {
            $(`.wizard-step[data-step="${i}"]`).addClass('completed');
        }
        $('.wizard-pane').removeClass('active');
        $(`.wizard-pane[data-step="${currentStep}"]`).addClass('active');
        $('#current-step').text(currentStep);
        $('#btn-prev').prop('disabled', currentStep === 1);
        if (currentStep === totalSteps) {
            $('#btn-next').addClass('d-none');
            $('#btn-submit').removeClass('d-none');
            actualizarResumen();
        } else {
            $('#btn-next').removeClass('d-none');
            $('#btn-submit').addClass('d-none');
        }
        if (!esEdicion) autoGuardar();
    }

    function actualizarResumen() {
        $('#review-nombre').text($('#id_nombre').val() || '-');
        $('#review-codigo').text($('#id_codigo_unico').val() || '-');
        $('#review-categoria').text($('#id_categoria option:selected').text() || '-');
        $('#review-marca').text($('#id_marca option:selected').text() || '-');
        const pc = parseFloat($('#id_precio_compra').val()) || 0;
        const pv = parseFloat($('#id_precio_venta').val()) || 0;
        $('#review-precio-compra').html(`<strong>$${pc.toFixed(2)}</strong>`);
        $('#review-precio-venta').html(`<strong>$${pv.toFixed(2)}</strong>`);
        const stockFinal = parseInt($('#id_stock_actual').val()) || 0;
        const stockAgregado = parseInt($('#stock_agregar').val()) || 0;
        if (esEdicion && stockAgregado > 0) {
            $('#review-stock').html(`<strong>${stockFinal}</strong> <span class="badge bg-success">+${stockAgregado} nuevas</span>`);
        } else {
            $('#review-stock').html(`<strong>${stockFinal}</strong>`);
        }
        $('#review-stock-minimo').text($('#id_stock_minimo').val() || '0');
        $('#review-ubicacion').text($('#id_ubicacion_almacen').val() || 'Sin ubicación');
    }

    // ==================== NAVEGACIÓN ====================
    $('#btn-next').on('click', function (e) {
        e.preventDefault();
        if (validarPaso(currentStep)) {
            currentStep++;
            actualizarWizardUI();
            $('html, body').animate({ scrollTop: 0 }, 300);
        }
    });

    $('#btn-prev').on('click', function (e) {
        e.preventDefault();
        if (currentStep > 1) {
            currentStep--;
            actualizarWizardUI();
            $('html, body').animate({ scrollTop: 0 }, 300);
        }
    });

    // ==================== ENVIAR FORMULARIO ====================
    $('#producto-form').on('submit', function (e) {
        if (formSubmitting) return true;
        e.preventDefault();
        if (currentStep !== 4) {
            mostrarNotificacion('Debes completar todos los pasos antes de guardar', 'warning');
            return false;
        }
        for (let i = 1; i <= 3; i++) {
            if (!validarPaso(i)) {
                currentStep = i;
                actualizarWizardUI();
                mostrarNotificacion(`Por favor completa el Paso ${i}`, 'warning');
                return false;
            }
        }
        localStorage.removeItem(STORAGE_KEY);
        $('#btn-submit').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Guardando...');
        formSubmitting = true;
        this.submit();
    });

    // ==================== CALCULAR PRECIO ====================
    $('#btn-calcular-precio').on('click', function (e) {
        e.preventDefault();
        e.stopPropagation();
        const pc = parseFloat($('#id_precio_compra').val());
        const cat = $('#id_categoria').val();
        if (!pc || pc <= 0) {
            mostrarNotificacion('Ingresa precio de compra', 'warning');
            $('#id_precio_compra').focus();
            return;
        }
        if (!cat) {
            mostrarNotificacion('Selecciona categoría', 'warning');
            $('#id_categoria').focus();
            return;
        }
        $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
        $.ajax({
            url: '{% url "inventario:calcular_precio_venta" %}',
            method: 'GET',
            data: { precio_compra: pc, categoria_id: cat },
            success: function (response) {
                if (response.success) {
                    $('#id_precio_venta').val(response.precio_venta.toFixed(2));
                    mostrarNotificacion(`Precio calculado: $${response.precio_venta.toFixed(2)}`, 'success');
                    if (!esEdicion) autoGuardar();
                } else {
                    mostrarNotificacion(response.message || 'Error al calcular precio', 'danger');
                }
            },
            error: function () {
                mostrarNotificacion('Error al calcular precio', 'danger');
            },
            complete: function () {
                $('#btn-calcular-precio').prop('disabled', false).html('<i class="fas fa-calculator"></i>');
            }
        });
    });

    // ==================== NOTIFICACIONES ====================
    function mostrarNotificacion(mensaje, tipo) {
        $('.toast-notification').remove();
        const icon = tipo === 'success' ? 'check-circle' : tipo === 'warning' ? 'exclamation-triangle' : 'times-circle';
        const toast = $(`<div class="toast-notification position-fixed top-0 end-0 m-3" style="z-index: 9999;"><div class="alert alert-${tipo} alert-dismissible fade show"><i class="fas fa-${icon} me-2"></i>${mensaje}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div></div>`);
        $('body').append(toast);
        if (tipo === 'success') setTimeout(() => toast.fadeOut(500, () => toast.remove()), 3000);
    }

    // ==================== INICIALIZACIÓN ====================
    if (esEdicion) {
        localStorage.removeItem(STORAGE_KEY);
    } else {
        cargarDatosGuardados();
        if (!$('#id_codigo_unico').val() || $('#id_codigo_unico').val().trim() === '') {
            inicializarCodigo();
        }
    }

    actualizarWizardUI();
});
</script>

<style>
    .wizard-progress {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 2rem;
    }
    .wizard-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 0 0 auto;
    }
    .wizard-step-circle {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: #e9ecef;
        border: 3px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #6c757d;
        transition: all 0.3s;
    }
    .wizard-step.active .wizard-step-circle {
        background: #0d6efd;
        border-color: #0d6efd;
        color: white;
    }
    .wizard-step.completed .wizard-step-circle {
        background: #28a745;
        border-color: #28a745;
        color: white;
    }
    .wizard-step-label {
        margin-top: 0.5rem;
        font-size: 0.75rem;
        font-weight: 500;
        color: #6c757d;
    }
    .wizard-step.active .wizard-step-label {
        color: #0d6efd;
        font-weight: 600;
    }
    .wizard-step-line {
        flex: 1;
        height: 3px;
        background: #dee2e6;
        margin: 0 1rem;
        position: relative;
        top: -20px;
    }
    .wizard-step.completed ~ .wizard-step-line {
        background: #28a745;
    }
    .wizard-pane {
        display: none;
    }
    .wizard-pane.active {
        display: block;
        animation: fadeIn 0.3s;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to   { opacity: 1; transform: translateY(0); }
    }
    .required::after {
        content: " *";
        color: #dc3545;
    }
    .campo-generado {
        background-color: #d4edda !important;
        border-color: #28a745 !important;
        transition: all 0.5s ease;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
    #stock_actual_display {
        transition: color 0.4s ease;
    }
    @media (max-width: 768px) {
        .wizard-progress { padding: 0.5rem; }
        .wizard-step-circle { width: 35px; height: 35px; }
        .wizard-step-label { font-size: 0.65rem; }
    }
</style>
{% endblock %}