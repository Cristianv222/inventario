{% extends 'base.html' %}
{% load static %}

{% block title %}Reportes de Clientes - VPMOTOS{% endblock %}

{% block extra_css %}
<style>
    .report-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }
    
    .report-header::before {
        content: 'üìä';
        position: absolute;
        font-size: 8rem;
        opacity: 0.1;
        right: 2rem;
        top: -1rem;
    }
    
    .metric-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        text-align: center;
        transition: transform 0.3s ease;
        border-left: 4px solid;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
    }
    
    .metric-card.primary { border-left-color: #007bff; }
    .metric-card.success { border-left-color: #28a745; }
    .metric-card.warning { border-left-color: #ffc107; }
    .metric-card.danger { border-left-color: #dc3545; }
    .metric-card.info { border-left-color: #17a2b8; }
    
    .metric-number {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
        display: block;
    }
    
    .metric-label {
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .table-container {
        background: white;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .table-header {
        background: linear-gradient(45deg, #f8f9fa, #e9ecef);
        padding: 1.5rem;
        border-bottom: 1px solid #dee2e6;
    }
    
    .ranking-item {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #f8f9fa;
        transition: background-color 0.3s ease;
    }
    
    .ranking-item:hover {
        background-color: rgba(0,123,255,0.05);
    }
    
    .ranking-item:last-child {
        border-bottom: none;
    }
    
    .ranking-position {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
    }
    
    .position-1 { background: #ffd700; color: #333; }
    .position-2 { background: #c0c0c0; color: #333; }
    .position-3 { background: #cd7f32; color: white; }
    .position-other { background: #6c757d; }
    
    .period-selector {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .filter-btn {
        padding: 0.5rem 1rem;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        background: white;
        margin: 0.25rem;
        transition: all 0.3s ease;
    }
    
    .filter-btn:hover,
    .filter-btn.active {
        border-color: #007bff;
        background: #007bff;
        color: white;
    }
    
    .progress-custom {
        height: 8px;
        border-radius: 10px;
        background: #f8f9fa;
    }
    
    .progress-bar-custom {
        border-radius: 10px;
        transition: width 0.6s ease;
    }
    
    .export-buttons {
        position: sticky;
        top: 100px;
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    
    .trend-up {
        color: #28a745;
    }
    
    .trend-down {
        color: #dc3545;
    }
    
    .trend-neutral {
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header del Reporte -->
    <div class="report-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h2 mb-2">
                    <i class="fas fa-chart-bar me-3"></i>
                    Reportes de Clientes
                </h1>
                <p class="mb-0 opacity-75">
                    An√°lisis detallado del comportamiento y estad√≠sticas de clientes
                </p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-light btn-lg" onclick="window.print()">
                    <i class="fas fa-print me-2"></i>Imprimir Reporte
                </button>
            </div>
        </div>
    </div>

    <!-- Selector de Per√≠odo -->
    <div class="period-selector">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h6 class="mb-0">Per√≠odo de An√°lisis</h6>
                <small class="text-muted">Selecciona el rango de fechas para el reporte</small>
            </div>
            <div class="col-md-6 text-end">
                <button class="filter-btn active" data-period="month">Este Mes</button>
                <button class="filter-btn" data-period="quarter">Trimestre</button>
                <button class="filter-btn" data-period="year">Este A√±o</button>
                <button class="filter-btn" data-period="all">Todo el Tiempo</button>
            </div>
        </div>
    </div>

    <!-- M√©tricas Principales -->
    <div class="row mb-4">
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="metric-card primary">
                <span class="metric-number text-primary" id="totalClientes">{{ stats.total_clientes|default:0 }}</span>
                <div class="metric-label">Total Clientes</div>
                <small class="trend-up">
                    <i class="fas fa-arrow-up"></i> +12% vs mes anterior
                </small>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="metric-card success">
                <span class="metric-number text-success" id="clientesActivos">{{ stats.clientes_activos|default:0 }}</span>
                <div class="metric-label">Clientes Activos</div>
                <small class="trend-up">
                    <i class="fas fa-arrow-up"></i> +8% vs mes anterior
                </small>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="metric-card warning">
                <span class="metric-number text-warning" id="clientesConPuntos">{{ stats.clientes_con_puntos|default:0 }}</span>
                <div class="metric-label">Con Puntos</div>
                <small class="trend-up">
                    <i class="fas fa-arrow-up"></i> +25% vs mes anterior
                </small>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="metric-card info">
                <span class="metric-number text-info" id="nuevosEsteMes">{{ stats.nuevos_este_mes|default:0 }}</span>
                <div class="metric-label">Nuevos Este Mes</div>
                <small class="trend-up">
                    <i class="fas fa-arrow-up"></i> +15% vs mes anterior
                </small>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="metric-card danger">
                <span class="metric-number text-danger" id="totalPuntos">{{ stats.total_puntos|default:0|floatformat:0 }}</span>
                <div class="metric-label">Puntos en Sistema</div>
                <small class="trend-up">
                    <i class="fas fa-arrow-up"></i> +18% vs mes anterior
                </small>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="metric-card primary">
                <span class="metric-number text-primary">$<span id="valorPromedio">{{ stats.ticket_promedio|default:0|floatformat:0 }}</span></span>
                <div class="metric-label">Ticket Promedio</div>
                <small class="trend-neutral">
                    <i class="fas fa-minus"></i> Sin cambios
                </small>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Columna Principal -->
        <div class="col-lg-8">
            <!-- Gr√°fico de Registros por Mes -->
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="fas fa-chart-line me-2"></i>
                    Registros de Clientes por Mes
                </h5>
                <canvas id="registrosChart" height="100"></canvas>
            </div>

            <!-- Distribuci√≥n por Tipo de Identificaci√≥n -->
            <div class="chart-container">
                <h5 class="mb-3">
                    <i class="fas fa-chart-pie me-2"></i>
                    Distribuci√≥n por Tipo de Identificaci√≥n
                </h5>
                <div class="row">
                    <div class="col-md-6">
                        <canvas id="tipoIdChart" height="200"></canvas>
                    </div>
                    <div class="col-md-6">
                        <div class="mt-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>C√©dula</span>
                                <span class="fw-bold">85%</span>
                            </div>
                            <div class="progress-custom mb-3">
                                <div class="progress-bar-custom bg-primary" style="width: 85%"></div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>RUC</span>
                                <span class="fw-bold">12%</span>
                            </div>
                            <div class="progress-custom mb-3">
                                <div class="progress-bar-custom bg-success" style="width: 12%"></div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>Pasaporte</span>
                                <span class="fw-bold">3%</span>
                            </div>
                            <div class="progress-custom">
                                <div class="progress-bar-custom bg-warning" style="width: 3%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Clientes por Compras -->
            <div class="table-container">
                <div class="table-header">
                    <h5 class="mb-0">
                        <i class="fas fa-trophy me-2"></i>
                        Top 10 Clientes por Valor de Compras
                    </h5>
                </div>
                
                {% if clientes_frecuentes %}
                    {% for cliente in clientes_frecuentes %}
                    <div class="ranking-item">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <div class="ranking-position position-{% if forloop.counter <= 3 %}{{ forloop.counter }}{% else %}other{% endif %}">
                                    {{ forloop.counter }}
                                </div>
                            </div>
                            <div class="col">
                                <h6 class="mb-1">{{ cliente.get_nombre_completo }}</h6>
                                <small class="text-muted">{{ cliente.identificacion }}</small>
                            </div>
                            <div class="col-auto text-center">
                                <div class="fw-bold text-primary">${{ cliente.valor_total|default:0|floatformat:0 }}</div>
                                <small class="text-muted">{{ cliente.total_compras }} compras</small>
                            </div>
                            <div class="col-auto">
                                <span class="badge bg-warning">
                                    {{ cliente.puntos_disponibles|default:0 }} pts
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No hay datos suficientes</h5>
                        <p class="text-muted">Los datos aparecer√°n cuando haya m√°s actividad de clientes.</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Sidebar Derecho -->
        <div class="col-lg-4">
            <!-- Botones de Exportaci√≥n -->
            <div class="export-buttons mb-4">
                <h6 class="mb-3">
                    <i class="fas fa-download me-2"></i>
                    Exportar Datos
                </h6>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-success" onclick="exportarExcel()">
                        <i class="fas fa-file-excel me-2"></i>Exportar a Excel
                    </button>
                    
                    <button class="btn btn-outline-danger" onclick="exportarPDF()">
                        <i class="fas fa-file-pdf me-2"></i>Exportar a PDF
                    </button>
                    
                    <button class="btn btn-outline-primary" onclick="exportarCSV()">
                        <i class="fas fa-file-csv me-2"></i>Exportar a CSV
                    </button>
                    
                    <hr>
                    
                    <button class="btn btn-outline-info" onclick="enviarPorEmail()">
                        <i class="fas fa-envelope me-2"></i>Enviar por Email
                    </button>
                </div>
            </div>

            <!-- Top Clientes por Puntos -->
            <div class="table-container mb-4">
                <div class="table-header">
                    <h6 class="mb-0">
                        <i class="fas fa-star me-2"></i>
                        Top Clientes por Puntos
                    </h6>
                </div>
                
                {% if clientes_puntos %}
                    {% for cliente in clientes_puntos|slice:":5" %}
                    <div class="ranking-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">{{ cliente.get_nombre_completo }}</h6>
                                <small class="text-muted">{{ cliente.identificacion }}</small>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold text-warning">{{ cliente.puntos_disponibles }} pts</div>
                                <small class="text-muted">Total: {{ cliente.puntos_acumulados }}</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-star fa-2x text-muted mb-2"></i>
                        <p class="text-muted small mb-0">No hay clientes con puntos</p>
                    </div>
                {% endif %}
            </div>

            <!-- Estad√≠sticas de Puntos -->
            <div class="chart-container">
                <h6 class="mb-3">
                    <i class="fas fa-chart-donut me-2"></i>
                    Distribuci√≥n de Puntos
                </h6>
                <canvas id="puntosChart" height="200"></canvas>
                
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="text-success fw-bold">{{ stats.puntos_disponibles|default:0 }}</div>
                            <small class="text-muted">Disponibles</small>
                        </div>
                        <div class="col-4">
                            <div class="text-warning fw-bold">{{ stats.puntos_canjeados|default:0 }}</div>
                            <small class="text-muted">Canjeados</small>
                        </div>
                        <div class="col-4">
                            <div class="text-info fw-bold">{{ stats.puntos_vencidos|default:0 }}</div>
                            <small class="text-muted">Vencidos</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Resumen Ejecutivo -->
            <div class="chart-container">
                <h6 class="mb-3">
                    <i class="fas fa-clipboard-check me-2"></i>
                    Resumen Ejecutivo
                </h6>
                
                <div class="mb-3">
                    <h6 class="text-primary">Crecimiento</h6>
                    <ul class="list-unstyled small">
                        <li>‚Ä¢ {{ stats.nuevos_este_mes|default:0 }} clientes nuevos este mes</li>
                        <li>‚Ä¢ Crecimiento del 12% en registros</li>
                        <li>‚Ä¢ 85% de retenci√≥n de clientes activos</li>
                    </ul>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-success">Sistema de Puntos</h6>
                    <ul class="list-unstyled small">
                        <li>‚Ä¢ {{ stats.clientes_con_puntos|default:0 }} clientes participando</li>
                        <li>‚Ä¢ Promedio: {{ stats.promedio_puntos|default:0|floatformat:0 }} pts por cliente</li>
                        <li>‚Ä¢ {{ stats.canjes_mes|default:0 }} canjes realizados este mes</li>
                    </ul>
                </div>
                
                <div>
                    <h6 class="text-warning">Recomendaciones</h6>
                    <ul class="list-unstyled small">
                        <li>‚Ä¢ Activar promoci√≥n para clientes sin puntos</li>
                        <li>‚Ä¢ Campa√±a de reactivaci√≥n para inactivos</li>
                        <li>‚Ä¢ Programa VIP para top clientes</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Variables globales
let registrosChart, tipoIdChart, puntosChart;

// Datos para los gr√°ficos (normalmente vendr√≠an del backend)
const datosRegistros = {
    labels: {% if registros_mes %}{{ registros_mes|safe }}{% else %}['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic']{% endif %},
    datasets: [{
        label: 'Nuevos Clientes',
        data: [12, 19, 15, 25, 22, 18, 30, 28, 35, 42, 38, 45],
        borderColor: '#007bff',
        backgroundColor: 'rgba(0, 123, 255, 0.1)',
        tension: 0.4,
        fill: true
    }]
};

const datosTipoId = {
    labels: ['C√©dula', 'RUC', 'Pasaporte'],
    datasets: [{
        data: [85, 12, 3],
        backgroundColor: ['#007bff', '#28a745', '#ffc107'],
        borderWidth: 0
    }]
};

const datosPuntos = {
    labels: ['Disponibles', 'Canjeados', 'Vencidos'],
    datasets: [{
        data: [65, 25, 10],
        backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
        borderWidth: 0
    }]
};

// Inicializaci√≥n
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
    initializeFilters();
    actualizarFecha();
});

// ========== GR√ÅFICOS ==========
function initializeCharts() {
    // Gr√°fico de registros por mes
    const ctxRegistros = document.getElementById('registrosChart').getContext('2d');
    registrosChart = new Chart(ctxRegistros, {
        type: 'line',
        data: datosRegistros,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // Gr√°fico de tipo de identificaci√≥n
    const ctxTipoId = document.getElementById('tipoIdChart').getContext('2d');
    tipoIdChart = new Chart(ctxTipoId, {
        type: 'doughnut',
        data: datosTipoId,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Gr√°fico de puntos
    const ctxPuntos = document.getElementById('puntosChart').getContext('2d');
    puntosChart = new Chart(ctxPuntos, {
        type: 'doughnut',
        data: datosPuntos,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// ========== FILTROS ==========
function initializeFilters() {
    // Filtros de per√≠odo
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Actualizar estado activo
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Actualizar datos seg√∫n per√≠odo
            const period = this.dataset.period;
            actualizarDatosPorPeriodo(period);
        });
    });
}

function actualizarDatosPorPeriodo(period) {
    // Aqu√≠ normalmente har√≠as una llamada AJAX al backend
    console.log('Actualizando datos para per√≠odo:', period);
    
    // Simular actualizaci√≥n de m√©tricas
    setTimeout(() => {
        animateCounters();
    }, 500);
}

// ========== ANIMACIONES ==========
function animateCounters() {
    // Animar contadores
    document.querySelectorAll('.metric-number').forEach(counter => {
        const target = parseInt(counter.textContent.replace(/[^\d]/g, ''));
        let current = 0;
        const increment = target / 30;
        
        const timer = setInterval(() => {
            current += increment;
            if (current >= target) {
                counter.textContent = target.toLocaleString();
                clearInterval(timer);
            } else {
                counter.textContent = Math.floor(current).toLocaleString();
            }
        }, 50);
    });
}

// ========== EXPORTACI√ìN ==========
function exportarExcel() {
    mostrarToast('Exportando a Excel...', 'info');
    
    // Simular exportaci√≥n
    setTimeout(() => {
        // Aqu√≠ har√≠as la llamada real al backend
        window.location.href = '/clientes/reportes/export/excel/';
        mostrarToast('Archivo Excel descargado correctamente', 'success');
    }, 1500);
}

function exportarPDF() {
    mostrarToast('Generando PDF...', 'info');
    
    setTimeout(() => {
        window.location.href = '/clientes/reportes/export/pdf/';
        mostrarToast('Archivo PDF descargado correctamente', 'success');
    }, 2000);
}

function exportarCSV() {
    mostrarToast('Exportando a CSV...', 'info');
    
    setTimeout(() => {
        window.location.href = '/clientes/reportes/export/csv/';
        mostrarToast('Archivo CSV descargado correctamente', 'success');
    }, 1000);
}

function enviarPorEmail() {
    const email = prompt('Ingrese el email de destino:');
    if (email && validateEmail(email)) {
        mostrarToast('Enviando reporte por email...', 'info');
        
        // Aqu√≠ har√≠as la llamada al backend
        setTimeout(() => {
            mostrarToast(`Reporte enviado a ${email}`, 'success');
        }, 2000);
    } else if (email) {
        mostrarToast('Email inv√°lido', 'error');
    }
}

// ========== UTILIDADES ==========
function actualizarFecha() {
    const now = new Date();
    const fecha = now.toLocaleDateString('es-EC', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    // Actualizar fecha en header si existe
    const fechaElement = document.querySelector('.report-date');
    if (fechaElement) {
        fechaElement.textContent = fecha;
    }
}

function validateEmail(email) {
    const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return regex.test(email);
}

function mostrarToast(mensaje, tipo = 'info') {
    // Crear toast notification
    const iconos = {
        'success': 'check-circle',
        'error': 'exclamation-circle',
        'warning': 'exclamation-triangle',
        'info': 'info-circle'
    };
    
    const colores = {
        'success': 'success',
        'error': 'danger',
        'warning': 'warning',
        'info': 'info'
    };
    
    const toastHtml = `
        <div class="toast align-items-center text-bg-${colores[tipo]} border-0 position-fixed top-0 end-0 m-3" 
             style="z-index: 9999;" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-${iconos[tipo]} me-2"></i>
                    ${mensaje}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', toastHtml);
    
    const toast = document.querySelector('.toast:last-child');
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Remover del DOM despu√©s de ocultarse
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

// Actualizar datos cada 5 minutos
setInterval(() => {
    const activePeriod = document.querySelector('.filter-btn.active').dataset.period;
    actualizarDatosPorPeriodo(activePeriod);
}, 300000);

// Animar contadores al cargar
setTimeout(animateCounters, 1000);
</script>
{% endblock %}